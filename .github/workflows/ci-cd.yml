name: CI/CD Pipeline

on:
  push:
    branches:
      - master
    tags:
      - 'v*'  # Trigger on version tags
  pull_request:
    branches:
      - master
  release:
    types: [published]

permissions:
  contents: read

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.13"

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      # Install uv directly instead of using a third-party action
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv --version

      - name: Install minimal Python dependencies
        run: |
          uv sync --locked --only-dev

      # Install bun directly instead of using a third-party action
      - name: Setup Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install JS dependencies
        run: bun install

      - name: Install and build Keycloak theme
        working-directory: keycloak
        run: |
          bun install
          bun run build

      - name: Run code quality checks
        run: |
          echo "Running all code quality checks via pre-commit..."
          uv run pre-commit run --all-files

          # Add results to GitHub step summary
          echo "## Code Quality Results" >> $GITHUB_STEP_SUMMARY
          echo "All pre-commit hooks passed successfully." >> $GITHUB_STEP_SUMMARY

      - name: Run Django template linting
        run: |
          echo "Running Django template linting with djlint..."

          # Run format check
          echo "Checking template formatting..."
          uv run djlint . --extension=j2 --check

          # Run linting
          echo "Running template linting..."
          uv run djlint . --extension=j2 --lint

          # Add results to GitHub step summary
          echo "## Django Template Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "Django template linting and format checking completed successfully." >> $GITHUB_STEP_SUMMARY

      - name: Validate Caddyfile
        run: |
          echo "Validating Caddyfile configuration..."

          # Validate Caddyfile syntax
          docker run --rm -v ${{ github.workspace }}/Caddyfile:/etc/caddy/Caddyfile caddy:latest caddy validate --config /etc/caddy/Caddyfile

          # Check Caddyfile formatting
          docker run --rm -v ${{ github.workspace }}/Caddyfile:/etc/caddy/Caddyfile caddy:latest caddy fmt /etc/caddy/Caddyfile > /tmp/formatted_caddyfile

          # Compare formatted output with original
          if ! diff -q ${{ github.workspace }}/Caddyfile /tmp/formatted_caddyfile > /dev/null 2>&1; then
            echo "Caddyfile is not properly formatted. Run 'caddy fmt --overwrite' to fix." >&2
            echo "Differences:" >&2
            diff ${{ github.workspace }}/Caddyfile /tmp/formatted_caddyfile >&2
            exit 1
          fi

          # Add results to GitHub step summary
          echo "## Caddyfile Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "Caddyfile syntax is valid and properly formatted." >> $GITHUB_STEP_SUMMARY

  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-group:
          - name: "Core Tests"
            path: "sbomify/apps/core/tests/"
            ignore: "sbomify/apps/core/tests/e2e"
          - name: "SBOM Tests"
            path: "sbomify/apps/sboms/tests/"
          - name: "Team Tests"
            path: "sbomify/apps/teams/tests/"
          - name: "Billing Tests"
            path: "sbomify/apps/billing/tests/"
          - name: "Document Tests"
            path: "sbomify/apps/documents/tests/"
          - name: "Licensing Tests"
            path: "sbomify/apps/licensing/tests/"
          - name: "Access Token Tests"
            path: "sbomify/apps/access_tokens/tests.py"
          - name: "Notification Tests"
            path: "sbomify/apps/notifications/tests.py"
          - name: "Onboarding Tests"
            path: "sbomify/apps/onboarding/tests/"
    env:
      DJANGO_SETTINGS_MODULE: sbomify.test_settings
      DEBUG: True
      STRIPE_SECRET_KEY: 'sk_test_dummy_key_for_ci'
      STRIPE_PUBLISHABLE_KEY: 'pk_test_dummy_key_for_ci'
      STRIPE_WEBHOOK_SECRET: 'whsec_dummy_key_for_ci'
      STRIPE_ENDPOINT_SECRET: 'whsec_dummy_key_for_ci'
      DJANGO_TEST: 'true'

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.13"

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv --version

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install JS dependencies
        run: bun install

      - name: Build JS assets
        run: bun run build

      - name: Start Docker Compose for tests
        run: |
          docker compose -f docker-compose.tests.yml up -d

      - name: Run ${{ matrix.test-group.name }}
        run: |
          echo "## ${{ matrix.test-group.name }} Results" >> $GITHUB_STEP_SUMMARY
          echo "Running tests in: ${{ matrix.test-group.path }}" >> $GITHUB_STEP_SUMMARY

          # Build ignore flag if specified
          IGNORE_FLAG=""
          if [ -n "${{ matrix.test-group.ignore }}" ]; then
            IGNORE_FLAG="--ignore=${{ matrix.test-group.ignore }}"
          fi

          # Get test count
          TEST_COUNT=$(docker compose -f docker-compose.tests.yml exec -T tests sh -c "uv run pytest --collect-only --quiet $IGNORE_FLAG ${{ matrix.test-group.path }}" | grep '::test_' | wc -l || echo "0")
          echo "Test count: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run sync tests
          docker compose -f docker-compose.tests.yml exec -T tests sh -c "uv run pytest --tb=short -v -m 'not anyio' $IGNORE_FLAG ${{ matrix.test-group.path }}" | tee test_results.txt
          PYTEST_EXIT_CODE_SYNC=${PIPESTATUS[0]}
          [[ $PYTEST_EXIT_CODE_SYNC -eq 5 ]] && PYTEST_EXIT_CODE_SYNC=0

          # Run async tests
          docker compose -f docker-compose.tests.yml exec -T tests sh -c "uv run pytest --tb=short -v -m 'anyio' $IGNORE_FLAG ${{ matrix.test-group.path }}" | tee -a test_results.txt
          PYTEST_EXIT_CODE_ASYNC=${PIPESTATUS[0]}
          [[ $PYTEST_EXIT_CODE_ASYNC -eq 5 ]] && PYTEST_EXIT_CODE_ASYNC=0

          PYTEST_EXIT_CODE=$((PYTEST_EXIT_CODE_SYNC || PYTEST_EXIT_CODE_ASYNC))

          # Add summary to GitHub
          echo "### Test Summary:" >> $GITHUB_STEP_SUMMARY
          grep -E "(failed|passed|errors|warnings)" test_results.txt | tail -1 >> $GITHUB_STEP_SUMMARY || echo "Test run completed" >> $GITHUB_STEP_SUMMARY

          # Show failed tests if any
          if grep -q "FAILED" test_results.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Tests:" >> $GITHUB_STEP_SUMMARY
            grep "FAILED" test_results.txt >> $GITHUB_STEP_SUMMARY || true
          fi

          # Exit with failure if tests failed (use pytest exit code)
          if [ $PYTEST_EXIT_CODE -ne 0 ]; then
            echo "Tests failed in ${{ matrix.test-group.name }}"
            exit 1
          fi

  e2e-tests:
    name: E2E Tests
    if: false  # Temporarily disabled - tests are failing
    runs-on: ubuntu-latest
    env:
      DJANGO_SETTINGS_MODULE: sbomify.test_settings
      DEBUG: True
      STRIPE_SECRET_KEY: 'sk_test_dummy_key_for_ci'
      STRIPE_PUBLISHABLE_KEY: 'pk_test_dummy_key_for_ci'
      STRIPE_WEBHOOK_SECRET: 'whsec_dummy_key_for_ci'
      STRIPE_ENDPOINT_SECRET: 'whsec_dummy_key_for_ci'
      DJANGO_TEST: 'true'

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.13"

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          uv --version

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install JS dependencies
        run: bun install

      - name: Build JS assets
        run: bun run build

      - name: Start Docker Compose for tests
        run: |
          docker compose -f docker-compose.tests.yml up -d

      - name: Run E2E Tests
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Running tests in: sbomify/apps/core/tests/e2e/" >> $GITHUB_STEP_SUMMARY

          # Get test count
          TEST_COUNT=$(docker compose -f docker-compose.tests.yml exec -T tests sh -c "uv run pytest --collect-only --quiet sbomify/apps/core/tests/e2e/" | grep '::test_' | wc -l || echo "0")
          echo "Test count: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run sync tests
          docker compose -f docker-compose.tests.yml exec -T tests sh -c "uv run pytest --tb=short -v -m 'not anyio' sbomify/apps/core/tests/e2e/" | tee test_results.txt
          PYTEST_EXIT_CODE_SYNC=${PIPESTATUS[0]}
          [[ $PYTEST_EXIT_CODE_SYNC -eq 5 ]] && PYTEST_EXIT_CODE_SYNC=0

          # Run async tests
          docker compose -f docker-compose.tests.yml exec -T tests sh -c "uv run pytest --tb=short -v -m 'anyio' sbomify/apps/core/tests/e2e/" | tee -a test_results.txt
          PYTEST_EXIT_CODE_ASYNC=${PIPESTATUS[0]}
          [[ $PYTEST_EXIT_CODE_ASYNC -eq 5 ]] && PYTEST_EXIT_CODE_ASYNC=0

          PYTEST_EXIT_CODE=$((PYTEST_EXIT_CODE_SYNC || PYTEST_EXIT_CODE_ASYNC))

          # Add summary to GitHub
          echo "### Test Summary:" >> $GITHUB_STEP_SUMMARY
          grep -E "(failed|passed|errors|warnings)" test_results.txt | tail -1 >> $GITHUB_STEP_SUMMARY || echo "Test run completed" >> $GITHUB_STEP_SUMMARY

          # Show failed tests if any
          if grep -q "FAILED" test_results.txt; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Tests:" >> $GITHUB_STEP_SUMMARY
            grep "FAILED" test_results.txt >> $GITHUB_STEP_SUMMARY || true
          fi

          # Exit with failure if tests failed (use pytest exit code)
          if [ $PYTEST_EXIT_CODE -ne 0 ]; then
            echo "E2E Tests failed"
            exit 1
          fi

      - name: Upload E2E Test Diffs
        if: failure()
        run: sudo chown -R $USER:$USER sbomify/apps/*/tests/e2e/__diffs__ 2>/dev/null || true

      - name: Upload E2E Test Diffs
        if: failure()
        uses: actions/upload-artifact@v7.0.0
        with:
          name: e2e-test-diffs-${{ matrix.test-group.name }}
          path: 'sbomify/apps/*/tests/e2e/__diffs__/*.jpg'
          if-no-files-found: ignore

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install JS dependencies
        run: bun install

      - name: Install and build Keycloak theme
        working-directory: keycloak
        run: |
          bun install
          bun run build

      - name: Run Frontend Tests
        run: |
          echo "## Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          bun test | tee -a $GITHUB_STEP_SUMMARY

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    outputs:
      github-image: ${{ steps.meta.outputs.github_image_id }}
      docker-hub-image: ${{ steps.meta.outputs.docker_hub_image_id }}
      image-digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}
    env:
      IMAGE_NAME: sbomify
    permissions:
      id-token: write
      contents: read
      packages: write
      attestations: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GitHub Container Registry
        if: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: sbomifyhub
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          GITHUB_IMAGE_ID=ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          GITHUB_IMAGE_ID=$(echo $GITHUB_IMAGE_ID | tr '[A-Z]' '[a-z]')
          DOCKER_HUB_IMAGE_ID=docker.io/sbomifyhub/${{ env.IMAGE_NAME }}

          # For pull requests, just set dummy tags (won't be pushed anyway)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAGS="$GITHUB_IMAGE_ID:pr-${{ github.event.number }}"
          # Determine tags based on trigger for pushes/releases
          elif [[ "${{ github.ref }}" == "refs/tags/v"* ]]; then
            # For git tags, use the version number (keep 'v' prefix)
            VERSION=$(echo "${{ github.ref }}" | sed -e 's,refs/tags/,,')
            TAGS="$GITHUB_IMAGE_ID:$VERSION,$DOCKER_HUB_IMAGE_ID:$VERSION"
          else
            # For master branch pushes, use latest
            TAGS="$GITHUB_IMAGE_ID:latest,$DOCKER_HUB_IMAGE_ID:latest"
          fi

          echo "github_image_id=$GITHUB_IMAGE_ID" >> $GITHUB_OUTPUT
          echo "docker_hub_image_id=$DOCKER_HUB_IMAGE_ID" >> $GITHUB_OUTPUT
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Extract build metadata for OCI labels
        id: build_meta
        run: |
          # Git commit SHA (full and short)
          GIT_COMMIT="${{ github.sha }}"
          GIT_COMMIT_SHORT=$(echo "$GIT_COMMIT" | cut -c1-7)

          # Build timestamp in RFC 3339 format
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Determine version and ref type
          if [[ "${{ github.ref }}" == "refs/tags/v"* ]]; then
            VERSION=$(echo "${{ github.ref }}" | sed -e 's,refs/tags/,,')
            GIT_REF="${VERSION}"
            BUILD_TYPE="release"
          elif [[ "${{ github.ref }}" == "refs/heads/"* ]]; then
            BRANCH=$(echo "${{ github.ref }}" | sed -e 's,refs/heads/,,')
            VERSION="${BRANCH}-${GIT_COMMIT_SHORT}"
            GIT_REF="${BRANCH}"
            BUILD_TYPE="branch"
          else
            VERSION="${GIT_COMMIT_SHORT}"
            GIT_REF="${{ github.ref }}"
            BUILD_TYPE="other"
          fi

          echo "git_commit=$GIT_COMMIT" >> $GITHUB_OUTPUT
          echo "git_commit_short=$GIT_COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "git_ref=$GIT_REF" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT

      - name: Build and push to registries
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        id: build
        with:
          context: .
          push: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ steps.build_meta.outputs.build_date }}
            GIT_COMMIT=${{ steps.build_meta.outputs.git_commit }}
            GIT_COMMIT_SHORT=${{ steps.build_meta.outputs.git_commit_short }}
            GIT_REF=${{ steps.build_meta.outputs.git_ref }}
            VERSION=${{ steps.build_meta.outputs.version }}
            BUILD_TYPE=${{ steps.build_meta.outputs.build_type }}
          labels: |
            org.opencontainers.image.created=${{ steps.build_meta.outputs.build_date }}
            org.opencontainers.image.revision=${{ steps.build_meta.outputs.git_commit }}
            org.opencontainers.image.version=${{ steps.build_meta.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.title=sbomify
            org.opencontainers.image.description=Your Security Artifact Hub - Generate, manage, and share SBOMs and compliance documents
            org.opencontainers.image.licenses=Apache-2.0 WITH Commons-Clause-1.0
            org.opencontainers.image.vendor=sbomify
            org.opencontainers.image.ref.name=${{ steps.build_meta.outputs.git_ref }}
            com.sbomify.build.type=${{ steps.build_meta.outputs.build_type }}

      - name: Attest GitHub Container Registry image
        if: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/attest-build-provenance@e4d4f7c39adfa4c260fb5c147f0622000aa14b99 # v4.0.0
        with:
          subject-name: ${{ steps.meta.outputs.github_image_id }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Attest Docker Hub image
        if: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/attest-build-provenance@e4d4f7c39adfa4c260fb5c147f0622000aa14b99 # v4.0.0
        with:
          subject-name: ${{ steps.meta.outputs.docker_hub_image_id }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Add build summary for non-pushes
        if: ${{ !(github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')) }}
        run: |
          echo "## Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Docker image built successfully but not pushed to registries." >> $GITHUB_STEP_SUMMARY
          echo "Images are only pushed on master branch or version tags." >> $GITHUB_STEP_SUMMARY

      - name: Add deployment summary
        if: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') }}
        run: |
          echo "## Docker Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Images:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All images have been attested with GitHub build provenance for supply chain security." >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # Generate Source SBOMs (Staging) - master branch only
  # =========================================================================
  generate-source-sboms-staging:
    name: Generate SBOMs (${{ matrix.component }}-${{ matrix.format }}-staging)
    needs: [docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    permissions:
      id-token: write
      contents: read
      attestations: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - component: backend
            format: cyclonedx
            component_id: 'FoKftlVn4uyq'
            component_name: 'Python Stack'
            lock_file: 'uv.lock'
            output_file: 'backend.cdx.json'
            product_release_id: 'xJ6NJlgTK37Y'
            has_product_release: true
          - component: backend
            format: spdx
            component_id: 'FoKftlVn4uyq'
            component_name: 'Python Stack'
            lock_file: 'uv.lock'
            output_file: 'backend.spdx.json'
            product_release_id: 'xJ6NJlgTK37Y'
            has_product_release: true
          - component: frontend
            format: cyclonedx
            component_id: 'Kpj3ZylyBDkb'
            component_name: 'Frontend Stack'
            lock_file: 'bun.lock'
            output_file: 'frontend.cdx.json'
            product_release_id: 'xJ6NJlgTK37Y'
            has_product_release: true
          - component: frontend
            format: spdx
            component_id: 'Kpj3ZylyBDkb'
            component_name: 'Frontend Stack'
            lock_file: 'bun.lock'
            output_file: 'frontend.spdx.json'
            product_release_id: 'xJ6NJlgTK37Y'
            has_product_release: true
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Determine version
        id: version
        uses: ./.github/actions/determine-version

      - name: Generate and Upload SBOM
        uses: sbomify/sbomify-action@master # scorecard-ignore:pinned-dependencies -- self-dogfooding
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: 'https://stage.sbomify.com'
          COMPONENT_ID: ${{ matrix.component_id }}
          COMPONENT_NAME: ${{ matrix.component_name }}
          COMPONENT_VERSION: ${{ steps.version.outputs.version }}
          LOCK_FILE: ${{ matrix.lock_file }}
          PRODUCT_RELEASE: ${{ matrix.has_product_release && format('["{0}:{1}"]', matrix.product_release_id, steps.version.outputs.version) || '' }}
          SBOM_FORMAT: ${{ matrix.format }}
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: ${{ matrix.output_file }}

      - name: Attest SBOM
        uses: actions/attest-build-provenance@e4d4f7c39adfa4c260fb5c147f0622000aa14b99 # v4.0.0
        with:
          subject-path: '${{ github.workspace }}/${{ matrix.output_file }}'

  # =========================================================================
  # Generate Container SBOMs (Staging) - master branch only
  # =========================================================================
  generate-container-sboms-staging:
    name: Generate SBOMs (container-${{ matrix.format }}-staging)
    needs: [docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    permissions:
      id-token: write
      contents: read
      attestations: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - format: cyclonedx
            component_id: 'odzUCI8r2any'
            component_name: 'Container'
            output_file: 'container.cdx.json'
            product_release_id: 'xJ6NJlgTK37Y'
            has_product_release: true
          - format: spdx
            component_id: 'odzUCI8r2any'
            component_name: 'Container'
            output_file: 'container.spdx.json'
            product_release_id: 'xJ6NJlgTK37Y'
            has_product_release: true
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate additional packages from Dockerfile
        run: ./bin/generate_additional_packages.sh > dockerfile_packages.txt

      - name: Determine version
        id: version
        uses: ./.github/actions/determine-version

      - name: Generate and Upload SBOM
        uses: sbomify/sbomify-action@master # scorecard-ignore:pinned-dependencies -- self-dogfooding
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: 'https://stage.sbomify.com'
          COMPONENT_ID: ${{ matrix.component_id }}
          COMPONENT_NAME: ${{ matrix.component_name }}
          COMPONENT_VERSION: ${{ steps.version.outputs.version }}
          DOCKER_IMAGE: ${{ needs.docker-build.outputs.docker-hub-image }}:${{ steps.version.outputs.docker_tag }}
          ADDITIONAL_PACKAGES_FILE: dockerfile_packages.txt
          PRODUCT_RELEASE: ${{ matrix.has_product_release && format('["{0}:{1}"]', matrix.product_release_id, steps.version.outputs.version) || '' }}
          SBOM_FORMAT: ${{ matrix.format }}
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: ${{ matrix.output_file }}

      - name: Attest SBOM
        uses: actions/attest-build-provenance@e4d4f7c39adfa4c260fb5c147f0622000aa14b99 # v4.0.0
        with:
          subject-path: '${{ github.workspace }}/${{ matrix.output_file }}'

  # =========================================================================
  # Generate Source SBOMs (Production) - tags only
  # =========================================================================
  generate-source-sboms-production:
    name: Generate SBOMs (${{ matrix.component }}-${{ matrix.format }}-production)
    needs: [docker-build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read
      attestations: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - component: backend
            format: cyclonedx
            component_id: '2hg-dk8ixV'
            component_name: 'Python Stack'
            lock_file: 'uv.lock'
            output_file: 'backend.cdx.json'
            product_release_id: 'eP_4dk8ixV'
            has_product_release: true
          - component: backend
            format: spdx
            component_id: '2hg-dk8ixV'
            component_name: 'Python Stack'
            lock_file: 'uv.lock'
            output_file: 'backend.spdx.json'
            product_release_id: 'eP_4dk8ixV'
            has_product_release: true
          - component: frontend
            format: cyclonedx
            component_id: 'vKhyt5bLHk4B'
            component_name: 'Frontend Stack'
            lock_file: 'bun.lock'
            output_file: 'frontend.cdx.json'
            product_release_id: 'eP_4dk8ixV'
            has_product_release: true
          - component: frontend
            format: spdx
            component_id: 'vKhyt5bLHk4B'
            component_name: 'Frontend Stack'
            lock_file: 'bun.lock'
            output_file: 'frontend.spdx.json'
            product_release_id: 'eP_4dk8ixV'
            has_product_release: true
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Determine version
        id: version
        uses: ./.github/actions/determine-version

      - name: Generate and Upload SBOM
        uses: sbomify/sbomify-action@master # scorecard-ignore:pinned-dependencies -- self-dogfooding
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: ${{ matrix.component_id }}
          COMPONENT_NAME: ${{ matrix.component_name }}
          COMPONENT_VERSION: ${{ steps.version.outputs.version }}
          LOCK_FILE: ${{ matrix.lock_file }}
          PRODUCT_RELEASE: ${{ matrix.has_product_release && format('["{0}:{1}"]', matrix.product_release_id, steps.version.outputs.version) || '' }}
          SBOM_FORMAT: ${{ matrix.format }}
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: ${{ matrix.output_file }}

      - name: Attest SBOM
        uses: actions/attest-build-provenance@e4d4f7c39adfa4c260fb5c147f0622000aa14b99 # v4.0.0
        with:
          subject-path: '${{ github.workspace }}/${{ matrix.output_file }}'

  # =========================================================================
  # Generate Container SBOMs (Production) - tags only
  # =========================================================================
  generate-container-sboms-production:
    name: Generate SBOMs (container-${{ matrix.format }}-production)
    needs: [docker-build]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write
      contents: read
      attestations: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - format: cyclonedx
            component_id: 'iVajxXMIqqyi'
            component_name: 'Container'
            output_file: 'container.cdx.json'
            product_release_id: 'eP_4dk8ixV'
            has_product_release: true
          - format: spdx
            component_id: 'iVajxXMIqqyi'
            component_name: 'Container'
            output_file: 'container.spdx.json'
            product_release_id: 'eP_4dk8ixV'
            has_product_release: true
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate additional packages from Dockerfile
        run: ./bin/generate_additional_packages.sh > dockerfile_packages.txt

      - name: Determine version
        id: version
        uses: ./.github/actions/determine-version

      - name: Generate and Upload SBOM
        uses: sbomify/sbomify-action@master # scorecard-ignore:pinned-dependencies -- self-dogfooding
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: ${{ matrix.component_id }}
          COMPONENT_NAME: ${{ matrix.component_name }}
          COMPONENT_VERSION: ${{ steps.version.outputs.version }}
          DOCKER_IMAGE: ${{ needs.docker-build.outputs.docker-hub-image }}:${{ steps.version.outputs.docker_tag }}
          ADDITIONAL_PACKAGES_FILE: dockerfile_packages.txt
          PRODUCT_RELEASE: ${{ matrix.has_product_release && format('["{0}:{1}"]', matrix.product_release_id, steps.version.outputs.version) || '' }}
          SBOM_FORMAT: ${{ matrix.format }}
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: ${{ matrix.output_file }}

      - name: Attest SBOM
        uses: actions/attest-build-provenance@e4d4f7c39adfa4c260fb5c147f0622000aa14b99 # v4.0.0
        with:
          subject-path: '${{ github.workspace }}/${{ matrix.output_file }}'
