# Caddyfile for sbomify
# This configuration handles reverse proxy, custom domains, and on-demand TLS

# Global options
{
	# Enable admin API for health checks
	admin 0.0.0.0:2019

	# On-demand TLS configuration
	on_demand_tls {
		# Ask the Django backend if a certificate should be issued
		ask http://sbomify-backend:8000/_tls/allow-host
		interval 2m
		burst 5
	}

	# Email for Let's Encrypt
	email {$ACME_EMAIL:admin@example.com}
}

# Main application domain
# Note: APP_BASE_URL should be just the domain (e.g., app.sbomify.com)
# not a full URL with protocol. Caddy handles the protocol automatically.
{$APP_BASE_URL:localhost} {
	# Enable on-demand TLS for custom domains
	tls {
		on_demand
	}

	# Logging
	log {
		output stdout
		format json
		level {$LOG_LEVEL:INFO}
	}

	# Block direct access to internal TLS verification endpoint from public
	@tls_internal {
		path /_tls/*
	}
	handle @tls_internal {
		respond "Not Found" 404
	}

	# Health check endpoint (bypasses Django)
	@health {
		path /health
	}
	handle @health {
		respond "OK" 200
	}

	# Reverse proxy to Django backend
	reverse_proxy sbomify-backend:8000 {
		# Health check configuration
		health_uri /health
		health_interval 30s
		health_timeout 5s

		# Request headers
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Real-IP {remote_host}
		header_up Host {host}

		# Remove server header for security
		header_down -Server
	}

	# Security headers
	header {
		# HSTS
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		
		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"
		
		# XSS Protection
		X-Frame-Options "SAMEORIGIN"
		
		# CSP (adjust as needed for your app)
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
		
		# Referrer Policy
		Referrer-Policy "strict-origin-when-cross-origin"
		
		# Remove X-Powered-By
		-X-Powered-By
	}

	# Compression
	encode gzip zstd

	# Rate limiting (adjust as needed)
	# rate_limit {
	#     zone static_limit {
	#         key {remote_host}
	#         events 100
	#         window 1m
	#     }
	# }
}

# Custom domains catch-all
# Any domain not matching the main APP_BASE_URL will be handled here
# These will use on-demand TLS and be verified via the /_tls/allow-host endpoint
# Customers configure their custom domains (e.g., trust.customer.com) to CNAME to APP_BASE_URL
:443 {
	tls {
		on_demand
	}

	log {
		output stdout
		format json
		level {$LOG_LEVEL:INFO}
	}

	# Block internal endpoints on custom domains
	@tls_internal {
		path /_tls/*
	}
	handle @tls_internal {
		respond "Not Found" 404
	}

	reverse_proxy sbomify-backend:8000 {
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Real-IP {remote_host}
		header_up Host {host}
		header_down -Server
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
		-X-Powered-By
	}

	encode gzip zstd
}

