# Caddyfile for sbomify
# Simple HTTP reverse proxy configuration
{
	admin {$CADDY_ADMIN:off}

	# Docker network IP ranges included below.
	# For Cloudflare, get latest IP ranges from https://www.cloudflare.com/ips/
	# and add below to the servers block if using CF
	servers {
		# Trusted proxies include:
		# - Private IP ranges (Docker bridge, local network)
		# - Cloudflare IPv4 ranges (https://www.cloudflare.com/ips/)
		trusted_proxies static 172.16.0.0/12 10.0.0.0/8 192.168.0.0/16 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
		trusted_proxies_strict
		client_ip_headers Cf-Connecting-Ip X-Forwarded-For
	}
}

# HTTP - All traffic
:80 {
	log {
		output stdout
		format json
		level {$LOG_LEVEL:INFO}
	}

	# Health check endpoint
	@health {
		path /health
	}
	handle @health {
		log_skip
		respond "OK" 200
	}

	# Django health check endpoint - suppress logging on success
	@django_health {
		path /UuPha8mu/*
	}
	handle @django_health {
		log_skip
		reverse_proxy sbomify-backend:8000 {
			header_up X-Real-IP {remote_host}
			header_up Host {host}
			header_down -Server
		}
	}

	# Reject untrusted traffic (optional - uncomment to enable)
	# @untrusted {
	# 	not remote_ip 172.16.0.0/12 10.0.0.0/8 192.168.0.0/16 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
	# }
	# abort @untrusted

	# Reverse proxy to Django backend
	reverse_proxy sbomify-backend:8000 {
		# X-Forwarded-For and X-Forwarded-Proto are passed by default
		header_up X-Real-IP {remote_host}
		header_up Host {host}
		header_down -Server

		# Active health checks using Django's health endpoint
		# This endpoint checks database connectivity and other dependencies
		health_uri /UuPha8mu/
		health_interval 30s
		health_timeout 5s
		health_status 200

		# Retry logic for resilience
		lb_try_duration 5s
		lb_try_interval 250ms
		fail_duration 10s
		max_fails 3
	}

	# Compression
	encode gzip zstd
}
