{% extends "core/dashboard_base.html.j2" %}
{% comment %}
Template context:
component - Component object
documents_data - List of document data (for document components)
sboms_data - List of SBOM data (for SBOM components)
has_crud_permissions - Can modify public/private status?
APP_BASE_URL - Base URL for the application
{% endcomment %}
{% load widget_tweaks %}
{% load static %}
{% load django_vite %}
{% block title %}sbomify Component: {{ component.name }}{% endblock %}
{% block content %}
    {% csrf_token %}
    <div class="detail-page-header mb-4">
        <!-- Breadcrumb Navigation -->
        <div class="detail-breadcrumb-nav mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb detail-breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'core:components_dashboard' %}">Components</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">{{ component.name }}</li>
                </ol>
            </nav>
        </div>
        <!-- Main Header Content -->
        <div class="detail-header-main">
            <div class="detail-header-left">
                <div class="detail-title-group">
                    <h1 class="detail-item-title">
                        {% if has_crud_permissions %}
                            {% include "core/components/editable_field.html.j2" with item_type="component" item_id=component.id field_name="name" current_value=component.name css_class="component-name-field" %}
                        {% else %}
                            <i class="fas fa-{% if component.component_type == 'sbom' %}file-code{% elif component.component_type == 'document' %}file-alt{% else %}cube{% endif %} me-2"></i>
                            {{ component.name }}
                        {% endif %}
                    </h1>
                    <div class="detail-meta-row">
                        <span class="detail-meta-badge">
                            <i class="fas fa-{% if component.component_type == 'sbom' %}file-code{% elif component.component_type == 'document' %}file-alt{% else %}cube{% endif %} me-2"></i>
                            {{ component.get_component_type_display }}
                        </span>
                        <span class="detail-meta-id-container">
                            {% include "core/components/copyable_value.html.j2" with value=component.id display_text=component.id title="Component ID: "|add:component.id|add:" (click to copy)" css_class="detail-meta-id-chip" %}
                        </span>
                    </div>
                </div>
            </div>
            {% if has_crud_permissions %}
                <div class="detail-header-right">
                    {% include "core/components/public_status_toggle.html.j2" with item_type="component" item_id=component.id is_public=component.is_public public_url="/public/component/"|add:component.id|add:"/" inline=True %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Component Statistics -->
    {% if component.component_type == 'sbom' %}
        {% if component_stats_error %}
            <div class="alert alert-warning" role="alert">
                <h6 class="alert-heading">Stats unavailable</h6>
                <p class="mb-0">{{ component_stats_error }}</p>
            </div>
        {% elif component_stats %}
            {% include "core/components/standard_card.html.j2" with title="SBOM Statistics" variant="stats" size="medium" content=stats_content %}
            {% block stats_content %}
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="stat-value display-4 fw-bold text-primary">{{ component_stats.total_components|floatformat:0 }}</div>
                            <div class="stat-label text-muted small">Total SBOMs</div>
                        </div>
                    </div>
                </div>
            {% endblock %}
        {% endif %}
    {% elif component.component_type == 'document' %}
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card border-light shadow-brand">
                    <div class="card-header px-4 py-3 bg-light">
                        <h4 class="card-title mb-0 text-muted small text-uppercase fw-semibold">
                            <i class="fas fa-file-alt me-2"></i>Total Documents
                        </h4>
                    </div>
                    <div class="card-body text-center p-4">
                        <div class="stat-display py-3">
                            <div class="stat-value mb-2">
                                <span class="display-4 fw-bold text-dark">{{ documents|length|default:0 }}</span>
                            </div>
                            <div class="stat-label text-muted small">
                                {% if documents|length == 1 %}Document uploaded{% else %}Documents uploaded{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if documents %}
                <div class="col-md-4 mb-4">
                    <div class="card border-light shadow-brand">
                        <div class="card-header px-4 py-3 bg-light">
                            <h4 class="card-title mb-0 text-muted small text-uppercase fw-semibold">
                                <i class="fas fa-tags me-2"></i>Document Types
                            </h4>
                        </div>
                        <div class="card-body text-center p-4">
                            <div class="stat-display py-3">
                                {% regroup documents by document_type as types_list %}
                                <div class="stat-value mb-2">
                                    <span class="display-4 fw-bold text-dark">{{ types_list|length }}</span>
                                </div>
                                <div class="stat-label text-muted small">
                                    {% if types_list|length == 1 %}Type in use{% else %}Types in use{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card border-light shadow-brand">
                        <div class="card-header px-4 py-3 bg-light">
                            <h4 class="card-title mb-0 text-muted small text-uppercase fw-semibold">
                                <i class="fas fa-calendar me-2"></i>Latest Upload
                            </h4>
                        </div>
                        <div class="card-body text-center p-4">
                            <div class="stat-display py-3">
                                {% with latest_doc=documents.0 %}
                                    <div class="stat-value mb-2">
                                        <span class="h5 fw-bold text-dark">{{ latest_doc.created_at|date:"M d" }}</span>
                                    </div>
                                    <div class="stat-label text-muted small">
                                        {{ latest_doc.created_at|date:"Y" }}
                                    </div>
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <!-- Component Type Specific Content -->
    {% if component.component_type == 'sbom' %}
        <!-- SBOM Upload Section -->
        {% if has_crud_permissions %}
            {% include "core/components/sbom_upload_card.html.j2" with component=component has_crud_permissions=has_crud_permissions %}
        {% endif %}

        <!-- SBOMs Table -->
        {% include "core/components/items_table.html.j2" with items_data=sboms_data component_type="sbom" table_title="SBOMs" is_public_view=False show_vulnerabilities=True show_delete_button=has_crud_permissions team_billing_plan=team_billing_plan has_crud_permissions=has_crud_permissions %}

        <!-- Vulnerability Trends -->
        {% include "core/components/vulnerability_trends_card.html.j2" with component=component %}

    {% elif component.component_type == 'document' %}
        <!-- Document Upload Section -->
        {% if has_crud_permissions %}
            {% include "core/components/document_upload_card.html.j2" with component=component has_crud_permissions=has_crud_permissions %}
        {% endif %}

        <!-- Documents Table -->
        {% include "core/components/items_table.html.j2" with items_data=documents_data component_type="document" table_title="Documents" is_public_view=False show_vulnerabilities=False show_delete_button=has_crud_permissions team_billing_plan=team_billing_plan has_crud_permissions=has_crud_permissions %}
    {% endif %}

    <!-- CI/CD Integration -->
    {% if has_crud_permissions %}
        {% include "core/components/standard_card.html.j2" with title="CI/CD Integration" variant="default" size="medium" info_notice="Set up automated uploads from your CI/CD pipeline" content=cicd_content %}
        {% block cicd_content %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                CI/CD integration features will be available here soon.
            </div>
        {% endblock %}
    {% endif %}

    <!-- Danger Zone -->
    {% if has_crud_permissions and is_owner %}
        {% include "core/components/standard_card.html.j2" with title="Danger Zone" variant="dangerzone" size="medium" info_notice="Permanent actions that cannot be undone" content=danger_content %}
        {% block danger_content %}
            <div class="alert alert-warning">
                <i class="fas fa-warning me-2"></i>
                Component deletion and transfer features will be available here.
            </div>
        {% endblock %}
    {% endif %}

{% endblock %}
{% block scripts %}
    {% vite_asset 'core/js/main.ts' %}
    {% if component.component_type == 'sbom' %}
        {% vite_asset 'vulnerability_scanning/js/main.ts' %}
        {% vite_asset 'sboms/js/main.ts' %}
    {% elif component.component_type == 'document' %}
        {% vite_asset 'documents/js/main.ts' %}
    {% endif %}
{% endblock %}
