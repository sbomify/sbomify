{% extends "core/dashboard_base.htmx.j2" %}
{% load static %}
{% load humanize %}
{% block title %}sbomify Select Plan{% endblock %}
{% block content %}
    <div class="space-y-8 animate-[fadeInUp_0.4s_ease-out]">
        {# Plan Selection Content #}
        <div class="max-w-6xl mx-auto" x-cloak x-data="planSelection({ currentPlan: '{{ team.billing_plan|default:'community' }}', teamKey: '{{ team_key }}', usage: { users: {{ team.members.count }}, products: {{ product_count }}, projects: {{ project_count }}, components: {{ component_count }} }, csrfToken: '{{ csrf_token }}', enterpriseContactUrl: '{% url 'billing:enterprise_contact' %}', currentSubscriptionStatus: '{{ team.billing_plan_limits.subscription_status|default:'' }}', portalUrl:
            {% if team.billing_plan_limits.stripe_customer_id %}
                '{% url 'billing:create_portal_session' team.key %}'
            {% else %}
                null
            {% endif %}
            , cancelAtPeriodEnd: {{ team.billing_plan_limits.cancel_at_period_end|yesno:'true,false' }}, currentPeriodEnd: '{{ team.billing_plan_limits.next_billing_date|default:'' }}', downgradeLimits: {
            {% for plan in plans %}
                '{{ plan.key }}': { exceeds: {{ plan.exceeds_downgrade_limits|yesno:'true,false' }}, resources: [
                {% for resource in plan.downgrade_exceeded_resources %}
                    '{{ resource|escapejs }}'
                    {% if not forloop.last %},{% endif %}
                {% endfor %}
                ] }
                {% if not forloop.last %},{% endif %}
            {% endfor %}
            }, billingPeriod: '{{ team.billing_plan_limits.billing_period|default:'monthly' }}' })">
            {# Hero Section #}
            <section class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-bold text-text mb-4">Choose the Perfect Plan for Your Workspace</h2>
                <p class="text-lg text-text-muted max-w-2xl mx-auto mb-8">
                    Secure, scalable security and product artifact management for workspaces of all sizes. Start with Community, upgrade when you need more.
                </p>
                {# Billing Toggle #}
                <div class="flex items-center justify-center gap-4">
                    <span class="text-sm font-medium transition-colors"
                          :class="billingPeriod === 'monthly' ? 'text-text' : 'text-text-muted'">Monthly</span>
                    <button @click="billingPeriod = billingPeriod === 'monthly' ? 'annual' : 'monthly'"
                            class="relative w-14 h-7 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 border border-border"
                            :class="billingPeriod === 'annual' ? 'bg-primary border-primary' : 'bg-text-muted/20'"
                            role="switch"
                            :aria-checked="billingPeriod === 'annual'">
                        <span class="absolute top-1 left-1 w-5 h-5 rounded-full bg-white shadow-md border border-border/50 transition-transform"
                              :class="billingPeriod === 'annual' ? 'translate-x-7' : 'translate-x-0'"></span>
                    </button>
                    <span class="text-sm font-medium transition-colors flex items-center gap-2"
                          :class="billingPeriod === 'annual' ? 'text-text' : 'text-text-muted'">
                        Annual
                        {% for plan in plans %}
                            {% if plan.key == 'business' and plan.stripe_pricing.annual_savings_percent %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-success/10 text-success">
                                    Save {{ plan.stripe_pricing.annual_savings_percent|floatformat:0 }}%
                                </span>
                            {% endif %}
                        {% endfor %}
                    </span>
                </div>
            </section>
            {# Current Usage Section #}
            <section class="mb-8"
                     x-show="usage.users > 0 || usage.products > 0 || usage.projects > 0 || usage.components > 0">
                <div class="tw-settings-card max-w-3xl mx-auto">
                    <div class="px-6 py-4 border-b border-border">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                                <i class="fas fa-chart-bar text-primary"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-text m-0">Current Usage</h3>
                                <p class="text-text-muted text-sm m-0">Your workspace resource usage</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-background border border-border rounded-xl p-4 text-center">
                                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center mx-auto mb-2">
                                    <i class="fas fa-users text-primary"></i>
                                </div>
                                <span class="text-2xl font-bold text-text block" x-text="usage.users || 0"></span>
                                <span class="text-text-muted text-xs">Users</span>
                            </div>
                            <div class="bg-background border border-border rounded-xl p-4 text-center">
                                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center mx-auto mb-2">
                                    <i class="fas fa-cube text-primary"></i>
                                </div>
                                <span class="text-2xl font-bold text-text block" x-text="usage.products"></span>
                                <span class="text-text-muted text-xs">Products</span>
                            </div>
                            <div class="bg-background border border-border rounded-xl p-4 text-center">
                                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center mx-auto mb-2">
                                    <i class="fas fa-folder text-primary"></i>
                                </div>
                                <span class="text-2xl font-bold text-text block" x-text="usage.projects"></span>
                                <span class="text-text-muted text-xs">Projects</span>
                            </div>
                            <div class="bg-background border border-border rounded-xl p-4 text-center">
                                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center mx-auto mb-2">
                                    <i class="fas fa-puzzle-piece text-primary"></i>
                                </div>
                                <span class="text-2xl font-bold text-text block" x-text="usage.components"></span>
                                <span class="text-text-muted text-xs">Components</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            {# Pricing Cards Section #}
            <section class="mb-12">
                <div class="grid md:grid-cols-3 gap-6">
                    {% for plan in plans %}
                        <div class="relative rounded-xl border transition-all duration-200"
                             :class="{ 'border-primary ring-2 ring-primary/20': currentPlan === '{{ plan.key }}', 'border-primary ring-2 ring-primary': '{{ plan.key }}' === 'business' && currentPlan !== '{{ plan.key }}', 'border-border hover:border-primary/50': currentPlan !== '{{ plan.key }}' && '{{ plan.key }}' !== 'business' }">
                            {# Popular Badge #}
                            {% if plan.key == 'business' %}
                                <div class="absolute -top-3 left-1/2 -translate-x-1/2 px-3 py-1 bg-primary text-white text-xs font-semibold rounded-full flex items-center gap-1">
                                    <i class="fas fa-star"></i>
                                    Most Popular
                                </div>
                            {% endif %}
                            <div class="p-6 bg-surface rounded-xl">
                                {# Plan Header #}
                                <div class="text-center mb-6">
                                    <h3 class="text-xl font-bold text-text mb-2">{{ plan.name }}</h3>
                                    {# Subscription Status Alerts #}
                                    <div x-show="currentPlan === '{{ plan.key }}' && cancelAtPeriodEnd"
                                         x-cloak
                                         class="mb-3 px-3 py-2 bg-warning/10 border border-warning/20 rounded-lg text-sm text-warning">
                                        <i class="fas fa-clock mr-1"></i> Plan ends on <span x-text="formatDate(currentPeriodEnd)"></span>
                                    </div>
                                    <div x-show="currentPlan === '{{ plan.key }}' && !cancelAtPeriodEnd && currentPeriodEnd && '{{ plan.key }}' !== 'community'"
                                         x-cloak
                                         class="mb-3 px-3 py-2 bg-info/10 border border-info/20 rounded-lg text-sm text-info">
                                        <i class="fas fa-calendar-alt mr-1"></i> Renews on <span x-text="formatDate(currentPeriodEnd)"></span>
                                    </div>
                                    {# Price #}
                                    <div class="mb-3">
                                        {% if plan.key == 'community' %}
                                            <span class="text-4xl font-bold text-text">$0</span>
                                            <span class="text-text-muted">/forever</span>
                                        {% elif plan.key == 'business' %}
                                            {% with pricing=plan.stripe_pricing %}
                                                {% if pricing.monthly_price or pricing.annual_price %}
                                                    {# Monthly Pricing #}
                                                    <div x-show="billingPeriod === 'monthly'">
                                                        {% if pricing.monthly_price_discounted %}
                                                            {% if pricing.discount_percent_monthly and pricing.monthly_price != pricing.monthly_price_discounted %}
                                                                <span class="text-lg text-text-muted line-through">${{ pricing.monthly_price|floatformat:0|intcomma }}</span>
                                                            {% endif %}
                                                            <span class="text-4xl font-bold text-text">${{ pricing.monthly_price_discounted|floatformat:0|intcomma }}</span>
                                                            <span class="text-text-muted">/month</span>
                                                        {% else %}
                                                            <span class="text-2xl font-bold text-text">Contact us</span>
                                                        {% endif %}
                                                    </div>
                                                    {# Annual Pricing #}
                                                    <div x-show="billingPeriod === 'annual'">
                                                        {% if pricing.annual_price %}
                                                            {% if pricing.monthly_price_base_annualized and pricing.monthly_price_base_annualized > pricing.annual_price_discounted %}
                                                                <span class="text-lg text-text-muted line-through">${{ pricing.monthly_price_base_annualized|floatformat:0|intcomma }}/yr</span>
                                                            {% endif %}
                                                            <span class="text-4xl font-bold text-text">${{ pricing.annual_price_discounted|floatformat:0|intcomma }}</span>
                                                            <span class="text-text-muted">/year</span>
                                                            {% widthratio pricing.annual_price_discounted 12 1 as monthly_equiv %}
                                                            <div class="text-sm text-text-muted mt-1">${{ monthly_equiv|floatformat:0|intcomma }}/mo billed annually</div>
                                                        {% else %}
                                                            <span class="text-2xl font-bold text-text">Contact us</span>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-2xl font-bold text-text">Contact us</span>
                                                    <span class="text-text-muted">for pricing</span>
                                                {% endif %}
                                                {# Promo Cards #}
                                                {% if pricing.promo_message and pricing.discount_percent_monthly %}
                                                    <div x-show="billingPeriod === 'monthly'"
                                                         class="mt-3 inline-flex items-center gap-2 px-3 py-2 bg-success/10 border border-success/20 rounded-lg">
                                                        <i class="fas fa-gift text-success"></i>
                                                        <span class="text-sm text-success font-medium">{{ pricing.promo_message }} - {{ pricing.discount_percent_monthly|floatformat:0 }}% OFF</span>
                                                    </div>
                                                {% endif %}
                                                {% if pricing.promo_message and pricing.discount_percent_annual %}
                                                    <div x-show="billingPeriod === 'annual'"
                                                         class="mt-3 inline-flex items-center gap-2 px-3 py-2 bg-success/10 border border-success/20 rounded-lg">
                                                        <i class="fas fa-gift text-success"></i>
                                                        <span class="text-sm text-success font-medium">{{ pricing.promo_message }} - {{ pricing.discount_percent_annual|floatformat:0 }}% OFF</span>
                                                    </div>
                                                {% endif %}
                                                {% if pricing.total_annual_savings %}
                                                    <div x-show="billingPeriod === 'annual'"
                                                         class="mt-2 text-sm text-success flex items-center justify-center gap-1">
                                                        <i class="fas fa-calendar-check"></i>
                                                        Save ${{ pricing.total_annual_savings|floatformat:0|intcomma }} when billed annually
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-4xl font-bold text-text">Custom</span>
                                            <span class="text-text-muted">pricing</span>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-text-muted">{{ plan.description }}</p>
                                </div>
                                {# Plan Limits #}
                                {% if plan.max_products is not None or plan.max_projects is not None or plan.max_components is not None or plan.max_users is not None or plan.key == 'enterprise' %}
                                    <div class="mb-6 p-4 bg-background rounded-lg">
                                        <h6 class="text-xs font-semibold text-text-muted uppercase tracking-wider mb-3">Plan Limits</h6>
                                        <div class="grid grid-cols-2 gap-3">
                                            {% if plan.max_users is not None %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-users text-primary text-sm"></i>
                                                    <span class="text-sm text-text">{{ plan.max_users }} Users</span>
                                                </div>
                                            {% elif plan.key == 'enterprise' %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-users text-primary text-sm"></i>
                                                    <span class="text-sm text-text">Unlimited Users</span>
                                                </div>
                                            {% endif %}
                                            {% if plan.max_products is not None %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-cube text-primary text-sm"></i>
                                                    <span class="text-sm text-text">{{ plan.max_products }} Products</span>
                                                </div>
                                            {% elif plan.key == 'enterprise' %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-cube text-primary text-sm"></i>
                                                    <span class="text-sm text-text">Unlimited Products</span>
                                                </div>
                                            {% endif %}
                                            {% if plan.max_projects is not None %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-folder text-primary text-sm"></i>
                                                    <span class="text-sm text-text">{{ plan.max_projects }} Projects</span>
                                                </div>
                                            {% elif plan.key == 'enterprise' %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-folder text-primary text-sm"></i>
                                                    <span class="text-sm text-text">Unlimited Projects</span>
                                                </div>
                                            {% endif %}
                                            {% if plan.max_components is not None %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-puzzle-piece text-primary text-sm"></i>
                                                    <span class="text-sm text-text">{{ plan.max_components }} Components</span>
                                                </div>
                                            {% elif plan.key == 'enterprise' %}
                                                <div class="flex items-center gap-2">
                                                    <i class="fas fa-puzzle-piece text-primary text-sm"></i>
                                                    <span class="text-sm text-text">Unlimited Components</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                                {# Features List #}
                                <div class="mb-6">
                                    <h6 class="text-xs font-semibold text-text-muted uppercase tracking-wider mb-3">Features</h6>
                                    <ul class="space-y-2">
                                        {% if plan.key == 'community' %}
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Unlimited SBOMs</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>All data is public</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Weekly vulnerability scans</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Community support</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>API access</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Public Trust Center</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Custom branding</span>
                                            </li>
                                        {% elif plan.key == 'business' %}
                                            <li class="text-xs font-semibold text-primary uppercase tracking-wider mb-2">Everything in Community, plus:</li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Private components/projects/products</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>NTIA Minimum Elements check</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Advanced vulnerability scanning (every 12 hours)</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Product identifiers (SKUs/barcodes)</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Priority support</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Custom domain for Trust Center</span>
                                            </li>
                                        {% elif plan.key == 'enterprise' %}
                                            <li class="text-xs font-semibold text-primary uppercase tracking-wider mb-2">Everything in Business, plus:</li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Custom Dependency Track servers</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Dedicated support</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Custom integrations</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>SLA guarantee</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Advanced security</span>
                                            </li>
                                            <li class="flex items-start gap-2 text-sm text-text">
                                                <i class="fas fa-check text-success mt-0.5"></i>
                                                <span>Custom deployment options</span>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                {# Action Button #}
                                <div>
                                    <button class="w-full py-3 px-4 rounded-lg font-semibold transition-all duration-200"
                                            :class="{ 'bg-primary/10 text-primary cursor-default': currentPlan === '{{ plan.key }}', 'bg-primary text-white hover:bg-primary-dark': currentPlan !== '{{ plan.key }}' && '{{ plan.key }}' !== 'enterprise' && canSelectPlan('{{ plan.key }}'), 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700': '{{ plan.key }}' === 'enterprise', 'bg-border text-text-muted cursor-not-allowed': !canSelectPlan('{{ plan.key }}') && currentPlan !== '{{ plan.key }}' }"
                                            :disabled="!canSelectPlan('{{ plan.key }}')"
                                            @click="handlePlanSelection('{{ plan.key }}')"
                                            x-cloak>
                                        <span x-text="getButtonText('{{ plan.key }}')">
                                            {% if plan.key == 'enterprise' %}
                                                Contact Sales
                                            {% elif plan.key == 'community' %}
                                                Get Started
                                            {% else %}
                                                Select Plan
                                            {% endif %}
                                        </span>
                                    </button>
                                    {# Warning Message for Exceeded Limits #}
                                    <div x-show="getDowngradeWarning('{{ plan.key }}')"
                                         x-cloak
                                         class="mt-3 px-3 py-2 bg-warning/10 border border-warning/20 rounded-lg text-sm text-warning">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        <span x-text="getDowngradeWarning('{{ plan.key }}')"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </section>
            {# FAQ Section #}
            <section class="max-w-3xl mx-auto pb-12">
                <div class="tw-settings-card">
                    <div class="px-6 py-4 border-b border-border">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                                <i class="fas fa-question-circle text-primary"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-text m-0">Frequently Asked Questions</h3>
                                <p class="text-text-muted text-sm m-0">Common questions about our plans</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <template x-for="faq in faqs" :key="faq.id">
                                <div class="bg-background border border-border rounded-xl overflow-hidden">
                                    <button @click="toggleFAQ(faq.id)"
                                            class="w-full px-5 py-4 flex items-center justify-between text-left hover:bg-border/20 transition-colors">
                                        <span class="font-medium text-text" x-text="faq.question"></span>
                                        <i class="fas fa-chevron-down text-text-muted transition-transform duration-200 flex-shrink-0 ml-4"
                                           :class="faq.expanded ? 'rotate-180' : ''"></i>
                                    </button>
                                    <div x-show="faq.expanded"
                                         x-collapse
                                         class="px-5 pb-4 border-t border-border">
                                        <p class="text-text-muted text-sm mt-4 m-0" x-text="faq.answer"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{ block.super }}
    {% load django_vite %}
    {% vite_asset 'sbomify/apps/billing/js/main.ts' %}
{% endblock %}
