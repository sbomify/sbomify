import Alpine from 'alpinejs';

interface VulnerabilitySettingsData {
    localProvider: string;
    localCustomServerId: string;
    initialProvider: string;
    initialCustomServer: string;
    canUseCustomDt: boolean;
    availableDtServers: Array<{ id: string; is_active: boolean }>;
    availableProviders: Array<{ value: string; label: string }>;
    hasUnsavedChanges: () => boolean;
    selectProvider: (value: string) => void;
    selectCustomServer: (id: string) => void;
    getCurrentProviderLabel: () => string;
    getProviderBadgeClass: () => string;
    getProviderIcon: (providerValue: string) => string;
    getProviderDisplayName: (providerValue: string) => string;
    getServerIcon: (server: { id: string; is_active: boolean }) => string;
    showCustomServerSelection: () => boolean;
}

interface VulnerabilitySettingsParams {
    provider: string;
    customServerId: string;
    canUseCustomDt: boolean;
    availableDtServers: Array<{ id: string; is_active: boolean }>;
    availableProviders: Array<{ value: string; label: string }>;
}

/**
 * Vulnerability Settings Component
 * Handles vulnerability scanning provider selection and custom server selection
 */
export function registerVulnerabilitySettings(): void {
    Alpine.data('vulnerabilitySettings', ({
        provider,
        customServerId,
        canUseCustomDt,
        availableDtServers,
        availableProviders
    }: VulnerabilitySettingsParams): VulnerabilitySettingsData => {
        return {
            localProvider: provider,
            localCustomServerId: customServerId,
            initialProvider: provider,
            initialCustomServer: customServerId,
            canUseCustomDt,
            availableDtServers,
            availableProviders,

            hasUnsavedChanges(): boolean {
                return this.localProvider !== this.initialProvider || 
                       this.localCustomServerId !== this.initialCustomServer;
            },

            selectProvider(value: string): void {
                this.localProvider = value;
                if (value !== 'dependency_track') {
                    this.localCustomServerId = '';
                }
            },

            selectCustomServer(id: string): void {
                this.localCustomServerId = id;
            },

            getCurrentProviderLabel(): string {
                const provider = availableProviders.find(p => p.value === this.localProvider);
                return provider ? provider.label : 'Unknown';
            },

            getProviderBadgeClass(): string {
                switch(this.localProvider) {
                    case 'osv': return 'bg-primary-subtle text-primary';
                    case 'dependency_track': return 'bg-success-subtle text-success';
                    default: return 'bg-secondary-subtle text-secondary';
                }
            },

            getProviderIcon(providerValue: string): string {
                switch(providerValue) {
                    case 'osv': return 'fab fa-google';
                    case 'dependency_track': return 'fas fa-shield-alt';
                    default: return 'fas fa-question-circle';
                }
            },

            getProviderDisplayName(providerValue: string): string {
                switch(providerValue) {
                    case 'osv': return 'OSV';
                    case 'dependency_track': return 'Dependency Track';
                    default: return providerValue;
                }
            },

            getServerIcon(server: { id: string; is_active: boolean }): string {
                if (!server.is_active) return 'fas fa-exclamation-triangle text-warning';
                return this.localCustomServerId === server.id ? 'fas fa-check-circle' : 'far fa-circle';
            },

            showCustomServerSelection(): boolean {
                return this.localProvider === 'dependency_track' &&
                       this.canUseCustomDt &&
                       this.availableDtServers &&
                       this.availableDtServers.length > 0;
            }
        };
    });
}
