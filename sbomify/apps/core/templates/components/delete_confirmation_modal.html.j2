<template x-teleport="body">
    <div x-show="{{ modal_id }}"
         class="delete-modal-overlay"
         tabindex="-1"
         role="dialog"
         aria-modal="true"
         aria-labelledby="delete-modal-title-{{ modal_id }}"
         @click="{{ modal_id }} = false"
         @keydown.escape.window="{{ modal_id }} = false"
         x-transition:enter="transition ease-out duration-150"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         style="display: none">
        <div class="delete-modal" @click.stop>
            <div class="delete-modal-header">
                <div class="delete-modal-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 id="delete-modal-title-{{ modal_id }}" class="delete-modal-title">{{ title|default:'Confirm Delete' }}</h3>
                <button type="button"
                        class="delete-modal-close"
                        @click="{{ modal_id }} = false">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="delete-modal-body">
                <p class="delete-modal-message">
                    {{ message|default:'Are you sure you want to delete' }}
                    {% if item_name %}<span class="delete-modal-name">{{ item_name }}</span>?{% endif %}
                </p>
                <p class="delete-modal-warning">
                    {{ warning_message|default:'This action cannot be undone and will permanently remove the item from the system.' }}
                </p>
            </div>
            <div class="delete-modal-footer">
                <button type="button"
                        class="delete-modal-button delete-modal-button--secondary"
                        @click="{{ modal_id }} = false">{{ cancel_text|default:'Cancel' }}</button>
                <script>
                if (!window.getDeleteModalData) {
                    window.getDeleteModalData = function(config) {
                        return {
                            isLoading: false,
                            async handleDelete() {
                                if (this.isLoading) return;
                                this.isLoading = true;

                                const csrfToken = config.csrfToken || (document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] || '');

                                try {
                                    const response = await fetch(config.hxUrl, {
                                        method: config.hxMethod || 'DELETE',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': csrfToken
                                        },
                                        credentials: 'same-origin'
                                    });

                                    this[config.modalId] = false;

                                    if (response.ok) {
                                        if (window.showSuccess) {
                                            window.showSuccess(config.successMessage);
                                        } else {
                                            alert(config.successMessage);
                                        }
                                        if (config.redirectUrl) {
                                            window.location.href = config.redirectUrl;
                                        }
                                    } else {
                                        console.error('Delete failed:', response.status);
                                        if (window.showError) {
                                            window.showError('Failed to delete. Please try again.');
                                        } else {
                                            alert('Failed to delete. Please try again.');
                                        }
                                    }
                                } catch (error) {
                                    this[config.modalId] = false;
                                    console.error('Delete error:', error);
                                    if (window.showError) {
                                        window.showError('An error occurred. Please try again.');
                                    } else {
                                        alert('An error occurred. Please try again.');
                                    }
                                } finally {
                                    this.isLoading = false;
                                }
                            }
                        };
                    };
                }
                </script>
                {# djlint:off #}
            <button type="button" 
                    class="delete-modal-button delete-modal-button--danger"
                    {% if hx_url %}
                    x-data="window.getDeleteModalData({
                        modalId: '{{ modal_id }}',
                        hxUrl: '{{ hx_url }}',
                        hxMethod: '{{ hx_method|default:'DELETE'|upper }}',
                        successMessage: '{{ success_message|default:'Deleted successfully!' }}',
                        csrfToken: '{{ csrf_token }}',
                        redirectUrl: '{{ redirect_url|default:'' }}'
                    })"
                    @click="handleDelete()"
                    :disabled="isLoading"
            {% elif confirm_callback %}
                @click="{{ confirm_callback }}"
            {% endif %}
            >
            <i class="fas fa-trash me-2"></i>
            {{ confirm_text|default:'Delete' }}
            </button>
                {# djlint:on #}
            </div>
        </div>
    </div>
</template>
