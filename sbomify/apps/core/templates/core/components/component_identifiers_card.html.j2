{% load static utils %}
<div class="tw-card shadow"
     id="component-identifiers-card"
     x-data="{ showAddModal: false, showEditModal: false, showDeleteModal: false, editId: '', editType: '', editValue: '', deleteId: '', deleteName: '', addType: '' }">
    <div class="px-6 py-4 border-b border-border flex justify-between items-center">
        <h4 class="text-lg font-semibold text-text flex items-center gap-2 m-0">
            <i class="fas fa-barcode text-primary" aria-hidden="true"></i>Component Identifiers
        </h4>
        {% if can_manage_identifiers %}
            <button type="button"
                    class="tw-btn-primary text-sm"
                    @click="showAddModal = true">
                <i class="fas fa-plus mr-1" aria-hidden="true"></i>Add Identifier
            </button>
        {% elif has_crud_permissions and not is_feature_allowed %}
            <span class="text-text-muted text-sm">
                <i class="fas fa-lock mr-1" aria-hidden="true"></i>Business feature
            </span>
        {% endif %}
    </div>
    <div>
        {% if identifiers %}
            <div class="overflow-x-auto">
                <table class="tw-table">
                    <thead>
                        <tr>
                            <th style="width: 20%">Type</th>
                            <th style="width: 30%">Value</th>
                            <th class="!text-center" style="width: 35%">Barcode</th>
                            {% if can_manage_identifiers %}
                                <th class="!text-center" style="width: 15%">Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for identifier in identifiers %}
                            <tr>
                                <td>
                                    <span class="tw-badge-secondary">
                                        {{ identifier_types|get_item:identifier.identifier_type|default:identifier.identifier_type }}
                                    </span>
                                </td>
                                <td>
                                    <code class="text-primary bg-primary/5 px-2 py-0.5 rounded">{{ identifier.value }}</code>
                                </td>
                                <td class="text-center">
                                    {% if identifier.identifier_type in barcode_types %}
                                        <div class="barcode-wrapper inline-block"
                                             x-data="productIdentifiersBarcodes()"
                                             x-init="renderBarcode('{{ identifier.id|escapejs }}', '{{ identifier.value|escapejs }}', '{{ identifier.identifier_type|escapejs }}')">
                                            <svg data-barcode-id="{{ identifier.id }}"
                                                 class="barcode-svg max-w-full"
                                                 x-show="!barcodeErrors['{{ identifier.id|escapejs }}']">
                                            </svg>
                                            <div class="text-danger text-xs flex flex-col items-center gap-1"
                                                 x-show="barcodeErrors['{{ identifier.id|escapejs }}']"
                                                 x-cloak>
                                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                                <span>Invalid barcode format</span>
                                                <small class="text-text-muted">The value is not a valid {{ identifier_types|get_item:identifier.identifier_type|default:identifier.identifier_type }} format</small>
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-text-muted">â€”</span>
                                    {% endif %}
                                </td>
                                {% if can_manage_identifiers %}
                                    <td class="text-center">
                                        <div class="flex items-center justify-center gap-1">
                                            <button type="button"
                                                    class="tw-icon-btn tw-icon-btn-sm"
                                                    title="Edit"
                                                    aria-label="Edit identifier"
                                                    @click="editId = '{{ identifier.id|escapejs }}'; editType = '{{ identifier.identifier_type|escapejs }}'; editValue = '{{ identifier.value|escapejs }}'; showEditModal = true">
                                                <i class="fas fa-edit" aria-hidden="true"></i>
                                            </button>
                                            <button type="button"
                                                    class="tw-icon-btn tw-icon-btn-sm text-danger"
                                                    title="Delete"
                                                    aria-label="Delete identifier"
                                                    @click="deleteId = '{{ identifier.id|escapejs }}'; deleteName = '{{ identifier.value|escapejs }}'; showDeleteModal = true">
                                                <i class="fas fa-trash" aria-hidden="true"></i>
                                            </button>
                                        </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="flex flex-col items-center justify-center py-12 px-6">
                <div class="w-16 h-16 rounded-full bg-border/30 flex items-center justify-center mb-4">
                    <i class="fas fa-barcode text-2xl text-text-muted" aria-hidden="true"></i>
                </div>
                {% if not has_crud_permissions %}
                    <p class="text-text-muted m-0">No component identifiers available</p>
                    <p class="text-text-muted text-sm mt-1">This component does not have any identifiers defined</p>
                {% elif not is_feature_allowed %}
                    <p class="text-text-muted m-0">Component identifiers are a business feature</p>
                    <p class="text-text-muted text-sm mt-1">
                        Upgrade to a business or enterprise plan to add identifiers like CPE, PURL, etc.
                    </p>
                {% else %}
                    <p class="text-text-muted m-0">No component identifiers added</p>
                    <p class="text-text-muted text-sm mt-1">Add identifiers like CPE, PURL, etc. to help identify this component</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
    {% if can_manage_identifiers %}
        {# Add Identifier Modal #}
        <template x-teleport="body">
            <div x-show="showAddModal"
                 x-cloak
                 class="fixed inset-0 z-[100]"
                 role="dialog"
                 aria-modal="true"
                 aria-labelledby="addComponentIdentifierModalLabel">
                <div x-show="showAddModal"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="tw-modal-overlay"
                     @click="showAddModal = false"></div>
                <div class="tw-modal"
                     x-show="showAddModal"
                     x-trap.noscroll="showAddModal"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     @click.stop
                     @keydown.escape="if(showAddModal) showAddModal = false">
                    <div class="tw-modal-content">
                        <form id="add-component-identifier-form"
                              @submit.prevent=" fetch('{% url 'core:component_identifiers' component.id %}', { method: 'POST', body: new FormData($el), }).then(response => response.text()).then(html => { document.getElementById('component-identifiers-card').outerHTML = html; showAddModal = false; }); ">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="create">
                            <div class="tw-modal-header">
                                <h4 id="addComponentIdentifierModalLabel" class="tw-modal-title">Add Identifier</h4>
                                <button type="button"
                                        class="tw-modal-close"
                                        @click="showAddModal = false"
                                        aria-label="Close">
                                    <i class="fas fa-times" aria-hidden="true"></i>
                                </button>
                            </div>
                            <div class="tw-modal-body space-y-4">
                                <div>
                                    <label for="add-component-identifier-type" class="tw-form-label">
                                        Identifier Type <span class="text-danger">*</span>
                                    </label>
                                    <select id="add-component-identifier-type"
                                            name="identifier_type"
                                            class="tw-form-select"
                                            required
                                            x-model="addType">
                                        <option value="">Select type...</option>
                                        {% for value, label in identifier_types.items %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label for="add-component-identifier-value" class="tw-form-label">
                                        Value <span class="text-danger">*</span>
                                    </label>
                                    <input type="text"
                                           id="add-component-identifier-value"
                                           name="value"
                                           class="tw-form-input"
                                           :placeholder="addType === 'purl' ? 'pkg:type/namespace/name (no version)' : (addType === 'cpe' ? 'cpe:2.3:a:vendor:product' : 'Enter identifier value')"
                                           required>
                                    <template x-if="addType === 'purl'">
                                        <p class="text-text-muted text-xs mt-1">Enter without version. Example: pkg:npm/@scope/package</p>
                                    </template>
                                </div>
                            </div>
                            <div class="tw-modal-footer">
                                <button type="button" class="tw-btn-ghost" @click="showAddModal = false">Cancel</button>
                                <button type="submit" class="tw-btn-primary">
                                    <i class="fas fa-plus mr-2"></i>Add
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </template>
        {# Edit Identifier Modal #}
        <template x-teleport="body">
            <div x-show="showEditModal"
                 x-cloak
                 class="fixed inset-0 z-[100]"
                 role="dialog"
                 aria-modal="true"
                 aria-labelledby="editComponentIdentifierModalLabel">
                <div x-show="showEditModal"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="tw-modal-overlay"
                     @click="showEditModal = false"></div>
                <div class="tw-modal"
                     x-show="showEditModal"
                     x-trap.noscroll="showEditModal"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     @click.stop
                     @keydown.escape="if(showEditModal) showEditModal = false">
                    <div class="tw-modal-content">
                        <form id="edit-component-identifier-form"
                              @submit.prevent=" const formData = new FormData($el); formData.set('identifier_id', editId); fetch('{% url 'core:component_identifiers' component.id %}', { method: 'POST', body: formData, }).then(response => response.text()).then(html => { document.getElementById('component-identifiers-card').outerHTML = html; showEditModal = false; }); ">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update">
                            <input type="hidden" name="identifier_id" :value="editId">
                            <div class="tw-modal-header">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                                        <i class="fas fa-edit" aria-hidden="true"></i>
                                    </div>
                                    <h4 id="editComponentIdentifierModalLabel" class="tw-modal-title">Edit Identifier</h4>
                                </div>
                                <button type="button"
                                        class="tw-modal-close"
                                        @click="showEditModal = false"
                                        aria-label="Close">
                                    <i class="fas fa-times" aria-hidden="true"></i>
                                </button>
                            </div>
                            <div class="tw-modal-body space-y-4">
                                <div>
                                    <label for="edit-component-identifier-type" class="tw-form-label">
                                        Identifier Type <span class="text-danger">*</span>
                                    </label>
                                    <select id="edit-component-identifier-type"
                                            name="identifier_type"
                                            class="tw-form-select"
                                            required
                                            x-model="editType">
                                        <option value="">Select type...</option>
                                        {% for value, label in identifier_types.items %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label for="edit-component-identifier-value" class="tw-form-label">
                                        Value <span class="text-danger">*</span>
                                    </label>
                                    <input type="text"
                                           id="edit-component-identifier-value"
                                           name="value"
                                           class="tw-form-input"
                                           :placeholder="editType === 'purl' ? 'pkg:type/namespace/name (no version)' : (editType === 'cpe' ? 'cpe:2.3:a:vendor:product' : 'Enter identifier value')"
                                           required
                                           x-model="editValue">
                                    <template x-if="editType === 'purl'">
                                        <p class="text-text-muted text-xs mt-1">Enter without version. Example: pkg:npm/@scope/package</p>
                                    </template>
                                </div>
                            </div>
                            <div class="tw-modal-footer">
                                <button type="button" class="tw-btn-ghost" @click="showEditModal = false">Cancel</button>
                                <button type="submit" class="tw-btn-primary">
                                    <i class="fas fa-save mr-2"></i>Update
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </template>
        {# Delete Identifier Modal #}
        <template x-teleport="body">
            <div x-show="showDeleteModal"
                 x-cloak
                 class="fixed inset-0 z-[100]"
                 role="alertdialog"
                 aria-modal="true"
                 aria-labelledby="deleteComponentIdentifierModalLabel">
                <div x-show="showDeleteModal"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="tw-modal-overlay"
                     @click="showDeleteModal = false"></div>
                <div class="tw-modal"
                     x-show="showDeleteModal"
                     x-trap.noscroll="showDeleteModal"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     @click.stop
                     @keydown.escape="if(showDeleteModal) showDeleteModal = false">
                    <div class="tw-modal-content tw-modal-sm">
                        <div class="tw-modal-body text-center py-6">
                            <button type="button"
                                    class="tw-modal-close absolute top-4 right-4"
                                    @click="showDeleteModal = false"
                                    aria-label="Close">
                                <i class="fas fa-times" aria-hidden="true"></i>
                            </button>
                            <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-danger/10 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-danger text-xl"></i>
                            </div>
                            <h4 id="deleteComponentIdentifierModalLabel" class="tw-modal-title mb-2">Delete Identifier</h4>
                            <p class="text-text mb-2">
                                Are you sure you want to delete identifier <span class="font-semibold text-danger" x-text="deleteName"></span>?
                            </p>
                            <p class="text-text-muted text-sm">This action cannot be undone and will permanently remove this identifier.</p>
                        </div>
                        <div class="tw-modal-footer justify-center">
                            <button type="button" class="tw-btn-ghost" @click="showDeleteModal = false">Cancel</button>
                            <button type="button"
                                    class="tw-btn-danger"
                                    @click=" const formData = new FormData(); formData.append('csrfmiddlewaretoken', '{{ csrf_token }}'); formData.append('action', 'delete'); formData.append('identifier_id', deleteId); fetch('{% url 'core:component_identifiers' component.id %}', { method: 'POST', body: formData, }).then(response => response.text()).then(html => { document.getElementById('component-identifiers-card').outerHTML = html; showDeleteModal = false; }); ">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    {% endif %}
</div>
