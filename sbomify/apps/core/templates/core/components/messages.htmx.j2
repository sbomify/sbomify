<script>
    (function() {
        function showMessage(messageType, messageText) {
            let type;
            switch(messageType) {
                case 'alert-danger':
                case 'error':
                    type = 'error';
                    break;
                case 'alert-success':
                case 'success':
                    type = 'success';
                    break;
                case 'alert-warning':
                case 'warning':
                    type = 'warning';
                    break;
                case 'alert-info':
                case 'info':
                    type = 'info';
                    break;
                default:
                    type = 'info';
            }

            if (window.showToast) {
                window.showToast({
                    title: type.charAt(0).toUpperCase() + type.slice(1),
                    message: messageText,
                    type: type
                });
            }
        }

        {% if messages %}
        // Max retries to prevent infinite loop if bundle fails to load (100 * 50ms = 5s max)
        var messageRetries = 100;
        function showMessagesWhenReady() {
            if (window.showToast) {
                {% for message in messages %}
                showMessage('{{ message.level_tag }}', '{{ message|escapejs }}');
                {% endfor %}
            } else if (messageRetries > 0) {
                messageRetries--;
                // Retry after a short delay - bundle may not be loaded yet
                setTimeout(showMessagesWhenReady, 50);
            }
            // If retries exhausted, silently fail - messages will show on next page load
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showMessagesWhenReady);
        } else {
            showMessagesWhenReady();
        }
        {% endif %}

        {% if pending_invitations_count and pending_invitations_count > 0 %}
        // Show pending invitation notification once per session
        // Max retries to prevent infinite loop if bundle fails to load
        var invitationRetries = 100;
        function showInvitationNotification() {
            if (!window.showToast) {
                if (invitationRetries > 0) {
                    invitationRetries--;
                    // Retry after a short delay - bundle may not be loaded yet
                    setTimeout(showInvitationNotification, 50);
                }
                return;
            }
            
            // Use a simple key - show once per session regardless of count changes
            var storageKey = 'invitation_toast_shown_v1';
            
            // Only show once per session
            if (!sessionStorage.getItem(storageKey)) {
                var count = {{ pending_invitations_count }};
                var message = count === 1 
                    ? 'You have a workspace invitation! Check your settings to accept it.'
                    : 'You have ' + count + ' workspace invitations! Check your settings to accept them.';
                
                window.showToast({
                    title: 'Workspace Invitation',
                    message: message,
                    type: 'info'
                });
                sessionStorage.setItem(storageKey, 'shown');
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showInvitationNotification);
        } else {
            showInvitationNotification();
        }
        {% endif %}

        document.body.addEventListener('messages', function(event) {
            if (!event.detail.value || !Array.isArray(event.detail.value)) {
                return;
            }

            event.detail.value.forEach(function(msg) {
                showMessage(msg.type, msg.message);
            });
        });
    })();
</script>
