{% load static utils %}
<div class="card shadow-sm"
     id="product-lifecycle-card"
     x-data="{ editing: false, releaseDate: '{{ product.release_date|default:'' }}', endOfSupport: '{{ product.end_of_support|default:'' }}', endOfLife: '{{ product.end_of_life|default:'' }}', saving: false }">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="card-title mb-0">
            <i class="fas fa-clock me-2"></i>Lifecycle
            <i class="fa-regular fa-circle-question text-muted ms-1"
               style="font-size: 0.875rem;
                      cursor: help"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="Key lifecycle dates aligned with Common Lifecycle Enumeration (CLE)"></i>
        </h4>
        {% if can_edit %}
            <template x-if="!editing">
                <button type="button"
                        class="btn btn-outline-primary btn-sm"
                        @click="editing = true">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
            </template>
        {% endif %}
    </div>
    <div class="card-body">
        <!-- Display Mode -->
        <template x-if="!editing">
            <div>
                {% if product.release_date or product.end_of_support or product.end_of_life %}
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <div class="text-muted small mb-1">Release Date</div>
                            {% if product.release_date %}
                                <div class="fw-medium">{{ product.release_date }}</div>
                            {% else %}
                                <div class="text-muted fst-italic">Not set</div>
                            {% endif %}
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="text-muted small mb-1">End of Support</div>
                            {% if product.end_of_support %}
                                <div class="fw-medium">{{ product.end_of_support }}</div>
                            {% else %}
                                <div class="text-muted fst-italic">Not set</div>
                            {% endif %}
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="text-muted small mb-1">End of Life</div>
                            {% if product.end_of_life %}
                                <div class="fw-medium">{{ product.end_of_life }}</div>
                            {% else %}
                                <div class="text-muted fst-italic">Not set</div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-clock fa-2x mb-3"></i>
                        {% if can_edit %}
                            <p class="mb-0">No lifecycle dates set</p>
                            <small>Add release date, end of support, and end of life dates to track product lifecycle</small>
                        {% else %}
                            <p class="mb-0">No lifecycle dates available</p>
                            <small>This product does not have lifecycle dates defined</small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </template>
        <!-- Edit Mode -->
        {% if can_edit %}
            <template x-if="editing">
                <form @submit.prevent=" saving = true; const formData = new FormData(); formData.append('release_date', releaseDate || ''); formData.append('end_of_support', endOfSupport || ''); formData.append('end_of_life', endOfLife || ''); fetch('{% url 'core:product_lifecycle' product.id %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: formData }) .then(response => response.text()) .then(html => { document.getElementById('product-lifecycle-card').outerHTML = html; }) .catch(err => { console.error('Error saving lifecycle:', err); saving = false; }); ">
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label small text-muted">Release Date</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                <input type="date"
                                       class="form-control"
                                       x-model="releaseDate"
                                       placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small text-muted">End of Support</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                <input type="date"
                                       class="form-control"
                                       x-model="endOfSupport"
                                       placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small text-muted">End of Life</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                <input type="date"
                                       class="form-control"
                                       x-model="endOfLife"
                                       placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                    </div>
                    <div class="form-text text-muted small mb-3">Key lifecycle dates aligned with Common Lifecycle Enumeration (CLE)</div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-sm btn-primary" :disabled="saving">
                            <template x-if="saving">
                                <span><i class="fas fa-spinner fa-spin me-1"></i>Saving...</span>
                            </template>
                            <template x-if="!saving">
                                <span><i class="fas fa-check me-1"></i>Save</span>
                            </template>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                @click="editing = false; releaseDate = '{{ product.release_date|default:'' }}'; endOfSupport = '{{ product.end_of_support|default:'' }}'; endOfLife = '{{ product.end_of_life|default:'' }}';"
                                :disabled="saving">Cancel</button>
                    </div>
                </form>
            </template>
        {% endif %}
    </div>
</div>
