{% load static utils %}
<div class="tw-card shadow"
     id="product-lifecycle-card"
     x-data="{ editing: false, releaseDate: '{{ product.release_date|default:'' }}', endOfSupport: '{{ product.end_of_support|default:'' }}', endOfLife: '{{ product.end_of_life|default:'' }}', saving: false, saveLifecycle() { this.saving = true; const formData = new FormData(); formData.append('release_date', this.releaseDate || ''); formData.append('end_of_support', this.endOfSupport || ''); formData.append('end_of_life', this.endOfLife || ''); fetch('{% url 'core:product_lifecycle' product.id %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: formData }) .then(response => response.text()) .then(html => { document.getElementById('product-lifecycle-card').outerHTML = html; }) .catch(err => { console.error('Error saving lifecycle:', err); this.saving = false; }); }, cancelEdit() { this.editing = false; this.releaseDate = '{{ product.release_date|default:'' }}'; this.endOfSupport = '{{ product.end_of_support|default:'' }}'; this.endOfLife = '{{ product.end_of_life|default:'' }}'; }, formatDisplayDate(dateStr) { if (!dateStr) return ''; const date = new Date(dateStr); if (isNaN(date.getTime())) return dateStr; return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); } }">
    <div class="px-6 py-4 border-b border-border flex justify-between items-center">
        <h4 class="text-lg font-semibold text-text flex items-center gap-2 m-0">
            <i class="fas fa-clock text-primary"></i>Lifecycle
            <i class="far fa-question-circle text-text-muted text-sm cursor-help"
               x-tooltip="'Key lifecycle dates aligned with Common Lifecycle Enumeration (CLE)'"></i>
        </h4>
        {% if can_edit %}
            <template x-if="!editing">
                <button type="button"
                        class="tw-btn-secondary text-sm"
                        @click="editing = true">
                    <i class="fas fa-edit mr-1"></i>Edit
                </button>
            </template>
        {% endif %}
    </div>
    <div class="p-6">
        {# Display Mode #}
        <template x-if="!editing">
            <div>
                {% if product.release_date or product.end_of_support or product.end_of_life %}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <div class="text-text-muted text-sm mb-1">Release Date</div>
                            {% if product.release_date %}
                                <div class="font-medium text-text">{{ product.release_date }}</div>
                            {% else %}
                                <div class="text-text-muted italic">Not set</div>
                            {% endif %}
                        </div>
                        <div>
                            <div class="text-text-muted text-sm mb-1">End of Support</div>
                            {% if product.end_of_support %}
                                <div class="font-medium text-text">{{ product.end_of_support }}</div>
                            {% else %}
                                <div class="text-text-muted italic">Not set</div>
                            {% endif %}
                        </div>
                        <div>
                            <div class="text-text-muted text-sm mb-1">End of Life</div>
                            {% if product.end_of_life %}
                                <div class="font-medium text-text">{{ product.end_of_life }}</div>
                            {% else %}
                                <div class="text-text-muted italic">Not set</div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="flex flex-col items-center justify-center py-8">
                        <div class="w-16 h-16 rounded-full bg-border/30 flex items-center justify-center mb-4">
                            <i class="fas fa-clock text-2xl text-text-muted"></i>
                        </div>
                        {% if can_edit %}
                            <p class="text-text-muted m-0">No lifecycle dates set</p>
                            <p class="text-text-muted text-sm mt-1">
                                Add release date, end of support, and end of life dates to track product lifecycle
                            </p>
                        {% else %}
                            <p class="text-text-muted m-0">No lifecycle dates available</p>
                            <p class="text-text-muted text-sm mt-1">This product does not have lifecycle dates defined</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </template>
        {# Edit Mode #}
        {% if can_edit %}
            <template x-if="editing">
                <form @submit.prevent="saveLifecycle()">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        {% include 'components/date_picker.html.j2' with value_binding='releaseDate' label='Release Date' format_fn='formatDisplayDate' %}
                        {% include 'components/date_picker.html.j2' with value_binding='endOfSupport' label='End of Support' format_fn='formatDisplayDate' %}
                        {% include 'components/date_picker.html.j2' with value_binding='endOfLife' label='End of Life' format_fn='formatDisplayDate' %}
                    </div>
                    <p class="text-text-muted text-sm mb-4">Key lifecycle dates aligned with Common Lifecycle Enumeration (CLE)</p>
                    <div class="flex gap-2">
                        <button type="submit" class="tw-btn-primary text-sm" :disabled="saving">
                            <template x-if="saving">
                                <span><i class="fas fa-spinner fa-spin mr-1"></i>Saving...</span>
                            </template>
                            <template x-if="!saving">
                                <span><i class="fas fa-check mr-1"></i>Save</span>
                            </template>
                        </button>
                        <button type="button"
                                class="tw-btn-secondary text-sm"
                                @click="cancelEdit()"
                                :disabled="saving">Cancel</button>
                    </div>
                </form>
            </template>
        {% endif %}
    </div>
</div>
