{% load static utils %}
<div class="bg-white rounded-lg shadow-sm"
     id="product-lifecycle-card"
     x-cloak
     x-data="productLifecycleCard({ productId: {{ product.id }}, cardElementId: 'product-lifecycle-card', updateUrl: '{% url 'core:product_lifecycle' product.id %}', csrfToken: '{{ csrf_token }}', initialReleaseDate: '{{ product.release_date|default:'' }}', initialEndOfSupport: '{{ product.end_of_support|default:'' }}', initialEndOfLife: '{{ product.end_of_life|default:'' }}' })">
    <div class="px-6 py-4 border-b flex justify-between items-center">
        <h4 class="text-lg font-semibold mb-0">
            <i class="fas fa-clock mr-2"></i>Lifecycle
            <i class="fa-regular fa-circle-question text-gray-600 ml-1"
               style="font-size: 0.875rem;
                      cursor: help"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="Key lifecycle dates aligned with Common Lifecycle Enumeration (CLE)"></i>
        </h4>
        {% if can_edit %}
            <template x-if="!editing">
                <button type="button"
                        class="px-2 py-1 text-sm border border-brand-primary text-brand-primary rounded hover:bg-brand-primary hover:text-white transition-colors"
                        @click="editing = true"
                        aria-label="Edit lifecycle dates">
                    <i class="fas fa-edit mr-1" aria-hidden="true"></i>Edit
                </button>
            </template>
        {% endif %}
    </div>
    <div class="p-6">
        <!-- Display Mode -->
        <template x-if="!editing">
            <div>
                {% if product.release_date or product.end_of_support or product.end_of_life %}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <div class="text-gray-600 text-sm mb-1">Release Date</div>
                            {% if product.release_date %}
                                <div class="font-medium">{{ product.release_date }}</div>
                            {% else %}
                                <div class="text-gray-600 italic">Not set</div>
                            {% endif %}
                        </div>
                        <div>
                            <div class="text-gray-600 text-sm mb-1">End of Support</div>
                            {% if product.end_of_support %}
                                <div class="font-medium">{{ product.end_of_support }}</div>
                            {% else %}
                                <div class="text-gray-600 italic">Not set</div>
                            {% endif %}
                        </div>
                        <div>
                            <div class="text-gray-600 text-sm mb-1">End of Life</div>
                            {% if product.end_of_life %}
                                <div class="font-medium">{{ product.end_of_life }}</div>
                            {% else %}
                                <div class="text-gray-600 italic">Not set</div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-3 text-gray-600">
                        <i class="fas fa-clock fa-2x mb-3"></i>
                        {% if can_edit %}
                            <p class="mb-0">No lifecycle dates set</p>
                            <small>Add release date, end of support, and end of life dates to track product lifecycle</small>
                        {% else %}
                            <p class="mb-0">No lifecycle dates available</p>
                            <small>This product does not have lifecycle dates defined</small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </template>
        <!-- Edit Mode -->
        {% if can_edit %}
            <template x-if="editing">
                <form @submit.prevent="saveLifecycle()" x-ref="form">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Release Date</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 py-2 border border-r-0 border-gray-300 rounded-l bg-gray-50"><i class="fas fa-calendar-alt"></i></span>
                                <input type="date"
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-r focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                       x-model="releaseDate"
                                       placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">End of Support</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 py-2 border border-r-0 border-gray-300 rounded-l bg-gray-50"><i class="fas fa-calendar-alt"></i></span>
                                <input type="date"
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-r focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                       x-model="endOfSupport"
                                       placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">End of Life</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 py-2 border border-r-0 border-gray-300 rounded-l bg-gray-50"><i class="fas fa-calendar-alt"></i></span>
                                <input type="date"
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-r focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                       x-model="endOfLife"
                                       placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-4">Key lifecycle dates aligned with Common Lifecycle Enumeration (CLE)</div>
                    <div class="flex gap-2">
                        <button type="submit"
                                class="px-3 py-1.5 text-sm bg-brand-primary text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="saving">
                            <template x-if="saving">
                                <span><i class="fas fa-spinner fa-spin mr-1"></i>Saving...</span>
                            </template>
                            <template x-if="!saving">
                                <span><i class="fas fa-check mr-1"></i>Save</span>
                            </template>
                        </button>
                        <button type="button"
                                class="px-3 py-1.5 text-sm border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                @click="cancelEdit()"
                                :disabled="saving">Cancel</button>
                    </div>
                </form>
            </template>
        {% endif %}
    </div>
</div>
