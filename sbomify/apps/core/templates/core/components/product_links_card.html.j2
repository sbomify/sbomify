{% load static utils %}
<link rel="stylesheet"
      href="{% static 'css/components/delete_modal.css' %}">
<div class="card shadow-sm"
     id="product-links-card"
     x-cloak
     x-data="productLinksCard({ productId: {{ product.id }}, cardElementId: 'product-links-card', updateUrl: '{% url 'core:product_links' product.id %}' })">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="card-title mb-0">
            <i class="fas fa-link mr-2"></i>Product Links
        </h4>
        {% if can_manage_links %}
            <button type="button"
                    class="btn btn-primary btn-sm"
                    @click="showAddModal = true">
                <i class="fas fa-plus me-1"></i>Add Link
            </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if links %}
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th style="width: 15%">Type</th>
                            <th style="width: 25%">Title</th>
                            <th style="width: 45%">URL</th>
                            {% if can_manage_links %}
                                <th style="width: 15%" class="text-end">Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for link in links %}
                            <tr>
                                <td>
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700">
                                        {{ link_types|get_item:link.link_type|default:link.link_type }}
                                    </span>
                                </td>
                                <td>
                                    <strong>{{ link.title }}</strong>
                                    {% if link.description %}<div class="text-muted small">{{ link.description }}</div>{% endif %}
                                </td>
                                <td>
                                    <a href="{{ link.url }}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="text-brand-primary hover:underline">
                                        {% if link.url|length > 50 %}
                                            {{ link.url|truncatechars:50 }}
                                        {% else %}
                                            {{ link.url }}
                                        {% endif %}
                                        <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                                    </a>
                                </td>
                                {% if can_manage_links %}
                                    <td class="text-right">
                                        <div class="inline-flex gap-1">
                                            <button type="button"
                                                    class="px-2 py-1 text-sm border border-brand-primary text-brand-primary rounded hover:bg-brand-primary hover:text-white transition-colors"
                                                    title="Edit"
                                                    @click="openEditModal('{{ link.id }}', '{{ link.link_type }}', '{{ link.title|escapejs }}', '{{ link.url|escapejs }}', '{{ link.description|default:''|escapejs }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button"
                                                    class="px-2 py-1 text-sm border border-danger-500 text-danger-500 rounded hover:bg-danger-500 hover:text-white transition-colors"
                                                    title="Delete"
                                                    @click="openDeleteModal('{{ link.id }}', '{{ link.title|escapejs }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-4 text-gray-600">
                <i class="fas fa-link fa-2x mb-3"></i>
                {% if not has_crud_permissions %}
                    <p class="mb-0">No product links available</p>
                    <small>This product does not have any links defined</small>
                {% else %}
                    <p class="mb-0">No product links added</p>
                    <small>Add links like website, support, documentation, etc. to provide additional information about this product</small>
                {% endif %}
            </div>
        {% endif %}
    </div>
    {% if can_manage_links %}
        <!-- Add Link Modal -->
        <template x-teleport="body">
            <div x-show="showAddModal"
                 x-trap.inert.noscroll="showAddModal"
                 class="delete-modal-overlay"
                 role="dialog"
                 aria-modal="true"
                 aria-labelledby="add-link-modal-title"
                 @click.self="showAddModal = false"
                 @keydown.escape.window="showAddModal = false"
                 x-transition:enter="transition ease-out duration-150"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-100"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 style="display: none">
                <div class="delete-modal" style="max-width: 600px;" @click.stop>
                    <form id="add-link-form" @submit.prevent="handleAddSubmit($event)">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create">
                        <div class="delete-modal-header">
                            <h3 class="delete-modal-title" id="add-link-modal-title">Add Link</h3>
                            <button type="button"
                                    class="delete-modal-close"
                                    @click="showAddModal = false"
                                    aria-label="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="delete-modal-body">
                            <div class="mb-4">
                                <label for="add-link-type"
                                       class="block text-sm font-medium text-gray-700 mb-1">
                                    Link Type <span class="text-danger-500">*</span>
                                </label>
                                <select id="add-link-type"
                                        name="link_type"
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary"
                                        required>
                                    <option value="">Select type...</option>
                                    {% for value, label in link_types.items %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="add-link-title"
                                       class="block text-sm font-medium text-gray-700 mb-1">
                                    Title <span class="text-danger-500">*</span>
                                </label>
                                <input type="text"
                                       id="add-link-title"
                                       name="title"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                       placeholder="Enter link title"
                                       required>
                            </div>
                            <div class="mb-4">
                                <label for="add-link-url"
                                       class="block text-sm font-medium text-gray-700 mb-1">
                                    URL <span class="text-danger-500">*</span>
                                </label>
                                <input type="url"
                                       id="add-link-url"
                                       name="url"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                       placeholder="https://example.com"
                                       required>
                            </div>
                            <div class="mb-4">
                                <label for="add-link-description"
                                       class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea id="add-link-description"
                                          name="description"
                                          class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                          rows="3"
                                          placeholder="Optional description of this link"></textarea>
                            </div>
                        </div>
                        <div class="delete-modal-footer">
                            <button type="button"
                                    class="delete-modal-button delete-modal-button--secondary"
                                    @click="showAddModal = false">Cancel</button>
                            <button type="submit"
                                    class="delete-modal-button delete-modal-button--primary">
                                <i class="fas fa-plus mr-2"></i>Add
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>
        <!-- Edit Link Modal -->
        <template x-teleport="body">
            <div x-show="showEditModal"
                 x-trap.inert.noscroll="showEditModal"
                 class="delete-modal-overlay"
                 role="dialog"
                 aria-modal="true"
                 aria-labelledby="edit-link-modal-title"
                 @click.self="showEditModal = false"
                 @keydown.escape.window="showEditModal = false"
                 x-transition:enter="transition ease-out duration-150"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-100"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 style="display: none">
                <div class="delete-modal" style="max-width: 600px;" @click.stop>
                    <form id="edit-link-form" @submit.prevent="handleEditSubmit($event)">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="link_id" :value="editId">
                        <div class="delete-modal-header">
                            <div class="delete-modal-icon delete-modal-icon--edit">
                                <i class="fas fa-edit" aria-hidden="true"></i>
                            </div>
                            <h3 class="delete-modal-title" id="edit-link-modal-title">Edit Link</h3>
                            <button type="button"
                                    class="delete-modal-close"
                                    @click="showEditModal = false"
                                    aria-label="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="delete-modal-body">
                            <div class="mb-4">
                                <label for="edit-link-type"
                                       class="block text-sm font-medium text-gray-700 mb-1">
                                    Link Type <span class="text-danger-500">*</span>
                                </label>
                                <select id="edit-link-type"
                                        name="link_type"
                                        class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary"
                                        required
                                        x-model="editType">
                                    <option value="">Select type...</option>
                                    {% for value, label in link_types.items %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="edit-link-title"
                                       class="block text-sm font-medium text-gray-700 mb-1">
                                    Title <span class="text-danger-500">*</span>
                                </label>
                                <input type="text"
                                       id="edit-link-title"
                                       name="title"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                       placeholder="Enter link title"
                                       required
                                       x-model="editTitle">
                            </div>
                            <div class="mb-4">
                                <label for="edit-link-url"
                                       class="block text-sm font-medium text-gray-700 mb-1">
                                    URL <span class="text-danger-500">*</span>
                                </label>
                                <input type="url"
                                       id="edit-link-url"
                                       name="url"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                       placeholder="https://example.com"
                                       required
                                       x-model="editUrl">
                            </div>
                            <div class="mb-4">
                                <label for="edit-link-description"
                                       class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea id="edit-link-description"
                                          name="description"
                                          class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                          rows="3"
                                          placeholder="Optional description of this link"
                                          x-model="editDescription"></textarea>
                            </div>
                        </div>
                        <div class="delete-modal-footer">
                            <button type="button"
                                    class="delete-modal-button delete-modal-button--secondary"
                                    @click="showEditModal = false">Cancel</button>
                            <button type="submit"
                                    class="delete-modal-button delete-modal-button--primary">
                                <i class="fas fa-save mr-2"></i>Update
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </template>
        <!-- Delete Link Modal -->
        <template x-teleport="body">
            <div x-show="showDeleteModal"
                 x-trap.inert.noscroll="showDeleteModal"
                 class="delete-modal-overlay"
                 role="alertdialog"
                 aria-modal="true"
                 aria-labelledby="delete-link-modal-title"
                 @click.self="showDeleteModal = false"
                 @keydown.escape.window="showDeleteModal = false"
                 x-transition:enter="transition ease-out duration-150"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-100"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 style="display: none">
                <div class="delete-modal" @click.stop>
                    <div class="delete-modal-header">
                        <div class="delete-modal-icon">
                            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                        </div>
                        <h3 class="delete-modal-title" id="delete-link-modal-title">Delete Link</h3>
                        <button type="button"
                                class="delete-modal-close"
                                @click="showDeleteModal = false"
                                aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="delete-modal-body">
                        <p class="delete-modal-message">
                            Are you sure you want to delete <span class="delete-modal-name" x-text="deleteName"></span>?
                        </p>
                        <p class="delete-modal-warning">This action cannot be undone and will permanently remove this link.</p>
                    </div>
                    <div class="delete-modal-footer">
                        <button type="button"
                                class="delete-modal-button delete-modal-button--secondary"
                                @click="showDeleteModal = false">Cancel</button>
                        <button type="button"
                                class="delete-modal-button delete-modal-button--danger"
                                @click="handleDelete()">
                            <i class="fas fa-trash me-2"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </template>
    {% endif %}
</div>
