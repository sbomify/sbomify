{% load static %}
<div x-data="releaseArtifacts({ releaseId: '{{ release_id }}', productId: '{{ product_id }}', initialArtifacts: [], totalCount: 0, canEdit: {{ can_edit|yesno:'true,false' }}, isLatest: {{ is_latest|default:False|yesno:'true,false' }} })"
     x-init="loadArtifacts()">
    <div class="tw-card">
        <div class="px-6 py-4 border-b border-border flex flex-wrap items-center justify-between gap-3">
            <h4 class="text-lg font-semibold text-text flex items-center gap-2 m-0">
                <i class="fas fa-puzzle-piece"></i>Artifacts
            </h4>
            {% if can_edit and not is_latest %}
                <button type="button" class="tw-btn-primary" @click="openAddModal()">
                    <i class="fas fa-plus mr-2"></i>Add Artifact
                </button>
            {% elif is_latest and can_edit %}
                <div class="px-3 py-2 bg-info/10 text-info rounded-lg text-sm flex items-center gap-2">
                    <i class="fas fa-info-circle"></i>
                    <span>The "Latest" release is automatically managed and cannot be modified manually.</span>
                </div>
            {% endif %}
        </div>
        <div class="p-0">
            {# Loading State #}
            <div x-show="isLoading"
                 class="flex flex-col items-center justify-center py-12">
                <div class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full"></div>
                <p class="mt-3 text-text-muted">Loading artifacts...</p>
            </div>
            {# Empty State #}
            <div x-show="!isLoading && artifacts.length === 0"
                 class="flex flex-col items-center justify-center py-12 px-6">
                <div class="w-16 h-16 rounded-full bg-border/30 flex items-center justify-center mb-4">
                    <i class="fas fa-puzzle-piece text-2xl text-text-muted"></i>
                </div>
                <h5 class="text-lg font-semibold text-text mb-2">No artifacts yet</h5>
                <p class="text-text-muted mb-4">Add artifacts to this release to get started</p>
                {% if can_edit and not is_latest %}
                    <button type="button" class="tw-btn-primary" @click="openAddModal()">
                        <i class="fas fa-plus mr-2"></i>Add Artifact
                    </button>
                {% elif is_latest and can_edit %}
                    <p class="text-text-muted text-sm m-0">
                        <i class="fas fa-info-circle mr-1"></i>Latest release is automatically managed
                    </p>
                {% endif %}
            </div>
            {# Artifacts Table Container #}
            <div x-show="!isLoading && artifacts.length > 0">
                {# Search and Filter Controls #}
                <div class="px-6 py-4 border-b border-border">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                        <div class="md:col-span-6">
                            <input type="text"
                                   x-model="search"
                                   @input.debounce="handleSearch()"
                                   class="tw-form-input"
                                   placeholder="Search artifacts by name, component, or format...">
                        </div>
                        <div class="md:col-span-3">
                            <select x-model="typeFilter"
                                    @change="handleTypeFilter()"
                                    class="tw-form-input">
                                <option value="">All Types</option>
                                <option value="sbom">SBOMs Only</option>
                                <option value="document">Documents Only</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <select x-model="componentFilter"
                                    @change="handleComponentFilter()"
                                    class="tw-form-input">
                                <option value="">All Components</option>
                                <template x-for="comp in uniqueComponents" :key="comp">
                                    <option :value="comp" x-text="comp"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>
                {# Results Summary #}
                <div class="px-6 py-3 flex flex-wrap items-center justify-between gap-3 bg-background/50">
                    <span class="text-text-muted text-sm">
                        Showing <span x-text="filteredArtifacts.length"></span> of <span x-text="artifacts.length"></span> artifacts
                    </span>
                    <div class="flex items-center gap-2">
                        <label class="text-text-muted text-sm">Items per page:</label>
                        <select x-model="pageSize"
                                @change="currentPage = 1"
                                class="px-3 py-1.5 text-sm bg-card border border-border rounded-lg text-text">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                {# Artifacts Table #}
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-border bg-background/50">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase w-10">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Name</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Component</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Format</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Version</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase w-28">Created</th>
                                {% if can_edit and not is_latest %}
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-text-muted uppercase w-20">Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border">
                            <template x-for="artifact in paginatedArtifacts" :key="artifact.id">
                                <tr class="hover:bg-background/50 transition-colors">
                                    <td class="px-4 py-3">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                                             :class="getArtifactIconClass(artifact)">
                                            <i :class="getTypeIcon(getArtifactType(artifact))" class="text-sm"></i>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-2">
                                            <a :href="getArtifactUrl(artifact)"
                                               class="text-primary font-medium hover:underline"
                                               x-text="getArtifactName(artifact)"></a>
                                            <span class="px-2 py-0.5 text-xs font-medium rounded-full"
                                                  :class="getArtifactBadgeClass(artifact)"
                                                  x-text="getArtifactType(artifact).toUpperCase()"></span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <a :href="getComponentUrl(artifact)"
                                           class="text-text hover:text-primary transition-colors"
                                           x-text="getArtifactComponent(artifact)"></a>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-text" x-text="getArtifactFormat(artifact)"></span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span x-show="getArtifactVersion(artifact)"
                                              class="text-text"
                                              :title="getArtifactVersion(artifact)"
                                              x-text="truncateText(getArtifactVersion(artifact) || '', 20)"></span>
                                        <span x-show="!getArtifactVersion(artifact)" class="text-text-muted">—</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-text-muted text-sm" x-text="getArtifactDate(artifact)"></span>
                                    </td>
                                    {% if can_edit and not is_latest %}
                                        <td class="px-4 py-3 text-center">
                                            <button type="button"
                                                    class="p-2 rounded-lg text-danger hover:bg-danger/10 transition-colors"
                                                    title="Remove from release"
                                                    @click="openDeleteModal(artifact)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    {% endif %}
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                {# Pagination #}
                <div x-show="totalPages > 1" class="px-6 py-4 border-t border-border">
                    {% include 'core/components/pagination_controls.html.j2' %}
                </div>
            </div>
        </div>
    </div>
    {% if can_edit and not is_latest %}
        {# Add Artifact Modal Backdrop #}
        <template x-if="showAddModal">
            <div class="fixed inset-0 bg-black/50 z-40" @click="closeAddModal()"></div>
        </template>
        {# Add Artifact Modal #}
        <template x-if="showAddModal">
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 overflow-y-auto">
                <div class="bg-card rounded-xl shadow-xl w-full max-w-4xl" @click.stop>
                    <div class="px-6 py-4 border-b border-border flex items-center justify-between">
                        <h5 class="text-lg font-semibold text-text m-0">Add Artifact to Release</h5>
                        <button type="button"
                                class="w-8 h-8 rounded-lg text-text-muted hover:bg-border/30 transition-colors flex items-center justify-center"
                                @click="closeAddModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        {# Search and Filter Controls #}
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-4">
                            <div class="md:col-span-6">
                                <input type="text"
                                       x-model="availableSearch"
                                       class="tw-form-input"
                                       placeholder="Search artifacts by name, component, or format...">
                            </div>
                            <div class="md:col-span-3">
                                <select x-model="availableTypeFilter" class="tw-form-input">
                                    <option value="">All Types</option>
                                    <option value="sbom">SBOMs Only</option>
                                    <option value="document">Documents Only</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <select x-model="availableComponentFilter" class="tw-form-input">
                                    <option value="">All Components</option>
                                    <template x-for="comp in availableUniqueComponents" :key="comp">
                                        <option :value="comp" x-text="comp"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        {# Results Summary #}
                        <div x-show="!isLoadingAvailable"
                             class="flex flex-wrap items-center justify-between gap-3 mb-4">
                            <span class="text-text-muted text-sm">
                                Showing <span x-text="filteredAvailableArtifacts.length"></span> of <span x-text="availableArtifacts.length"></span> artifacts
                                <span x-show="selectedArtifacts.size > 0" class="text-primary font-medium">
                                    (<span x-text="selectedArtifacts.size"></span> selected)
                                </span>
                            </span>
                            <button type="button"
                                    class="tw-btn-secondary text-sm"
                                    :disabled="filteredAvailableArtifacts.length === 0"
                                    @click="allFilteredSelected ? clearSelection() : selectAllFiltered()"
                                    x-text="allFilteredSelected ? 'Deselect All' : 'Select All'"></button>
                        </div>
                        {# Loading State #}
                        <div x-show="isLoadingAvailable"
                             class="flex items-center justify-center gap-2 py-8">
                            <div class="animate-spin w-5 h-5 border-2 border-primary border-t-transparent rounded-full"></div>
                            <span class="text-text-muted">Loading artifacts...</span>
                        </div>
                        {# No Results #}
                        <div x-show="!isLoadingAvailable && availableArtifacts.length === 0"
                             class="flex flex-col items-center justify-center py-8">
                            <i class="fas fa-inbox text-3xl text-text-muted opacity-50 mb-2"></i>
                            <span class="text-text-muted">No available artifacts to add</span>
                        </div>
                        {# No Filtered Results #}
                        <div x-show="!isLoadingAvailable && availableArtifacts.length > 0 && filteredAvailableArtifacts.length === 0"
                             class="flex flex-col items-center justify-center py-8">
                            <i class="fas fa-search text-3xl text-text-muted opacity-50 mb-2"></i>
                            <span class="text-text-muted">No artifacts match your search criteria</span>
                            <button class="text-primary text-sm mt-2 hover:underline"
                                    @click="clearAvailableFilters()">Clear filters</button>
                        </div>
                        {# Artifacts Table #}
                        <div x-show="!isLoadingAvailable && filteredAvailableArtifacts.length > 0"
                             class="border border-border rounded-lg overflow-hidden">
                            <div class="max-h-[400px] overflow-y-auto">
                                <table class="w-full">
                                    <thead class="sticky top-0 bg-background z-10">
                                        <tr class="border-b border-border">
                                            <th class="px-4 py-3 text-left w-10">
                                                <input type="checkbox"
                                                       class="w-4 h-4 rounded border-border text-primary"
                                                       :checked="allFilteredSelected"
                                                       @change="toggleAllFiltered($event)">
                                            </th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase w-10">Type</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Name</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Component</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Format</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase">Version</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase w-24">Created</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-border">
                                        <template x-for="artifact in filteredAvailableArtifacts" :key="artifact.id">
                                            <tr class="cursor-pointer transition-colors"
                                                :class="isSelected(artifact.id) ? 'bg-primary/5' : 'hover:bg-background/50'"
                                                @click="toggleArtifactSelection(artifact.id)">
                                                <td class="px-4 py-3">
                                                    <input type="checkbox"
                                                           class="w-4 h-4 rounded border-border text-primary"
                                                           :checked="isSelected(artifact.id)"
                                                           @click.stop="toggleArtifactSelection(artifact.id)">
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                                                         :class="getAvailableArtifactIconClass(artifact)">
                                                        <i :class="getAvailableTypeIcon(artifact)" class="text-sm"></i>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="font-medium text-text" x-text="artifact.name"></span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="text-text" x-text="artifact.component?.name || '-'"></span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="text-text" x-text="getAvailableArtifactFormat(artifact)"></span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span x-show="artifact.version"
                                                          class="text-text"
                                                          :title="artifact.version"
                                                          x-text="truncateText(artifact.version || '', 20)"></span>
                                                    <span x-show="!artifact.version" class="text-text-muted">—</span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="text-text-muted text-sm"
                                                          x-text="formatDate(artifact.created_at)"></span>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 border-t border-border flex justify-end gap-3 bg-background/50">
                        <button type="button" class="tw-btn-secondary" @click="closeAddModal()">Cancel</button>
                        <button type="button"
                                class="tw-btn-primary flex items-center gap-2"
                                @click="addSelectedArtifacts()"
                                :disabled="selectedArtifacts.size === 0 || isSubmitting"
                                :class="{ 'opacity-75 cursor-not-allowed': selectedArtifacts.size === 0 || isSubmitting }">
                            <span x-show="isSubmitting"
                                  class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                            <span>Add <span x-text="selectedArtifacts.size"></span> Artifact<span x-show="selectedArtifacts.size !== 1">s</span></span>
                        </button>
                    </div>
                </div>
            </div>
        </template>
        {% include 'components/delete_confirmation_modal.html.j2' with modal_id='showDeleteModal' title='Remove Artifact' message='Are you sure you want to remove' item_name_expression="deleteTarget ? getArtifactName(deleteTarget) : ''" warning_message='This will only remove the artifact from this release. The original SBOM or document will not be deleted.' confirm_text='Remove' confirm_callback='confirmRemoveArtifact()' %}
    {% endif %}
</div>
