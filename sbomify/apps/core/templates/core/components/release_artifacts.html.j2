{% load static %}
<link rel="stylesheet"
      href="{% static 'css/components/release-artifacts.css' %}">
<link rel="stylesheet"
      href="{% static 'css/components/delete-modal.css' %}">
<div x-cloak
     x-data="releaseArtifacts({ releaseId: '{{ release_id }}', productId: '{{ product_id }}', initialArtifacts: [], totalCount: 0, canEdit: {{ can_edit|yesno:'true,false' }}, isLatest: {{ is_latest|default:False|yesno:'true,false' }} })"
     x-init="loadArtifacts()">
    <div class="bg-white rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <h4 class="text-lg font-semibold mb-0">
                <i class="fas fa-puzzle-piece mr-2"></i>Artifacts
            </h4>
            {% if can_edit and not is_latest %}
                <button type="button"
                        class="px-4 py-2 bg-brand-primary text-white rounded hover:opacity-90 transition-opacity"
                        @click="openAddModal()">
                    <i class="fas fa-plus mr-2"></i>Add Artifact
                </button>
            {% elif is_latest and can_edit %}
                <div class="bg-info-50 border border-info-200 text-info-800 mb-0 py-2 px-3 rounded">
                    <i class="fas fa-info-circle mr-2"></i>
                    <small>The "Latest" release is automatically managed and cannot be modified manually.</small>
                </div>
            {% endif %}
        </div>
        <div class="p-6">
            <!-- Loading State -->
            <div x-show="isLoading" class="text-center py-4">
                <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-brand-primary border-r-transparent"
                     role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2 text-gray-600">Loading artifacts...</p>
            </div>
            <!-- Empty State -->
            <div x-show="!isLoading && artifacts.length === 0"
                 class="text-center py-5 text-gray-600">
                <div class="empty-icon mb-3">
                    <i class="fas fa-puzzle-piece fa-3x opacity-25"></i>
                </div>
                <h5>No artifacts yet</h5>
                <p class="mb-3 text-gray-600">Add artifacts to this release to get started</p>
                {% if can_edit and not is_latest %}
                    <button type="button"
                            class="px-4 py-2 bg-brand-primary text-white rounded hover:opacity-90 transition-opacity"
                            @click="openAddModal()">
                        <i class="fas fa-plus mr-2"></i>Add Artifact
                    </button>
                {% elif is_latest and can_edit %}
                    <p class="mt-2 mb-0">
                        <small><i class="fas fa-info-circle mr-1"></i>Latest release is automatically managed</small>
                    </p>
                {% endif %}
            </div>
            <!-- Artifacts Table Container -->
            <div x-show="!isLoading && artifacts.length > 0"
                 class="artifacts-table-container">
                <!-- Search and Filter Controls -->
                <div class="table-controls mb-3">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
                        <div class="md:col-span-6">
                            <input type="text"
                                   x-model="search"
                                   @input.debounce="handleSearch()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                   placeholder="Search artifacts by name, component, or format...">
                        </div>
                        <div class="md:col-span-3">
                            <select x-model="typeFilter"
                                    @change="handleTypeFilter()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary">
                                <option value="">All Types</option>
                                <option value="sbom">SBOMs Only</option>
                                <option value="document">Documents Only</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <select x-model="componentFilter"
                                    @change="handleComponentFilter()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary">
                                <option value="">All Components</option>
                                <template x-for="comp in uniqueComponents" :key="comp">
                                    <option :value="comp" x-text="comp"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Results Summary -->
                <div class="flex justify-between items-center mb-3 px-3">
                    <small class="text-gray-600">
                        Showing <span x-text="filteredArtifacts.length"></span> of <span x-text="artifacts.length"></span> artifacts
                    </small>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600 mb-0">Items per page:</label>
                        <select x-model="pageSize"
                                @change="currentPage = 1"
                                class="px-2 py-1 text-sm border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary"
                                style="width: auto;
                                       padding-right: 2rem">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <!-- Artifacts Table -->
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;">Type</th>
                                <th>Name</th>
                                <th>Component</th>
                                <th>Format/Type</th>
                                <th>Version</th>
                                <th style="width: 120px;">Created</th>
                                {% if can_edit and not is_latest %}<th style="width: 80px;">Actions</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="artifact in paginatedArtifacts" :key="artifact.id">
                                <tr class="artifact-row">
                                    <td>
                                        <div class="artifact-type-icon" :class="getArtifactIconClass(artifact)">
                                            <i :class="getTypeIcon(getArtifactType(artifact))" class="fa-sm"></i>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="artifact-name-cell">
                                            <a :href="getArtifactUrl(artifact)"
                                               class="artifact-name-link font-medium"
                                               x-text="getArtifactName(artifact)"></a>
                                            <span class="artifact-type-badge ml-2"
                                                  :class="getArtifactBadgeClass(artifact)"
                                                  x-text="getArtifactType(artifact).toUpperCase()"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <a :href="getComponentUrl(artifact)"
                                           class="component-link"
                                           x-text="getArtifactComponent(artifact)"></a>
                                    </td>
                                    <td>
                                        <span class="format-text" x-text="getArtifactFormat(artifact)"></span>
                                    </td>
                                    <td>
                                        <span x-show="getArtifactVersion(artifact)"
                                              class="version-text"
                                              :title="getArtifactVersion(artifact)"
                                              x-text="truncateText(getArtifactVersion(artifact) || '', 20)"></span>
                                        <span x-show="!getArtifactVersion(artifact)" class="text-gray-600">—</span>
                                    </td>
                                    <td>
                                        <small class="text-gray-600" x-text="getArtifactDate(artifact)"></small>
                                    </td>
                                    {% if can_edit and not is_latest %}
                                        <td>
                                            <button type="button"
                                                    class="px-2 py-1 text-sm border border-danger-500 text-danger-500 rounded hover:bg-danger-500 hover:text-white transition-colors"
                                                    title="Remove from release"
                                                    @click="openDeleteModal(artifact)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    {% endif %}
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div x-show="totalPages > 1" class="mt-3 px-3 pb-3">{% include 'core/components/pagination_controls.html.j2' %}</div>
            </div>
        </div>
    </div>
    {% if can_edit and not is_latest %}
        <!-- Add Artifact Modal -->
        <template x-if="showAddModal">
            <div class="modal-backdrop"
                 style="position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 1040"
                 @click="closeAddModal()"></div>
        </template>
        <template x-if="showAddModal">
            <div class="modal d-block"
                 tabindex="-1"
                 x-trap.inert.noscroll="showAddModal"
                 role="dialog"
                 aria-modal="true"
                 aria-labelledby="add-artifact-modal-title"
                 style="position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        z-index: 1050;
                        overflow-y: auto">
                <div class="relative mx-auto my-8 w-full max-w-4xl transform overflow-hidden rounded-lg bg-white shadow-xl transition-all"
                     @click.stop>
                    <div>
                        <div class="px-6 py-4 border-b flex justify-between items-center">
                            <h5 class="text-lg font-semibold" id="add-artifact-modal-title">Add Artifact to Release</h5>
                            <button type="button"
                                    class="text-gray-400 hover:text-gray-600 focus:outline-none"
                                    @click="closeAddModal()"
                                    aria-label="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="px-6 py-4">
                            <!-- Search and Filter Controls -->
                            <div class="mb-4">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
                                    <div class="md:col-span-6">
                                        <input type="text"
                                               x-model="availableSearch"
                                               class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                                               placeholder="Search artifacts by name, component, or format...">
                                    </div>
                                    <div class="md:col-span-3">
                                        <select x-model="availableTypeFilter"
                                                class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary">
                                            <option value="">All Types</option>
                                            <option value="sbom">SBOMs Only</option>
                                            <option value="document">Documents Only</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-3">
                                        <select x-model="availableComponentFilter"
                                                class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary">
                                            <option value="">All Components</option>
                                            <template x-for="comp in availableUniqueComponents" :key="comp">
                                                <option :value="comp" x-text="comp"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Results Summary -->
                            <div x-show="!isLoadingAvailable"
                                 class="flex justify-between items-center mb-4">
                                <small class="text-gray-600">
                                    Showing <span x-text="filteredAvailableArtifacts.length"></span> of <span x-text="availableArtifacts.length"></span> artifacts
                                    <span x-show="selectedArtifacts.size > 0">
                                        (<span x-text="selectedArtifacts.size"></span> selected)
                                    </span>
                                </small>
                                <button type="button"
                                        class="px-2 py-1 text-sm border border-brand-primary text-brand-primary rounded hover:bg-brand-primary hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        :disabled="filteredAvailableArtifacts.length === 0"
                                        @click="allFilteredSelected ? clearSelection() : selectAllFiltered()"
                                        x-text="allFilteredSelected ? 'Deselect All' : 'Select All'"></button>
                            </div>
                            <!-- Loading State -->
                            <div x-show="isLoadingAvailable" class="text-center py-4">
                                <div class="inline-block h-6 w-6 animate-spin rounded-full border-4 border-solid border-brand-primary border-r-transparent"
                                     role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <span class="ml-2">Loading artifacts...</span>
                            </div>
                            <!-- No Results -->
                            <div x-show="!isLoadingAvailable && availableArtifacts.length === 0"
                                 class="text-center py-4 text-gray-600">
                                <i class="fas fa-inbox fa-2x mb-2 opacity-50"></i>
                                <div>No available artifacts to add</div>
                            </div>
                            <!-- No Filtered Results -->
                            <div x-show="!isLoadingAvailable && availableArtifacts.length > 0 && filteredAvailableArtifacts.length === 0"
                                 class="text-center py-4 text-gray-600">
                                <i class="fas fa-search fa-2x mb-2 opacity-50"></i>
                                <div>No artifacts match your search criteria</div>
                                <button class="px-2 py-1 text-sm text-brand-primary hover:underline mt-2"
                                        @click="clearAvailableFilters()">Clear filters</button>
                            </div>
                            <!-- Artifacts Table -->
                            <div x-show="!isLoadingAvailable && filteredAvailableArtifacts.length > 0"
                                 class="artifacts-table-container">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 40px;">
                                                    <input type="checkbox"
                                                           class="w-4 h-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary"
                                                           :checked="allFilteredSelected"
                                                           @change="toggleAllFiltered($event)">
                                                </th>
                                                <th style="width: 40px;">Type</th>
                                                <th>Name</th>
                                                <th>Component</th>
                                                <th>Format/Type</th>
                                                <th>Version</th>
                                                <th style="width: 100px;">Created</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="artifact in filteredAvailableArtifacts" :key="artifact.id">
                                                <tr class="artifact-table-row"
                                                    :class="{ 'table-active': isSelected(artifact.id) }"
                                                    @click="toggleArtifactSelection(artifact.id)"
                                                    style="cursor: pointer">
                                                    <td>
                                                        <input type="checkbox"
                                                               class="form-check-input"
                                                               :checked="isSelected(artifact.id)"
                                                               @click.stop="toggleArtifactSelection(artifact.id)">
                                                    </td>
                                                    <td>
                                                        <div class="artifact-type-icon"
                                                             :class="getAvailableArtifactIconClass(artifact)">
                                                            <i :class="getAvailableTypeIcon(artifact)" class="fa-sm"></i>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="artifact-name-cell">
                                                            <div class="font-medium" x-text="artifact.name"></div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="component-link" x-text="artifact.component?.name || '-'"></span>
                                                    </td>
                                                    <td>
                                                        <span class="format-text" x-text="getAvailableArtifactFormat(artifact)"></span>
                                                    </td>
                                                    <td>
                                                        <span x-show="artifact.version"
                                                              class="version-text"
                                                              :title="artifact.version"
                                                              x-text="truncateText(artifact.version || '', 20)"></span>
                                                        <span x-show="!artifact.version" class="text-muted">—</span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted" x-text="formatDate(artifact.created_at)"></small>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="px-6 py-4 border-t flex justify-end gap-2">
                            <button type="button"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors"
                                    @click="closeAddModal()">Cancel</button>
                            <button type="button"
                                    class="px-4 py-2 bg-brand-primary text-white rounded hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
                                    @click="addSelectedArtifacts()"
                                    :disabled="selectedArtifacts.size === 0 || isSubmitting">
                                <span x-show="isSubmitting"
                                      class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-white border-r-transparent mr-2"></span>
                                <span>
                                    Add&nbsp;<span x-text="selectedArtifacts.size"></span>&nbsp;Artifact<span x-show="selectedArtifacts.size !== 1">s</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        {% include 'components/delete_confirmation_modal.html.j2' with modal_id='showDeleteModal' title='Remove Artifact' message='Are you sure you want to remove' item_name_expression="deleteTarget ? getArtifactName(deleteTarget) : ''" warning_message='This will only remove the artifact from this release. The original SBOM or document will not be deleted.' confirm_text='Remove' confirm_callback='confirmRemoveArtifact()' %}
    {% endif %}
</div>
