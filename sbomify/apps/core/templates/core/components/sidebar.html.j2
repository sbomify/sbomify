{% load static %}
{% load teams %}
{# Modern Accessible Sidebar with Bootstrap 5.3 #}
<nav id="sidebar"
     class="sidebar js-sidebar"
     role="navigation"
     aria-label="Main navigation menu">
    <div class="sidebar-content js-simplebar">
        <div class="sidebar-header-row">
            <a class="sidebar-brand"
               href="{% url 'core:dashboard' %}"
               aria-label="sbomify dashboard home">
                <img src="{% static 'img/sbomify.svg' %}"
                     alt="sbomify logo"
                     class="align-middle sidebar-logo"
                     width="120"
                     height="30" />
            </a>
            {# Mobile close button #}
            <button class="sidebar-close js-sidebar-close d-lg-none"
                    type="button"
                    aria-label="Close navigation menu">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
        {% with current_view_name=request.resolver_match.namespaces.0|add:":"|add:request.resolver_match.url_name %}
            <ul class="sidebar-nav">
                {% if not request.session.current_team.has_completed_wizard %}
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="{% url 'teams:onboarding_wizard' %}">
                            <i class="align-middle fas fa-play-circle"></i>
                            <span class="align-middle">Get Started</span>
                            <span class="badge bg-primary-subtle text-primary ms-auto">New</span>
                        </a>
                    </li>
                    <li class="sidebar-header">Navigation</li>
                {% endif %}
                <li class="sidebar-item {% if current_view_name == 'core:dashboard' %}active{% endif %}">
                    <a class="sidebar-link" href="{% url 'core:dashboard' %}">
                        <i class="align-middle fas fa-tachometer-alt"></i> <span class="align-middle">Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-item {% if current_view_name == 'teams:teams_dashboard' %}active{% endif %}">
                    <a class="sidebar-link" href="{% url 'teams:teams_dashboard' %}">
                        <i class="align-middle fas fa-users"></i> <span class="align-middle">Workspace</span>
                    </a>
                </li>
                <li class="sidebar-item {% if 'core:product' in current_view_name %}active{% endif %}">
                    <a class="sidebar-link" href="{% url 'core:products_dashboard' %}">
                        <i class="align-middle fas fa-cube"></i> <span class="align-middle">Products</span>
                    </a>
                </li>
                <li class="sidebar-item {% if 'core:project' in current_view_name %}active{% endif %}">
                    <a class="sidebar-link" href="{% url 'core:projects_dashboard' %}">
                        <i class="align-middle fas fa-folder"></i> <span class="align-middle">Projects</span>
                    </a>
                </li>
                <li class="sidebar-item {% if 'core:component' in current_view_name %}active{% endif %}">
                    <a class="sidebar-link" href="{% url 'core:components_dashboard' %}">
                        <i class="align-middle fas fa-puzzle-piece"></i> <span class="align-middle">Components</span>
                    </a>
                </li>
                <li class="sidebar-item {% if 'core:release' in current_view_name %}active{% endif %}">
                    <a class="sidebar-link" href="{% url 'core:releases_dashboard' %}">
                        <i class="align-middle fas fa-tag"></i> <span class="align-middle">Releases</span>
                    </a>
                </li>
                {% if request.session.current_team and request.session.current_team.key %}
                    <li class="sidebar-item {% if 'teams:team_settings' in current_view_name %}active{% endif %}">
                        <a class="sidebar-link"
                           href="{% url 'teams:team_settings' team_key=request.session.current_team.key %}">
                            <i class="align-middle fas fa-cog"></i> <span class="align-middle">Settings</span>
                        </a>
                    </li>
                {% endif %}
                {# Current Workspace Switcher at the bottom #}
                {% load teams %}
                {% user_workspaces as available_workspaces %}
                {% url 'teams:teams_dashboard' as teams_dashboard_url %}
                {% with sidebar_team=request.session.current_team %}
                    {% if sidebar_team and current_workspace_key %}
                        <li class="sidebar-item sidebar-current-workspace"
                            x-data="workspaceSwitcher()"
                            data-current-workspace="{{ current_workspace_key }}"
                            data-current-view="{{ current_view_name }}"
                            data-switch-url="/workspaces/switch/"
                            data-teams-dashboard-url="{{ teams_dashboard_url }}"
                            @keydown.escape.window="closeModal()"
                            @keydown="handleKeydown($event)"
                            role="region"
                            aria-label="Workspace switcher">
                            {# Compact Workspace Button #}
                            <button type="button"
                                    class="sidebar-workspace-trigger"
                                    @click="toggleModal()"
                                    aria-label="Switch workspace"
                                    aria-haspopup="dialog"
                                    :aria-expanded="open">
                                <span class="workspace-avatar workspace-avatar-{{ sidebar_team.name|avatar_color_index }}">
                                    {{ sidebar_team.name|workspace_initials }}
                                </span>
                                <span class="workspace-trigger-name">{{ sidebar_team.name|workspace_display }}</span>
                                <i class="fas fa-chevron-right workspace-trigger-chevron"
                                   aria-hidden="true"></i>
                            </button>
                            {# Workspace Switcher Modal #}
                            <div class="workspace-modal-backdrop"
                                 x-show="open"
                                 x-cloak
                                 x-transition:enter="fade-enter"
                                 x-transition:enter-start="fade-enter-start"
                                 x-transition:enter-end="fade-enter-end"
                                 x-transition:leave="fade-leave"
                                 x-transition:leave-start="fade-leave-start"
                                 x-transition:leave-end="fade-leave-end"
                                 @click.self="closeModal()"
                                 role="dialog"
                                 aria-modal="true"
                                 aria-labelledby="workspace-modal-title"
                                 :aria-hidden="!open">
                                <div class="workspace-modal" @click.stop>
                                    <div class="workspace-modal-header">
                                        <div class="workspace-modal-title-wrapper">
                                            <h5 class="workspace-modal-title" id="workspace-modal-title">Select Workspace</h5>
                                            <button type="button"
                                                    class="workspace-modal-help"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top"
                                                    title="Switch between your workspaces"
                                                    aria-label="Help">
                                                <i class="fas fa-question-circle"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="workspace-modal-search">
                                        <i class="fas fa-search" aria-hidden="true"></i>
                                        <input type="text"
                                               x-model="search"
                                               @input="debouncedSearch()"
                                               placeholder="Search Workspaces"
                                               class="workspace-search-input"
                                               aria-label="Search workspaces"
                                               aria-describedby="workspace-search-help">
                                        <span id="workspace-search-help" class="visually-hidden">Type to filter workspaces. Use arrow keys to navigate, Enter to select.</span>
                                    </div>
                                    <div class="workspace-modal-list"
                                         role="listbox"
                                         aria-label="Available workspaces">
                                        {% if available_workspaces %}
                                            {% for t_key, t_info in available_workspaces.items %}
                                                {% if t_key and t_info.name %}
                                                    <label class="workspace-option"
                                                           data-workspace-key="{{ t_key }}"
                                                           x-show="isVisible('{{ t_info.name|escapejs }}')"
                                                           :class="{ 'workspace-option-selected': selected === '{{ t_key|escapejs }}', 'workspace-option-active': currentWorkspace === '{{ t_key|escapejs }}' }"
                                                           @click="selected = '{{ t_key|escapejs }}'"
                                                           role="option"
                                                           :aria-selected="selected === '{{ t_key|escapejs }}'">
                                                        <input type="radio"
                                                               name="workspace"
                                                               value="{{ t_key }}"
                                                               x-model="selected"
                                                               {% if current_workspace_key == t_key %}checked{% endif %}
                                                               class="visually-hidden"
                                                               :aria-checked="selected === '{{ t_key|escapejs }}'">
                                                        <span class="workspace-avatar workspace-avatar-{{ t_info.name|avatar_color_index }}">
                                                            {{ t_info.name|workspace_initials }}
                                                        </span>
                                                        <span class="workspace-option-name">{{ t_info.name|workspace_display }}</span>
                                                        <i class="fas fa-check workspace-option-check"
                                                           x-show="selected === '{{ t_key|escapejs }}'"
                                                           aria-hidden="true"></i>
                                                    </label>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <div class="workspace-empty-state" role="status" aria-live="polite">
                                                <p class="text-muted text-center py-4">No workspaces available</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="workspace-modal-footer">
                                        <button type="button"
                                                class="btn btn-outline-primary workspace-btn-new"
                                                @click="openNewWorkspaceModal()"
                                                :disabled="isSwitching">New Workspace</button>
                                        <div class="workspace-modal-actions">
                                            <button type="button"
                                                    class="btn btn-link workspace-btn-cancel"
                                                    @click="closeModal()"
                                                    :disabled="isSwitching">Cancel</button>
                                            <button type="button"
                                                    class="btn btn-primary workspace-btn-switch"
                                                    @click="switchWorkspace()"
                                                    :disabled="selected === currentWorkspace || isSwitching"
                                                    aria-label="Switch to selected workspace">
                                                <span x-show="!isSwitching">Switch</span>
                                                <span x-show="isSwitching"
                                                      class="spinner-border spinner-border-sm"
                                                      role="status"
                                                      aria-hidden="true"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    {% endif %}
                {% endwith %}
            </ul>
        {% endwith %}
    </div>
</nav>
