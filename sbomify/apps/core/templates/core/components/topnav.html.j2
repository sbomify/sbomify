{# Modern Tailwind CSS Navigation with Enhanced Accessibility #}
<nav class="bg-white shadow-sm flex flex-nowrap items-center justify-between px-2 sm:px-4 py-2 gap-2 min-w-0"
     x-data
     role="navigation"
     aria-label="Main navigation">
    {# Mobile Sidebar Toggle #}
    <button class="sidebar-toggle js-sidebar-toggle lg:hidden relative z-10 pointer-events-auto"
            type="button"
            @click="$store.sidebar.toggle()"
            aria-controls="sidebar"
            :aria-expanded="$store.sidebar.open"
            :aria-label="$store.sidebar.open ? 'Close navigation menu' : 'Open navigation menu'">
        <span class="hamburger pointer-events-none" aria-hidden="true"></span>
    </button>
    {# Search Bar #}
    <div class="navbar-search flex-1 min-w-0 max-w-xs sm:max-w-md"
         x-cloak
         x-data="navbarSearch()"
         @click.away="handleClickAway()">
        <div class="search-input-wrapper">
            <i class="fas fa-search search-icon" aria-hidden="true"></i>
            <input type="search"
                   id="navbar-search-input"
                   x-ref="input"
                   class="search-input"
                   x-model="query"
                   @input="debounceSearch()"
                   @focus="handleFocus()"
                   @blur="handleBlur()"
                   @keydown="handleKeydown($event)"
                   placeholder="Search products, projects, components..."
                   aria-label="Search"
                   autocomplete="off">
            <div id="search-results-dropdown"
                 x-ref="dropdown"
                 class="search-results-dropdown"
                 x-show="showDropdown"
                 x-cloak>
                <template x-if="loading">
                    <div class="search-results-loading text-center py-3">
                        <div class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-brand-primary border-r-transparent"
                             role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </template>
                <template x-if="!loading && results && (results.products.length > 0 || results.projects.length > 0 || results.components.length > 0)">
                    <div class="search-results-content">
                        <template x-if="results.products.length > 0">
                            <div class="search-results-section">
                                <div class="search-results-section-header">
                                    <i class="fas fa-cube me-2"></i>
                                    <span>Products</span>
                                    <span class="search-results-count" x-text="results.products.length"></span>
                                </div>
                                <div class="search-results-list">
                                    <template x-for="item in results.products" :key="item.id">
                                        <a :href="getItemUrl('product', item.id)" class="search-result-item">
                                            <div class="search-result-item-content">
                                                <div class="search-result-item-name" x-text="item.name"></div>
                                                <template x-if="item.description">
                                                    <div class="search-result-item-description"
                                                         x-text="formatDescription(item.description)"></div>
                                                </template>
                                            </div>
                                            <i class="fas fa-chevron-right search-result-item-arrow"></i>
                                        </a>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <template x-if="results.projects.length > 0">
                            <div class="search-results-section">
                                <div class="search-results-section-header">
                                    <i class="fas fa-folder me-2"></i>
                                    <span>Projects</span>
                                    <span class="search-results-count" x-text="results.projects.length"></span>
                                </div>
                                <div class="search-results-list">
                                    <template x-for="item in results.projects" :key="item.id">
                                        <a :href="getItemUrl('project', item.id)" class="search-result-item">
                                            <div class="search-result-item-content">
                                                <div class="search-result-item-name" x-text="item.name"></div>
                                                <template x-if="item.description">
                                                    <div class="search-result-item-description"
                                                         x-text="formatDescription(item.description)"></div>
                                                </template>
                                            </div>
                                            <i class="fas fa-chevron-right search-result-item-arrow"></i>
                                        </a>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <template x-if="results.components.length > 0">
                            <div class="search-results-section">
                                <div class="search-results-section-header">
                                    <i class="fas fa-puzzle-piece me-2"></i>
                                    <span>Components</span>
                                    <span class="search-results-count" x-text="results.components.length"></span>
                                </div>
                                <div class="search-results-list">
                                    <template x-for="item in results.components" :key="item.id">
                                        <a :href="getItemUrl('component', item.id)" class="search-result-item">
                                            <div class="search-result-item-content">
                                                <div class="search-result-item-name" x-text="item.name"></div>
                                                <template x-if="item.description">
                                                    <div class="search-result-item-description"
                                                         x-text="formatDescription(item.description)"></div>
                                                </template>
                                            </div>
                                            <i class="fas fa-chevron-right search-result-item-arrow"></i>
                                        </a>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                <template x-if="!loading && query.length >= 2 && results && results.products.length === 0 && results.projects.length === 0 && results.components.length === 0">
                    <div class="search-results-empty">
                        <p class="text-gray-600 mb-0" x-text="`No results found for \" query " "></p> </div> </template> <template x-if="!loading && results === null && query.length>= 2">
                        <div class="search-results-empty">
                            <p class="text-danger-500 mb-0">Error performing search. Please try again.</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        {# Spacer to push actions to the right #}
        <div class="flex-grow min-w-0"></div>
        {# Action Buttons #}
        <div class="navbar-actions flex flex-nowrap items-center gap-1 sm:gap-2 flex-shrink-0">
            {# New Button Dropdown #}
            <div class="dropdown" x-data="dropdown" @click.away="close()">
                <button type="button"
                        class="btn-new dropdown-toggle flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 sm:py-2 text-sm whitespace-nowrap"
                        id="newItemDropdown"
                        @click="toggle()"
                        :aria-expanded="isOpen"
                        aria-label="Create new item">
                    <i class="fas fa-plus" aria-hidden="true"></i>
                    <span class="hidden sm:inline">New</span>
                </button>
                <ul class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-dropdown new-item-dropdown"
                    x-show="isOpen"
                    @keydown.escape.window="close()"
                    aria-labelledby="newItemDropdown">
                    <li>
                        <a class="block px-4 py-2 text-sm text-black hover:bg-gray-100"
                           href="#"
                           @click.prevent="close(); $dispatch('open-modal', { id: 'newProductModal' })">
                            <i class="fas fa-cube mr-2"></i>
                            <span>Product</span>
                        </a>
                    </li>
                    <li>
                        <a class="block px-4 py-2 text-sm text-black hover:bg-gray-100"
                           href="#"
                           @click.prevent="close(); $dispatch('open-modal', { id: 'newProjectModal' })">
                            <i class="fas fa-folder mr-2"></i>
                            <span>Project</span>
                        </a>
                    </li>
                    <li>
                        <a class="block px-4 py-2 text-sm text-black hover:bg-gray-100"
                           href="#"
                           @click.prevent="close(); $dispatch('open-modal', { id: 'newComponentModal' })">
                            <i class="fas fa-puzzle-piece mr-2"></i>
                            <span>Component</span>
                        </a>
                    </li>
                </ul>
            </div>
            {# Notifications #}
            <button type="button"
                    class="btn btn-icon btn-notifications relative flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 p-0 flex items-center justify-center"
                    aria-label="Notifications"
                    @click="$dispatch('open-modal', { id: 'notificationsModal' })"
                    aria-expanded="false"
                    aria-haspopup="true">
                <i class="fas fa-bell text-sm sm:text-base" aria-hidden="true"></i>
                <span id="notifications-badge"
                      class="absolute inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform-none rounded-full bg-danger-500 notification-badge"
                      style="display: none;
                             top: 0.125rem;
                             right: 0.125rem">
                    <span class="notifications-count">0</span>
                    <span class="sr-only">unread notifications</span>
                </span>
            </button>
            {# Help/Support Dropdown #}
            <div class="dropdown" x-data="dropdown" @click.away="close()">
                <button type="button"
                        class="btn btn-icon btn-help dropdown-toggle flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 p-0 flex items-center justify-center"
                        id="helpDropdown"
                        @click="toggle()"
                        :aria-expanded="isOpen"
                        aria-label="Help and support">
                    <i class="fas fa-question-circle text-sm sm:text-base"
                       aria-hidden="true"></i>
                </button>
                <ul class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-dropdown help-dropdown"
                    x-show="isOpen"
                    @keydown.escape.window="close()"
                    aria-labelledby="helpDropdown">
                    <li>
                        <a class="block px-4 py-2 text-sm text-black hover:bg-gray-100"
                           href="{% url 'core:support_contact' %}"
                           @click="close()">
                            <i class="fas fa-envelope mr-2"></i>
                            <span>Contact Support</span>
                        </a>
                    </li>
                    <li>
                        <a class="block px-4 py-2 text-sm text-black hover:bg-gray-100"
                           href="https://sbomify.com/"
                           target="_blank"
                           rel="noopener noreferrer"
                           @click="close()">
                            <i class="fas fa-book mr-2"></i>
                            <span>Getting Started</span>
                            <i class="fas fa-external-link-alt ml-2 text-xs" aria-hidden="true"></i>
                        </a>
                    </li>
                </ul>
            </div>
            {# User Dropdown #}
            <div class="navbar-user-dropdown flex-shrink-0">{% include "core/user-dropdown.html.j2" %}</div>
        </div>
    </nav>
    {# Notifications Modal - Slides from left #}
    <div class="modal fade notifications-modal"
         id="notificationsModal"
         x-data="notificationsModal()"
         x-show="open"
         :class="{ 'show': open }"
         x-trap.inert.noscroll="open"
         x-effect="open; handleOpenChange()"
         @keydown.escape.window="open = false"
         @open-modal.window="if ($event.detail.id === 'notificationsModal') open = true"
         tabindex="-1"
         aria-labelledby="notificationsModalLabel"
         aria-hidden="true"
         x-cloak>
        {# Backdrop overlay - closes modal when clicked #}
        <div class="notifications-modal-backdrop"
             x-show="open"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="open = false"></div>
        <div class="modal-dialog modal-dialog-slide-left"
             x-ref="dialog"
             @click.stop>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationsModalLabel">Notifications</h5>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button"
                                class="btn btn-link text-muted p-0"
                                @click="clearAll()"
                                x-show="notifications.filter(n => n.type !== 'community_upgrade').length > 0"
                                x-cloak>Clear all</button>
                        <button type="button"
                                class="btn-close"
                                @click="open = false"
                                aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div x-show="loading" class="text-center py-4" x-cloak>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <template x-if="error">
                        <div class="text-center py-4">
                            <p class="text-danger mb-0" x-text="error"></p>
                        </div>
                    </template>
                    <div x-show="!loading && !error && notifications.length > 0"
                         class="notifications-list"
                         x-cloak>
                        <template x-for="notification in notifications" :key="notification.id">
                            <div class="notification-item"
                                 :class="getSeverityBgColor(notification.severity)"
                                 :data-notification-id="notification.id">
                                <div class="notification-item-content">
                                    <div class="notification-icon">
                                        <i :class="getSeverityIcon(notification.severity)"></i>
                                    </div>
                                    <div class="notification-text">
                                        <p class="notification-message mb-1" x-text="notification.message"></p>
                                        <small class="notification-time text-muted"
                                               x-text="formatDate(notification.created_at)"></small>
                                    </div>
                                </div>
                                <template x-if="notification.action_url">
                                    <a :href="notification.action_url"
                                       class="notification-action-link"
                                       x-text=" notification.type === 'access_request_pending' ? 'Review' : (notification.type === 'community_upgrade' || notification.type.includes('billing')) ? 'Upgrade' : (notification.type.includes('payment') || notification.type.includes('billing')) ? 'Fix' : 'View' "></a>
                                </template>
                            </div>
                        </template>
                    </div>
                    <div x-show="!loading && !error && notifications.length === 0"
                         class="text-center py-5"
                         x-cloak>
                        <i class="fas fa-bell-slash text-muted mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-0">No notifications</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
