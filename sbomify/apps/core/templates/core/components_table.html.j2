{# Serialize components data for Alpine.js #}
{{ components|json_script:"components-data" }}
{# WebSocket listener for real-time updates #}
<div id="components-table-container"
     x-data="{ search: '', typeFilter: 'all', visibilityFilter: 'all', sortColumn: 'name', sortDirection: 'asc', currentPage: 1, perPage: 10, allComponents: [], init() { this.allComponents = window.parseJsonScript('components-data') || []; }, get filteredData() { let data = [...this.allComponents]; if (this.search) { const s = this.search.toLowerCase(); data = data.filter(item => item.name.toLowerCase().includes(s) ); } if (this.typeFilter !== 'all') { data = data.filter(item => item.component_type === this.typeFilter); } if (this.visibilityFilter === 'public') { data = data.filter(item => item.visibility === 'public'); } else if (this.visibilityFilter === 'gated') { data = data.filter(item => item.visibility === 'gated'); } else if (this.visibilityFilter === 'private') { data = data.filter(item => item.visibility === 'private'); } return data; }, get sortedData() { return [...this.filteredData].sort((a, b) => { let aVal = a[this.sortColumn]; let bVal = b[this.sortColumn]; if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = bVal.toLowerCase(); } if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1; if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1; return 0; }); }, get paginatedData() { const start = (this.currentPage - 1) * this.perPage; return this.sortedData.slice(start, start + this.perPage); }, get totalPages() { return Math.ceil(this.filteredData.length / this.perPage); }, get startIndex() { return this.filteredData.length > 0 ? (this.currentPage - 1) * this.perPage + 1 : 0; }, get endIndex() { return Math.min(this.currentPage * this.perPage, this.filteredData.length); }, sort(column) { if (this.sortColumn === column) { this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc'; } else { this.sortColumn = column; this.sortDirection = 'asc'; } }, goToPage(page) { if (page >= 1 && page <= this.totalPages) { this.currentPage = page; } }, get visiblePages() { const pages = []; const total = this.totalPages; const current = this.currentPage; if (total <= 7) { for (let i = 1; i <= total; i++) pages.push(i); } else { pages.push(1); if (current > 3) pages.push('...'); for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) { pages.push(i); } if (current < total - 2) pages.push('...'); pages.push(total); } return pages; }, getTypeDisplay(type) { return type === 'sbom' ? 'SBOM' : type === 'document' ? 'Document' : 'Unknown'; }, getContentDisplay(component) { if (component.component_type === 'sbom') { const count = component.sbom_count || 0; return count + ' SBOM' + (count !== 1 ? 's' : ''); } else if (component.component_type === 'document') { return 'Document'; } return '-'; } }"
     x-init="init(); $watch('search', () => currentPage = 1); $watch('typeFilter', () => currentPage = 1); $watch('visibilityFilter', () => currentPage = 1); $watch('perPage', () => currentPage = 1)"
     hx-get="{% url 'core:components_table' %}"
     hx-trigger="refresh-components from:body"
     hx-swap="outerHTML"
     @ws:message.window="if (['sbom_uploaded', 'sbom_deleted', 'document_uploaded', 'document_deleted', 'component_created', 'component_deleted'].includes($event.detail.type)) { document.body.dispatchEvent(new CustomEvent('refresh-components')); }">
    <div class="tw-dashboard-card">
        <div class="tw-card-header">
            <h3 class="text-lg font-semibold text-text">All Components</h3>
        </div>
        <div class="tw-card-body p-0">
            {% if components %}
                <div class="tw-data-table">
                    <div class="tw-data-table-toolbar">
                        <div class="tw-data-table-toolbar-left">
                            <div class="tw-data-table-search">
                                <i class="fas fa-search tw-data-table-search-icon"></i>
                                <input type="text"
                                       x-model="search"
                                       placeholder="Search components..."
                                       class="tw-data-table-search-input">
                            </div>
                            {# Type Filter #}
                            <select x-model="typeFilter" class="tw-data-table-page-size-select">
                                <option value="all">All Types</option>
                                <option value="sbom">SBOM</option>
                                <option value="document">Document</option>
                            </select>
                            {# Visibility Filter #}
                            <select x-model="visibilityFilter" class="tw-data-table-page-size-select">
                                <option value="all">All</option>
                                <option value="public">Public</option>
                                <option value="gated">Gated</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                        <div class="tw-data-table-toolbar-right">
                            <div class="tw-data-table-page-size">
                                <span>Show</span>
                                <select x-model.number="perPage" class="tw-data-table-page-size-select">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <span>entries</span>
                            </div>
                        </div>
                    </div>
                    <div class="tw-data-table-container">
                        <table class="tw-table">
                            <thead>
                                <tr>
                                    <th>
                                        <span class="tw-table-sortable"
                                              :class="{ 'sorted-asc': sortColumn === 'name' && sortDirection === 'asc', 'sorted-desc': sortColumn === 'name' && sortDirection === 'desc' }"
                                              @click="sort('name')">
                                            Component
                                            <span class="tw-table-sort-icon">
                                                <i class="fas fa-caret-up"></i>
                                                <i class="fas fa-caret-down"></i>
                                            </span>
                                        </span>
                                    </th>
                                    <th class="hidden md:table-cell">
                                        <span class="tw-table-sortable"
                                              :class="{ 'sorted-asc': sortColumn === 'component_type' && sortDirection === 'asc', 'sorted-desc': sortColumn === 'component_type' && sortDirection === 'desc' }"
                                              @click="sort('component_type')">
                                            Type
                                            <span class="tw-table-sort-icon">
                                                <i class="fas fa-caret-up"></i>
                                                <i class="fas fa-caret-down"></i>
                                            </span>
                                        </span>
                                    </th>
                                    <th class="hidden lg:table-cell">
                                        <span class="tw-table-sortable"
                                              :class="{ 'sorted-asc': sortColumn === 'is_global' && sortDirection === 'asc', 'sorted-desc': sortColumn === 'is_global' && sortDirection === 'desc' }"
                                              @click="sort('is_global')">
                                            Scope
                                            <span class="tw-table-sort-icon">
                                                <i class="fas fa-caret-up"></i>
                                                <i class="fas fa-caret-down"></i>
                                            </span>
                                        </span>
                                    </th>
                                    <th class="hidden lg:table-cell">
                                        <span class="tw-table-sortable"
                                              :class="{ 'sorted-asc': sortColumn === 'sbom_count' && sortDirection === 'asc', 'sorted-desc': sortColumn === 'sbom_count' && sortDirection === 'desc' }"
                                              @click="sort('sbom_count')">
                                            Content
                                            <span class="tw-table-sort-icon">
                                                <i class="fas fa-caret-up"></i>
                                                <i class="fas fa-caret-down"></i>
                                            </span>
                                        </span>
                                    </th>
                                    <th>
                                        <span class="tw-table-sortable"
                                              :class="{ 'sorted-asc': sortColumn === 'visibility' && sortDirection === 'asc', 'sorted-desc': sortColumn === 'visibility' && sortDirection === 'desc' }"
                                              @click="sort('visibility')">
                                            Visibility
                                            <span class="tw-table-sort-icon">
                                                <i class="fas fa-caret-up"></i>
                                                <i class="fas fa-caret-down"></i>
                                            </span>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="component in paginatedData" :key="component.id">
                                    <tr class="cursor-pointer"
                                        @click="window.location.href = '{% url 'core:component_details' 0 %}'.replace('0', component.id)">
                                        <td>
                                            <div class="min-w-0">
                                                <span class="text-text font-medium block truncate" x-text="component.name"></span>
                                                {# Mobile: Show type #}
                                                <div class="md:hidden mt-1">
                                                    <span class="text-xs text-text-muted"
                                                          x-text="getTypeDisplay(component.component_type)"></span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="hidden md:table-cell">
                                            <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-lg border bg-border/20 text-text-muted border-border/40"
                                                  x-text="getTypeDisplay(component.component_type)"></span>
                                        </td>
                                        <td class="hidden lg:table-cell">
                                            <template x-if="component.is_global">
                                                <span class="tw-badge-primary">Workspace</span>
                                            </template>
                                            <template x-if="!component.is_global">
                                                <span class="tw-badge-secondary">Project</span>
                                            </template>
                                        </td>
                                        <td class="hidden lg:table-cell">
                                            <span class="text-text text-sm" x-text="getContentDisplay(component)"></span>
                                        </td>
                                        <td>
                                            <template x-if="component.visibility === 'public'">
                                                <span class="tw-badge-success">
                                                    <i class="fas fa-globe text-[10px] mr-1"></i>
                                                    Public
                                                </span>
                                            </template>
                                            <template x-if="component.visibility === 'gated'">
                                                <span class="tw-badge-warning">
                                                    <i class="fas fa-key text-[10px] mr-1"></i>
                                                    Gated
                                                </span>
                                            </template>
                                            <template x-if="component.visibility === 'private'">
                                                <span class="tw-badge-info">
                                                    <i class="fas fa-lock text-[10px] mr-1"></i>
                                                    Private
                                                </span>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                                <template x-if="paginatedData.length === 0">
                                    <tr>
                                        <td colspan="5" class="text-center py-8 text-text-muted">
                                            <i class="fas fa-search text-2xl mb-2 opacity-50"></i>
                                            <p>No components match your search</p>
                                            <button @click="search = ''; typeFilter = 'all'; visibilityFilter = 'all'"
                                                    class="mt-3 text-xs text-primary hover:underline">
                                                Clear filters
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div class="tw-data-table-footer">
                        <div class="tw-data-table-info">
                            Showing <strong x-text="startIndex"></strong> to <strong x-text="endIndex"></strong> of <strong x-text="filteredData.length"></strong> entries
                            <template x-if="search || typeFilter !== 'all' || visibilityFilter !== 'all'">
                                <span>(filtered from <strong x-text="allComponents.length"></strong> total)</span>
                            </template>
                        </div>
                        <nav class="tw-pagination" x-show="totalPages > 1">
                            <button class="tw-pagination-btn tw-pagination-btn-nav"
                                    :disabled="currentPage === 1"
                                    @click="goToPage(currentPage - 1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <template x-for="page in visiblePages" :key="page">
                                <template x-if="page === '...'">
                                    <span class="tw-pagination-ellipsis">...</span>
                                </template>
                                <template x-if="page !== '...'">
                                    <button class="tw-pagination-btn"
                                            :class="{ 'tw-pagination-btn-active': currentPage === page }"
                                            @click="goToPage(page)"
                                            x-text="page"></button>
                                </template>
                            </template>
                            <button class="tw-pagination-btn tw-pagination-btn-nav"
                                    :disabled="currentPage === totalPages"
                                    @click="goToPage(currentPage + 1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </nav>
                    </div>
                </div>
            {% else %}
                {# Empty State #}
                <div class="flex flex-col items-center justify-center py-16 px-6">
                    <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-primary/10 to-primary/5 flex items-center justify-center mb-6">
                        <i class="fas fa-puzzle-piece text-3xl text-primary"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-text mb-2">No components yet</h3>
                    <p class="text-text-muted text-sm text-center max-w-sm mb-6">
                        Components are containers for your SBOMs and documents. Create one to start uploading content.
                    </p>
                    {% if has_crud_permissions %}
                        <button @click="$dispatch('open-add-component-modal')" class="tw-btn-primary">
                            <i class="fas fa-plus mr-2"></i>Create Your First Component
                        </button>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
