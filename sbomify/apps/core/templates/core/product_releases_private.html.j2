{% extends "core/dashboard_base.htmx.j2" %}
{% load static %}
{% load django_vite %}
{% load breadcrumb_tags %}
{% block title %}sbomify Product: {{ product.name }} - Releases{% endblock %}
{% block extra_styles %}
    <link rel="stylesheet"
          href="{% static 'css/product-releases-private.css' %}">
{% endblock %}
{% block breadcrumb %}
    {% breadcrumb releases 'releases' %}
{% endblock %}
{% block content %}
    <div class="mb-6">
        <div class="mb-4">
            <div class="flex justify-between items-start flex-wrap gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-text">Releases</h1>
                    <p class="text-text-muted mt-1">Manage releases for {{ product.name }}</p>
                </div>
                {% if product.has_crud_permissions %}
                    <div>
                        <button type="button"
                                class="tw-btn-primary"
                                @click="$dispatch('open-createReleaseModal')">
                            <i class="fas fa-plus mr-2"></i>Create Release
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span class="flex items-center gap-2 text-sm text-text-muted">
                <i class="fas fa-tag text-primary"></i>
                <span>{{ releases|length }} Release{{ releases|length|pluralize }}</span>
            </span>
        </div>
    </div>
    <div>
        {% include 'core/components/product_releases.html.j2' with product_id=product.id is_public_view=False can_create=product.has_crud_permissions can_edit=product.has_crud_permissions can_delete=product.has_crud_permissions %}
    </div>
    {% if product.has_crud_permissions %}
        <div x-data="{ open: false }"
             @open-createReleaseModal.window="open = true"
             @keydown.escape.window="if(open) open = false">
            <div x-show="open"
                 x-cloak
                 class="fixed inset-0 z-[1055] overflow-y-auto"
                 id="createReleaseModal"
                 role="dialog"
                 aria-modal="true"
                 aria-labelledby="createReleaseModalLabel">
                {# Backdrop #}
                <div x-show="open"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="fixed inset-0 bg-black/60 backdrop-blur-sm"
                     @click="open = false"></div>
                {# Modal Content #}
                <div class="fixed inset-0 flex items-center justify-center p-4">
                    <div x-show="open"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         @click.stop
                         x-trap.noscroll="open"
                         class="relative w-full max-w-lg bg-surface border border-border rounded-xl shadow-2xl">
                        <form id="createReleaseForm"
                              method="post"
                              action="{% url 'core:product_releases' product.id %}">
                            {% csrf_token %}
                            <div class="flex items-center justify-between px-6 py-4 border-b border-border">
                                <h5 class="text-lg font-semibold text-text m-0"
                                    id="createReleaseModalLabel">Create New Release</h5>
                                <button type="button"
                                        @click="open = false"
                                        class="p-2 rounded-lg text-text-muted hover:text-text hover:bg-border/50 transition-colors"
                                        aria-label="Close">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="p-6">
                                <div class="mb-4">
                                    <label for="releaseName" class="block text-sm font-medium text-text mb-1">Release Name</label>
                                    <input type="text"
                                           class="w-full px-3 py-2 border border-border rounded-lg bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
                                           id="releaseName"
                                           name="name"
                                           required
                                           placeholder="e.g., v1.0.0, 2024.1, beta-3">
                                    <div class="text-xs text-text-muted mt-1">Enter a unique name for this release</div>
                                </div>
                                <div class="mb-4">
                                    <label for="releaseDescription"
                                           class="block text-sm font-medium text-text mb-1">
                                        Description (Optional)
                                    </label>
                                    <textarea class="w-full px-3 py-2 border border-border rounded-lg bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
                                              id="releaseDescription"
                                              name="description"
                                              rows="3"
                                              placeholder="Describe what's included in this release..."></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="releaseCreatedAt"
                                           class="block text-sm font-medium text-text mb-1">Created Date</label>
                                    <input type="datetime-local"
                                           class="w-full px-3 py-2 border border-border rounded-lg bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
                                           id="releaseCreatedAt"
                                           name="created_at"
                                           placeholder="Select created date and time"
                                           value="{{ default_release_datetime|date:'Y-m-d\\TH:i' }}">
                                    <div class="text-xs text-text-muted mt-1">Defaults to when you create the release.</div>
                                </div>
                                <div class="mb-4">
                                    <label for="releaseDate" class="block text-sm font-medium text-text mb-1">Release Date</label>
                                    <input type="datetime-local"
                                           class="w-full px-3 py-2 border border-border rounded-lg bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
                                           id="releaseDate"
                                           name="released_at"
                                           placeholder="Select release date and time"
                                           value="{{ default_release_datetime|date:'Y-m-d\\TH:i' }}">
                                    <div class="text-xs text-text-muted mt-1">This date determines when the release is shown as available</div>
                                </div>
                                <div class="mb-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox"
                                               class="w-4 h-4 rounded border-border text-primary focus:ring-primary"
                                               id="releaseIsPrerelease"
                                               name="is_prerelease">
                                        <span class="text-sm text-text">Mark as pre-release</span>
                                    </label>
                                    <div class="text-xs text-text-muted mt-1 ml-6">
                                        Pre-releases are typically alpha, beta, or release candidate versions
                                    </div>
                                </div>
                            </div>
                            <div class="px-6 py-4 border-t border-border flex justify-end gap-2">
                                <button type="button" class="tw-btn-secondary" @click="open = false">Cancel</button>
                                <button type="submit" class="tw-btn-primary">Create Release</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block scripts %}
    {% vite_asset 'sbomify/apps/core/js/main.ts' %}
{% endblock %}
