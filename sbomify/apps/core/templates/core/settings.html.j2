{% extends "core/dashboard_base.htmx.j2" %}
{% load widget_tweaks %}
{% load form_helpers %}
{% load django_vite %}
{% block title %}sbomify Settings{% endblock %}
{% block content %}
    <div class="p-6">
        {% if pending_invitations %}
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-success/10 flex items-center justify-center">
                        <i class="fas fa-envelope-open-text text-success text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-text">Pending Workspace Invitations</h1>
                        <p class="text-text-muted text-sm">You have been invited to join the following workspaces. Accept or decline below.</p>
                    </div>
                </div>
                {% include "core/components/pending_invitations.html.j2" %}
            </div>
        {% endif %}
        {# Page Header #}
        <div class="mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-key text-primary text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-text">Personal Access Tokens</h1>
                    <p class="text-text-muted text-sm">
                        Personal access tokens are used to authenticate API requests to sbomify. Use these tokens to access the API programmatically.
                    </p>
                </div>
            </div>
        </div>
        {# Token Generation Card #}
        <div class="tw-card mb-6">
            <div class="px-6 py-4 border-b border-border">
                <h4 class="text-lg font-semibold text-text m-0">Generate New Token</h4>
            </div>
            <div class="p-6">
                <form method="post" id="tokenGenerationForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        {% for field in create_access_token_form %}
                            <label class="block text-sm font-medium text-text mb-1"
                                   for="{{ field.id_for_label }}">{{ field.label }}</label>
                            <input type="text"
                                   id="{{ field.id_for_label }}"
                                   name="{{ field.html_name }}"
                                   class="tw-form-input max-w-md"
                                   placeholder="e.g., CI/CD Pipeline Token"
                                   value="{{ field.value|default:'' }}">
                            {% for error in field.errors %}<div class="text-danger text-sm mt-1">{{ error }}</div>{% endfor %}
                        {% endfor %}
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="tw-btn-primary">
                            <i class="fas fa-plus mr-2"></i>
                            Generate Token
                        </button>
                        <button type="button"
                                class="tw-btn-secondary"
                                @click="document.getElementById('tokenGenerationForm').reset()">
                            <i class="fas fa-times mr-2"></i>
                            Clear
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {# New Token Display Card #}
        {% if new_encoded_access_token %}
            <div class="tw-card mb-6 border-warning/30">
                <div class="px-6 py-4 border-b border-warning/30">
                    <h4 class="text-lg font-semibold text-warning flex items-center gap-2 m-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        Your New Personal Access Token
                    </h4>
                </div>
                <div class="p-6">
                    <div class="flex items-start gap-3 p-4 bg-warning/5 border border-warning/20 rounded-lg mb-4">
                        <i class="fas fa-exclamation-triangle text-warning mt-0.5"></i>
                        <p class="text-text m-0">Make sure to copy your personal access token now. You won't be able to see it again!</p>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium text-text">Personal Access Token</label>
                            {% include 'core/components/copy_token.html.j2' %}
                        </div>
                        <div id="access-token"
                             class="px-4 py-3 bg-background border border-border rounded-lg font-mono text-sm text-text break-all"
                             readonly>{{ new_encoded_access_token }}</div>
                    </div>
                </div>
            </div>
        {% endif %}
        {# Personal Access Tokens List Card #}
        <div class="tw-card">
            <div class="px-6 py-4 border-b border-border">
                <h4 class="text-lg font-semibold text-text m-0">Personal Access Tokens</h4>
            </div>
            <div class="p-6">
                {{ access_tokens|json_script:"access-tokens-data" }}
                <div x-data="accessTokensList({ tokensDataElementId: 'access-tokens-data', csrfToken: '{{ csrf_token }}' })"
                     x-cloak>
                    {# Empty State #}
                    <div x-show="tokens.length === 0"
                         class="flex flex-col items-center justify-center py-12">
                        <div class="w-16 h-16 rounded-full bg-border/30 flex items-center justify-center mb-4">
                            <i class="fas fa-key text-2xl text-text-muted"></i>
                        </div>
                        <h5 class="text-lg font-semibold text-text mb-2">No personal access tokens</h5>
                        <p class="text-text-muted text-center max-w-md m-0">
                            Generate a personal access token to access the sbomify API from scripts and applications.
                        </p>
                    </div>
                    {# Tokens List #}
                    <div x-show="tokens.length > 0"
                         class="border border-border rounded-lg overflow-hidden">
                        <div class="grid grid-cols-12 gap-4 px-4 py-3 bg-background/50 border-b border-border text-xs font-semibold text-text-muted uppercase">
                            <div class="col-span-8">Token</div>
                            <div class="col-span-4">Created</div>
                        </div>
                        <template x-for="token in tokens" :key="token.id">
                            <div class="grid grid-cols-12 gap-4 px-4 py-3 border-b border-border last:border-b-0 items-center">
                                <div class="col-span-8">
                                    <div class="font-medium text-text" x-text="token.description"></div>
                                    <div class="text-sm text-text-muted">Personal access token</div>
                                </div>
                                <div class="col-span-3 text-text-muted text-sm"
                                     x-text="formatDate(token.created_at)"></div>
                                <div class="col-span-1 text-right">
                                    <button class="p-2 rounded-lg text-danger hover:bg-danger/10 transition-colors"
                                            title="Delete token"
                                            @click="confirmDelete(token)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                    {# Delete Confirmation Modal #}
                    <template x-teleport="body">
                        <div x-show="showDeleteModal"
                             x-cloak
                             class="fixed inset-0 z-[100]"
                             role="alertdialog"
                             aria-modal="true"
                             aria-labelledby="deleteTokenModalLabel">
                            <div x-show="showDeleteModal"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0"
                                 x-transition:enter-end="opacity-100"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100"
                                 x-transition:leave-end="opacity-0"
                                 class="tw-modal-overlay"
                                 @click="showDeleteModal = false"></div>
                            <div class="tw-modal"
                                 x-show="showDeleteModal"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 scale-95"
                                 x-transition:enter-end="opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100 scale-100"
                                 x-transition:leave-end="opacity-0 scale-95"
                                 @click.stop
                                 @keydown.escape.window="if(showDeleteModal) showDeleteModal = false">
                                <div class="tw-modal-content tw-modal-sm">
                                    <div class="tw-modal-body text-center py-6">
                                        <button type="button"
                                                class="tw-modal-close absolute top-4 right-4"
                                                @click="showDeleteModal = false"
                                                aria-label="Close">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-danger/10 flex items-center justify-center">
                                            <i class="fas fa-exclamation-triangle text-danger text-xl"></i>
                                        </div>
                                        <h4 id="deleteTokenModalLabel" class="tw-modal-title mb-2">Delete personal access token?</h4>
                                        <p class="text-text mb-3">
                                            Are you sure you want to delete the "<span x-text="tokenToDelete?.description" class="font-semibold text-danger"></span>" token?
                                        </p>
                                        <div class="flex items-start gap-3 p-4 bg-warning/5 border border-warning/20 rounded-lg text-left">
                                            <i class="fas fa-info-circle text-warning mt-0.5"></i>
                                            <p class="text-text-muted text-sm m-0">
                                                This action cannot be undone. Applications using this token will no longer be able to access the sbomify API.
                                            </p>
                                        </div>
                                    </div>
                                    <div class="tw-modal-footer justify-center">
                                        <button type="button" class="tw-btn-ghost" @click="showDeleteModal = false">Cancel</button>
                                        <button type="button"
                                                class="tw-btn-danger"
                                                @click="deleteToken()"
                                                :disabled="isDeleting">
                                            <span x-show="isDeleting"
                                                  class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                                            <span x-text="isDeleting ? 'Deleting...' : 'Delete token'"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <!-- Account Danger Zone Section -->
        <div class="standard-card-container mt-4"
             x-data="accountDangerZone({ csrfToken: '{{ csrf_token }}' })">
            <div class="card dangerzone-card shadow-sm">
                <div class="card-header collapsible-header cursor-pointer"
                     @click="toggle()">
                    <div class="header-content d-flex justify-content-between align-items-center w-100">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Account
                            <i class="fas ms-2"
                               :class="isExpanded ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                        </h4>
                    </div>
                </div>
                <div class="card-body collapse"
                     :class="{ 'show': isExpanded }"
                     x-show="isExpanded"
                     x-cloak>
                    <!-- Delete Account Section -->
                    <div class="danger-section delete-section">
                        <div class="section-header">
                            <div class="section-icon delete-icon">
                                <i class="fas fa-user-slash"></i>
                            </div>
                            <div class="section-content">
                                <h6 class="section-title">Delete Account</h6>
                                <p class="section-description">Permanently delete your sbomify account. This action cannot be undone.</p>
                            </div>
                        </div>
                        <button class="btn btn-danger modern-btn delete-btn"
                                @click.prevent="openDeleteModal()">
                            <i class="fas fa-user-slash me-2"></i>
                            Delete Account
                        </button>
                    </div>
                </div>
            </div>
            <!-- Delete Account Modal -->
            <template x-teleport="body">
                <div x-show="showDeleteModal"
                     x-cloak
                     class="delete-modal-overlay"
                     tabindex="-1"
                     @click.self="closeModal()"
                     @keydown.escape.window="closeModal()">
                    <div class="delete-modal" @click.stop>
                        <div class="delete-modal-header">
                            <div class="delete-modal-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3 class="delete-modal-title">Delete Your Account</h3>
                            <button type="button" class="delete-modal-close" @click="closeModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="delete-modal-body">
                            <p class="delete-modal-message">Are you sure you want to permanently delete your account?</p>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>What will be deleted:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Your account profile and login credentials</li>
                                    <li>Your personal access tokens</li>
                                    <li>Your workspace memberships</li>
                                    <li>Your document access requests and NDA signatures</li>
                                </ul>
                            </div>
                            <div class="alert alert-secondary mb-3">
                                <i class="fas fa-building me-2"></i>
                                <strong>What will NOT be deleted:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Workspace-owned products, projects, and components</li>
                                    <li>SBOMs and documents (owned by workspaces)</li>
                                    <li>Audit records (your name may appear for compliance)</li>
                                </ul>
                            </div>
                            <p class="delete-modal-warning">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                This action is <strong>permanent</strong> and cannot be undone.
                                In compliance with GDPR, your personal data will be removed.
                            </p>
                            <!-- Validation Error Display -->
                            <div x-show="validationError"
                                 x-cloak
                                 class="alert alert-danger mt-3"
                                 x-text="validationError"></div>
                            <p class="delete-modal-confirm-text mb-2 mt-3">
                                Type <strong>delete</strong> to confirm:
                            </p>
                            <input x-model="confirmText"
                                   type="text"
                                   class="form-control"
                                   placeholder="Type 'delete' to confirm"
                                   :disabled="isDeleting"
                                   @keydown.enter="if (canConfirm && !isDeleting) deleteAccount()" />
                        </div>
                        <div class="delete-modal-footer">
                            <button type="button"
                                    class="delete-modal-button delete-modal-button--secondary"
                                    @click="closeModal()"
                                    :disabled="isDeleting">Cancel</button>
                            <button type="button"
                                    class="delete-modal-button delete-modal-button--danger"
                                    @click="deleteAccount()"
                                    :disabled="!canConfirm || isDeleting">
                                <span x-show="isDeleting" class="spinner-border spinner-border-sm me-2"></span>
                                <i x-show="!isDeleting" class="fas fa-trash me-2"></i>
                                <span x-text="isDeleting ? 'Deleting...' : 'Delete My Account'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
{% endblock %}
