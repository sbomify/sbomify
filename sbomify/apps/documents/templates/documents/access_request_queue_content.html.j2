{% load static %}
{% load humanize %}
<!-- Access Requests Section -->
<div class="standard-card mb-4">
    <div class="card settings-card shadow-md">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Access Requests</h4>
            <button type="button"
                    class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#inviteUserModal">
                <i class="fas fa-user-plus me-1"></i>Invite
            </button>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                Manage access requests for gated components. Approve or reject requests from users who want to access your gated documents and SBOMs.
            </p>
            <div class="mb-4">
                <h5 class="mb-3">Pending Requests</h5>
                {% if pending_requests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Requested</th>
                                    <th>NDA Signed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in pending_requests %}
                                    <tr>
                                        <td>
                                            {% if req.user.first_name or req.user.last_name %}
                                                {{ req.user.first_name }} {{ req.user.last_name }}
                                            {% else %}
                                                {{ req.user.username }}
                                            {% endif %}
                                        </td>
                                        <td>{{ req.user.email }}</td>
                                        <td>{{ req.requested_at|naturaltime }}</td>
                                        <td>
                                            {% if req.nda_signature %}
                                                {% if req.nda_signature.is_document_modified %}
                                                    <span class="badge bg-danger"
                                                          title="NDA document has been modified after signing">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>Modified
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Yes
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-times me-1"></i>No
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex gap-2 align-items-center">
                                                <button type="button"
                                                        class="btn-icon btn-icon-edit"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#accessRequestInfoModal"
                                                        title="View Details"
                                                        data-request-id="{{ req.id }}"
                                                        data-user-name="{% if req.user.first_name or req.user.last_name %}{{ req.user.first_name }} {{ req.user.last_name }}{% else %}{{ req.user.username }}{% endif %}"
                                                        data-user-email="{{ req.user.email }}"
                                                        data-status="{{ req.status }}"
                                                        data-requested-at="{{ req.requested_at|date:'F d, Y g:i A' }}"
                                                        data-decided-at="{% if req.decided_at %}{{ req.decided_at|date:'F d, Y g:i A' }}{% endif %}"
                                                        data-decided-by="{% if req.decided_by %}{{ req.decided_by.email }}{% endif %}"
                                                        data-revoked-at="{% if req.revoked_at %}{{ req.revoked_at|date:'F d, Y g:i A' }}{% endif %}"
                                                        data-revoked-by="{% if req.revoked_by %}{{ req.revoked_by.email }}{% endif %}"
                                                        data-notes="{{ req.notes|default:'' }}"
                                                        data-nda-signed="{% if req.nda_signature %}true{% else %}false{% endif %}"
                                                        data-nda-signed-name="{% if req.nda_signature %}{{ req.nda_signature.signed_name }}{% endif %}"
                                                        data-nda-signed-at="{% if req.nda_signature %}{{ req.nda_signature.signed_at|date:'F d, Y g:i A' }}{% endif %}"
                                                        data-nda-ip="{% if req.nda_signature %}{{ req.nda_signature.ip_address|default:'' }}{% endif %}"
                                                        data-nda-modified="{% if req.nda_signature and req.nda_signature.is_document_modified %}true{% else %}false{% endif %}">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                <form method="post"
                                                      action="{% url 'documents:access_request_queue' team.key %}"
                                                      class="d-inline"
                                                      id="access-request-form-{{ req.id }}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="request_id" value="{{ req.id }}">
                                                    <input type="hidden" name="active_tab" value="trust-center">
                                                    <div class="d-flex gap-2">
                                                        <button type="submit"
                                                                name="action"
                                                                value="approve"
                                                                class="btn-icon btn-icon-approve"
                                                                title="Approve Access"
                                                                data-bs-toggle="tooltip"
                                                                data-bs-placement="top">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button type="button"
                                                                name="action"
                                                                value="reject"
                                                                class="btn-icon btn-icon-delete reject-btn"
                                                                title="Reject Access"
                                                                data-bs-toggle="tooltip"
                                                                data-bs-placement="top"
                                                                data-request-id="{{ req.id }}"
                                                                data-user-email="{{ req.user.email }}">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No pending access requests.</p>
                {% endif %}
            </div>
            <div>
                <h5 class="mb-3">Approved Requests</h5>
                {% if approved_requests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Approved By</th>
                                    <th>NDA Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in approved_requests %}
                                    <tr>
                                        <td>
                                            {% if req.user.first_name or req.user.last_name %}
                                                {{ req.user.first_name }} {{ req.user.last_name }}
                                            {% else %}
                                                {{ req.user.username }}
                                            {% endif %}
                                        </td>
                                        <td>{{ req.user.email }}</td>
                                        <td>
                                            {% if req.decided_by %}
                                                {{ req.decided_by.email }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if req.nda_signature %}
                                                {% if req.nda_signature.is_document_modified %}
                                                    <span class="badge bg-danger"
                                                          title="NDA document has been modified after signing">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>Modified
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Valid
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex gap-2 align-items-center">
                                                <button type="button"
                                                        class="btn-icon btn-icon-edit"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#accessRequestInfoModal"
                                                        title="View Details"
                                                        data-request-id="{{ req.id }}"
                                                        data-user-name="{% if req.user.first_name or req.user.last_name %}{{ req.user.first_name }} {{ req.user.last_name }}{% else %}{{ req.user.username }}{% endif %}"
                                                        data-user-email="{{ req.user.email }}"
                                                        data-status="{{ req.status }}"
                                                        data-requested-at="{{ req.requested_at|date:'F d, Y g:i A' }}"
                                                        data-decided-at="{% if req.decided_at %}{{ req.decided_at|date:'F d, Y g:i A' }}{% endif %}"
                                                        data-decided-by="{% if req.decided_by %}{{ req.decided_by.email }}{% endif %}"
                                                        data-revoked-at="{% if req.revoked_at %}{{ req.revoked_at|date:'F d, Y g:i A' }}{% endif %}"
                                                        data-revoked-by="{% if req.revoked_by %}{{ req.revoked_by.email }}{% endif %}"
                                                        data-notes="{{ req.notes|default:'' }}"
                                                        data-nda-signed="{% if req.nda_signature %}true{% else %}false{% endif %}"
                                                        data-nda-signed-name="{% if req.nda_signature %}{{ req.nda_signature.signed_name }}{% endif %}"
                                                        data-nda-signed-at="{% if req.nda_signature %}{{ req.nda_signature.signed_at|date:'F d, Y g:i A' }}{% endif %}"
                                                        data-nda-ip="{% if req.nda_signature %}{{ req.nda_signature.ip_address|default:'' }}{% endif %}"
                                                        data-nda-modified="{% if req.nda_signature and req.nda_signature.is_document_modified %}true{% else %}false{% endif %}">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                <form method="post"
                                                      action="{% url 'documents:access_request_queue' team.key %}"
                                                      class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="request_id" value="{{ req.id }}">
                                                    <input type="hidden" name="active_tab" value="trust-center">
                                                    <button type="button"
                                                            class="btn-icon btn-icon-delete"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#revokeAccessModal"
                                                            data-bs-placement="top"
                                                            title="Revoke Access"
                                                            data-request-id="{{ req.id }}"
                                                            data-user-email="{{ req.user.email }}">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No approved access requests.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- Invite User Modal -->
<div class="modal fade"
     id="inviteUserModal"
     tabindex="-1"
     aria-labelledby="inviteUserModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteUserModalLabel">Invite User</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <form method="post"
                  action="{% url 'documents:access_request_queue' team.key %}"
                  hx-post="{% url 'documents:access_request_queue' team.key %}"
                  hx-target="#access-requests-wrapper"
                  hx-swap="innerHTML"
                  hx-trigger="submit">
                {% csrf_token %}
                <input type="hidden" name="action" value="invite">
                <input type="hidden" name="active_tab" value="trust-center">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>What does this invitation do?</strong>
                        <p class="mb-0 mt-2">
                            The user will receive an email invitation to join this workspace.
                            If they don't have an account, they'll be prompted to create one.
                            After signing in and completing any required NDA, they will automatically join with access to gated components.
                        </p>
                    </div>
                    <div class="mb-3">
                        <label for="invite_email" class="form-label">Email Address</label>
                        <input type="email"
                               class="form-control"
                               id="invite_email"
                               name="email"
                               placeholder="user@example.com"
                               required>
                        <div class="form-text">The user will receive an invitation email to join this workspace.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Send Invitation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Access Request Info Modal -->
<div class="modal fade"
     id="accessRequestInfoModal"
     tabindex="-1"
     aria-labelledby="accessRequestInfoModalLabel"
     aria-hidden="true"
     data-bs-backdrop="true"
     data-bs-keyboard="true"
     role="dialog"
     aria-modal="true">
    <div class="modal-dialog modal-dialog-centered delete-modal-dialog"
         style="max-width: 600px">
        <div class="modal-content delete-modal">
            <div class="delete-modal-header">
                <h3 class="delete-modal-title" id="accessRequestInfoModalLabel">Access Request Details</h3>
                <button type="button"
                        class="delete-modal-close"
                        data-bs-dismiss="modal"
                        aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="delete-modal-body" id="accessRequestInfoModalBody">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">User Name</label>
                            <div class="fw-medium text-dark" id="info-user-name">—</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Email</label>
                            <div class="fw-medium text-dark" id="info-user-email">—</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Status</label>
                            <div id="info-status">—</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Requested At</label>
                            <div class="fw-medium text-dark" id="info-requested-at">—</div>
                        </div>
                    </div>
                    <div class="col-md-6" id="info-decided-section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Decided At</label>
                            <div class="fw-medium text-dark" id="info-decided-at">—</div>
                        </div>
                    </div>
                    <div class="col-md-6" id="info-decided-by-section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Decided By</label>
                            <div class="fw-medium text-dark" id="info-decided-by">—</div>
                        </div>
                    </div>
                    <div class="col-md-6" id="info-revoked-section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Revoked At</label>
                            <div class="fw-medium text-dark" id="info-revoked-at">—</div>
                        </div>
                    </div>
                    <div class="col-md-6" id="info-revoked-by-section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Revoked By</label>
                            <div class="fw-medium text-dark" id="info-revoked-by">—</div>
                        </div>
                    </div>
                    <div class="col-12" id="info-nda-section" style="display: none;">
                        <hr class="my-3" style="border-color: #e5e7eb;">
                        <h6 class="mb-3 fw-semibold text-dark">NDA Signature Information</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-muted small mb-1 fw-medium">Signed Name</label>
                                    <div class="fw-medium text-dark" id="info-nda-signed-name">—</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-muted small mb-1 fw-medium">Signed At</label>
                                    <div class="fw-medium text-dark" id="info-nda-signed-at">—</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-muted small mb-1 fw-medium">IP Address</label>
                                    <div class="fw-medium text-dark" id="info-nda-ip">—</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-muted small mb-1 fw-medium">Document Status</label>
                                    <div id="info-nda-modified">—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12" id="info-notes-section" style="display: none;">
                        <hr class="my-3" style="border-color: #e5e7eb;">
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1 fw-medium">Notes</label>
                            <div class="fw-medium text-dark"
                                 style="white-space: pre-wrap"
                                 id="info-notes">—</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="delete-modal-footer">
                <button type="button"
                        class="delete-modal-button delete-modal-button--secondary"
                        data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Revoke Access Modal -->
{% load static %}
<link rel="stylesheet"
      href="{% static 'css/components/delete-modal.css' %}">
<div class="modal fade"
     id="revokeAccessModal"
     tabindex="-1"
     aria-labelledby="revokeAccessModalLabel"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered delete-modal-dialog">
        <div class="modal-content delete-modal">
            <div class="delete-modal-header">
                <div class="delete-modal-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="delete-modal-title" id="revokeAccessModalLabel">Revoke Access</h3>
                <button type="button"
                        class="delete-modal-close"
                        data-bs-dismiss="modal"
                        aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="delete-modal-body">
                <p class="delete-modal-message">
                    Are you sure you want to revoke access for <span class="delete-modal-name" id="revokeAccessModalDisplayName"></span>?
                </p>
                <p class="delete-modal-warning">
                    This will remove their guest membership and they will no longer have access to gated components.
                </p>
            </div>
            <div class="delete-modal-footer">
                <button type="button"
                        class="delete-modal-button delete-modal-button--secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <form id="revokeAccessModalForm"
                      method="post"
                      action="{% url 'documents:access_request_queue' team.key %}"
                      class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="revoke">
                    <input type="hidden"
                           name="request_id"
                           id="revokeAccessModalRequestId"
                           value="">
                    <input type="hidden" name="active_tab" value="trust-center">
                    <button type="submit" class="delete-modal-button delete-modal-button--danger">
                        <i class="fas fa-ban me-2"></i>Revoke Access
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    (function() {
        // Wait for alerts to be loaded (with timeout)
        let retries = 0;
        const maxRetries = 100; // 5 seconds max wait
        
        function initRejectButtons() {
            // Remove existing event listeners by cloning buttons
            document.querySelectorAll('.reject-btn').forEach(function(button) {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
            });
            
            if (typeof window.showConfirmation === 'function') {
                // Handle reject button clicks with confirmation modal
                document.querySelectorAll('.reject-btn').forEach(function(button) {
                    button.addEventListener('click', async function(e) {
                        e.preventDefault();
                        
                        const requestId = this.getAttribute('data-request-id');
                        const userEmail = this.getAttribute('data-user-email');
                        const form = document.getElementById('access-request-form-' + requestId);
                        
                        if (!form) {
                            console.error('Form not found for request ID:', requestId);
                            return;
                        }
                        
                        try {
                            // Show confirmation modal
                            const confirmed = await window.showConfirmation({
                                title: 'Reject Access Request?',
                                message: `Are you sure you want to reject the access request from ${userEmail}? This action cannot be undone.`,
                                confirmButtonText: 'Reject',
                                cancelButtonText: 'Cancel',
                                type: 'warning'
                            });
                            
                            if (confirmed) {
                                // Remove any existing action input
                                const existingActionInputs = form.querySelectorAll('input[name="action"]');
                                existingActionInputs.forEach(function(input) {
                                    if (input.type === 'hidden') {
                                        input.remove();
                                    }
                                });
                                
                                // Create hidden input for action
                                const actionInput = document.createElement('input');
                                actionInput.type = 'hidden';
                                actionInput.name = 'action';
                                actionInput.value = 'reject';
                                form.appendChild(actionInput);
                                
                                // Submit the form
                                form.submit();
                            }
                        } catch (error) {
                            console.error('Error showing confirmation:', error);
                            // Fallback to basic confirm
                            if (confirm(`Are you sure you want to reject the access request from ${userEmail}?`)) {
                                // Remove any existing action input
                                const existingActionInputs = form.querySelectorAll('input[name="action"]');
                                existingActionInputs.forEach(function(input) {
                                    if (input.type === 'hidden') {
                                        input.remove();
                                    }
                                });
                                
                                const actionInput = document.createElement('input');
                                actionInput.type = 'hidden';
                                actionInput.name = 'action';
                                actionInput.value = 'reject';
                                form.appendChild(actionInput);
                                form.submit();
                            }
                        }
                    });
                });
            } else if (retries < maxRetries) {
                retries++;
                setTimeout(initRejectButtons, 50);
            } else {
                console.warn('showConfirmation not available after waiting, using fallback');
                // Fallback to basic confirm
                document.querySelectorAll('.reject-btn').forEach(function(button) {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const requestId = this.getAttribute('data-request-id');
                        const userEmail = this.getAttribute('data-user-email');
                        const form = document.getElementById('access-request-form-' + requestId);
                        
                        if (!form) {
                            console.error('Form not found for request ID:', requestId);
                            return;
                        }
                        
                        if (confirm(`Are you sure you want to reject the access request from ${userEmail}?`)) {
                            // Remove any existing action input
                            const existingActionInputs = form.querySelectorAll('input[name="action"]');
                            existingActionInputs.forEach(function(input) {
                                if (input.type === 'hidden') {
                                    input.remove();
                                }
                            });
                            
                            const actionInput = document.createElement('input');
                            actionInput.type = 'hidden';
                            actionInput.name = 'action';
                            actionInput.value = 'reject';
                            form.appendChild(actionInput);
                            form.submit();
                        }
                    });
                });
            }
        }
        
        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initRejectButtons);
        } else {
            initRejectButtons();
        }
        
        // Initialize tooltips for action buttons
        function initActionTooltips() {
            if (window.bootstrap && window.bootstrap.Tooltip) {
                // Initialize tooltips for revoke buttons
                document.querySelectorAll('button[data-bs-target="#revokeAccessModal"][title]').forEach(function(button) {
                    const existingTooltip = window.bootstrap.Tooltip.getInstance(button);
                    if (existingTooltip) {
                        existingTooltip.dispose();
                    }
                    new window.bootstrap.Tooltip(button);
                });
                // Initialize tooltips for info buttons
                document.querySelectorAll('button[data-bs-target="#accessRequestInfoModal"][title]').forEach(function(button) {
                    const existingTooltip = window.bootstrap.Tooltip.getInstance(button);
                    if (existingTooltip) {
                        existingTooltip.dispose();
                    }
                    new window.bootstrap.Tooltip(button);
                });
                // Initialize tooltips for approve buttons
                document.querySelectorAll('.btn-icon-approve[title]').forEach(function(button) {
                    const existingTooltip = window.bootstrap.Tooltip.getInstance(button);
                    if (existingTooltip) {
                        existingTooltip.dispose();
                    }
                    new window.bootstrap.Tooltip(button);
                });
            }
        }
        
        // Initialize tooltips on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initActionTooltips);
        } else {
            initActionTooltips();
        }
        
        // Re-initialize after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id && event.detail.target.id.includes('access-request') || 
                event.detail.target.querySelector('.reject-btn')) {
                retries = 0; // Reset retries
                initRejectButtons();
                initActionTooltips();
            }
        });
        
        // Also listen for the specific refresh trigger
        document.body.addEventListener('refreshAccessRequests', function() {
            retries = 0;
            setTimeout(function() {
                initRejectButtons();
                initActionTooltips();
            }, 100); // Small delay to ensure DOM is updated
        });
        
        // Handle modal close after successful invite
        document.body.addEventListener('closeInviteModal', function() {
            const modalElement = document.querySelector('#inviteUserModal');
            if (modalElement && window.bootstrap) {
                const modal = window.bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                // Reset form
                const form = modalElement.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        });
        
        // Handle revoke access modal
        const revokeModal = document.getElementById('revokeAccessModal');
        if (revokeModal) {
            revokeModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const requestId = button.getAttribute('data-request-id');
                const userEmail = button.getAttribute('data-user-email');
                
                // Update form with request ID
                const requestIdInput = document.getElementById('revokeAccessModalRequestId');
                if (requestIdInput) {
                    requestIdInput.value = requestId;
                }
                
                // Update display name
                const displayNameElement = document.getElementById('revokeAccessModalDisplayName');
                if (displayNameElement && userEmail) {
                    displayNameElement.textContent = userEmail;
                }
            });
        }
        
        // Handle access request info modal
        const infoModal = document.getElementById('accessRequestInfoModal');
        if (infoModal) {
            infoModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                
                // Get all data attributes
                const userName = button.getAttribute('data-user-name') || '—';
                const userEmail = button.getAttribute('data-user-email') || '—';
                const status = button.getAttribute('data-status') || '—';
                const requestedAt = button.getAttribute('data-requested-at') || '—';
                const decidedAt = button.getAttribute('data-decided-at') || '';
                const decidedBy = button.getAttribute('data-decided-by') || '';
                const revokedAt = button.getAttribute('data-revoked-at') || '';
                const revokedBy = button.getAttribute('data-revoked-by') || '';
                const notes = button.getAttribute('data-notes') || '';
                const ndaSigned = button.getAttribute('data-nda-signed') === 'true';
                const ndaSignedName = button.getAttribute('data-nda-signed-name') || '';
                const ndaSignedAt = button.getAttribute('data-nda-signed-at') || '';
                const ndaIp = button.getAttribute('data-nda-ip') || '';
                const ndaModified = button.getAttribute('data-nda-modified') === 'true';
                
                // Populate user info
                document.getElementById('info-user-name').textContent = userName;
                document.getElementById('info-user-email').textContent = userEmail;
                
                // Populate status with badge
                const statusElement = document.getElementById('info-status');
                const statusBadges = {
                    'pending': '<span class="badge bg-warning">Pending</span>',
                    'approved': '<span class="badge bg-success">Approved</span>',
                    'rejected': '<span class="badge bg-danger">Rejected</span>',
                    'revoked': '<span class="badge bg-secondary">Revoked</span>'
                };
                statusElement.innerHTML = statusBadges[status] || status;
                
                // Populate dates
                document.getElementById('info-requested-at').textContent = requestedAt;
                
                // Show/hide decided section
                const decidedSection = document.getElementById('info-decided-section');
                const decidedBySection = document.getElementById('info-decided-by-section');
                if (decidedAt) {
                    document.getElementById('info-decided-at').textContent = decidedAt;
                    decidedSection.style.display = 'block';
                } else {
                    decidedSection.style.display = 'none';
                }
                if (decidedBy) {
                    document.getElementById('info-decided-by').textContent = decidedBy;
                    decidedBySection.style.display = 'block';
                } else {
                    decidedBySection.style.display = 'none';
                }
                
                // Show/hide revoked section
                const revokedSection = document.getElementById('info-revoked-section');
                const revokedBySection = document.getElementById('info-revoked-by-section');
                if (revokedAt) {
                    document.getElementById('info-revoked-at').textContent = revokedAt;
                    revokedSection.style.display = 'block';
                } else {
                    revokedSection.style.display = 'none';
                }
                if (revokedBy) {
                    document.getElementById('info-revoked-by').textContent = revokedBy;
                    revokedBySection.style.display = 'block';
                } else {
                    revokedBySection.style.display = 'none';
                }
                
                // Show/hide NDA section
                const ndaSection = document.getElementById('info-nda-section');
                if (ndaSigned) {
                    document.getElementById('info-nda-signed-name').textContent = ndaSignedName || '—';
                    document.getElementById('info-nda-signed-at').textContent = ndaSignedAt || '—';
                    document.getElementById('info-nda-ip').textContent = ndaIp || '—';
                    const ndaModifiedElement = document.getElementById('info-nda-modified');
                    if (ndaModified) {
                        ndaModifiedElement.innerHTML = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Modified</span>';
                    } else {
                        ndaModifiedElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Valid</span>';
                    }
                    ndaSection.style.display = 'block';
                } else {
                    ndaSection.style.display = 'none';
                }
                
                // Show/hide notes section
                const notesSection = document.getElementById('info-notes-section');
                if (notes) {
                    document.getElementById('info-notes').textContent = notes;
                    notesSection.style.display = 'block';
                } else {
                    notesSection.style.display = 'none';
                }
            });
        }
    })();
</script>
