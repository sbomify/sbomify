{% load static %}
{% load json_extras %}
<link rel="stylesheet"
      href="{% static 'css/components/assessment-results-card.css' %}">
<div class="standard-card mt-3"
     x-data="assessmentResultsCard('{{ sbom_id }}', '{{ assessment_runs|jsonify|escapejs }}')">
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h4 class="card-title mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>Assessment Results
                </h4>
            </div>
            <div class="status-badge-wrapper">
                <span class="badge" :class="getOverallStatusBadgeClass()">
                    <i :class="getOverallStatusIconClass()"></i>
                    <span x-text="getOverallStatusText()"></span>
                </span>
            </div>
        </div>
        <div class="card-body">
            <!-- Summary Stats -->
            <div class="assessment-stats-grid mb-4" x-show="totalAssessments > 0">
                <div class="stat-item stat-pass">
                    <div class="stat-number text-success" x-text="passingCount"></div>
                    <div class="stat-label">Passing</div>
                </div>
                <div class="stat-item stat-fail">
                    <div class="stat-number text-warning" x-text="failingCount"></div>
                    <div class="stat-label">Failing</div>
                </div>
                <div class="stat-item stat-pending">
                    <div class="stat-number text-info" x-text="pendingCount"></div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-item stat-total">
                    <div class="stat-number text-secondary" x-text="totalAssessments"></div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
            <!-- No Assessments Message -->
            <div x-show="totalAssessments === 0" class="text-center text-muted py-4">
                <i class="fas fa-clock fa-2x mb-3 d-block"></i>
                <p class="mb-0">Assessment results will appear here once processing completes.</p>
                <small>This usually takes a few minutes after SBOM upload.</small>
            </div>
            <!-- Plugin Results -->
            <div x-show="totalAssessments > 0" class="plugin-results-section">
                <h6 class="section-title mb-3">
                    <i class="fas fa-puzzle-piece me-2"></i>
                    Plugin Results
                </h6>
                <div class="accordion" id="assessmentAccordion">
                    <template x-for="(run, index) in latestRuns" :key="run.id">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        :data-bs-toggle="'collapse'"
                                        :data-bs-target="'#collapse-' + run.id"
                                        :aria-expanded="false"
                                        :aria-controls="'collapse-' + run.id">
                                    <div class="d-flex align-items-center justify-content-between w-100 me-3">
                                        <div class="plugin-header">
                                            <span class="plugin-name fw-medium"
                                                  x-text="run.plugin_display_name || run.plugin_name"></span>
                                            <span class="badge ms-2" :class="getRunStatusBadgeClass(run)">
                                                <span x-text="getRunStatusText(run)"></span>
                                            </span>
                                        </div>
                                        <div class="plugin-meta text-muted small">
                                            <span x-show="run.result?.summary" class="me-3">
                                                <span x-text="run.result?.summary?.total_findings || 0"></span> findings
                                            </span>
                                            <span x-text="formatDate(run.completed_at || run.created_at)"></span>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div :id="'collapse-' + run.id"
                                 class="accordion-collapse collapse"
                                 data-bs-parent="#assessmentAccordion">
                                <div class="accordion-body">
                                    <!-- Run Metadata -->
                                    <div class="run-metadata mb-3 small text-muted">
                                        <span class="me-3">
                                            <i class="fas fa-code-branch me-1"></i>
                                            Version: <span x-text="run.plugin_version"></span>
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-play-circle me-1"></i>
                                            Reason: <span x-text="formatRunReason(run.run_reason)"></span>
                                        </span>
                                        <span x-show="run.completed_at">
                                            <i class="fas fa-clock me-1"></i>
                                            Completed: <span x-text="formatDate(run.completed_at)"></span>
                                        </span>
                                    </div>
                                    <!-- Error Message (if failed) -->
                                    <div x-show="run.status === 'failed' && run.error_message"
                                         class="alert alert-danger mb-3">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        <span x-text="run.error_message"></span>
                                    </div>
                                    <!-- Findings Summary -->
                                    <div x-show="run.result?.summary" class="findings-summary mb-3">
                                        <div class="row g-2">
                                            <div class="col-6 col-md-2">
                                                <div class="finding-stat text-center p-2 rounded bg-success-subtle">
                                                    <div class="fw-bold text-success"
                                                         x-text="run.result?.summary?.pass_count || 0"></div>
                                                    <small class="text-muted">Pass</small>
                                                </div>
                                            </div>
                                            <div class="col-6 col-md-2">
                                                <div class="finding-stat text-center p-2 rounded bg-warning-subtle">
                                                    <div class="fw-bold text-warning"
                                                         x-text="run.result?.summary?.fail_count || 0"></div>
                                                    <small class="text-muted">Fail</small>
                                                </div>
                                            </div>
                                            <div class="col-6 col-md-2">
                                                <div class="finding-stat text-center p-2 rounded bg-info-subtle">
                                                    <div class="fw-bold text-info"
                                                         x-text="run.result?.summary?.warning_count || 0"></div>
                                                    <small class="text-muted">Warning</small>
                                                </div>
                                            </div>
                                            <div class="col-6 col-md-2">
                                                <div class="finding-stat text-center p-2 rounded bg-secondary-subtle">
                                                    <div class="fw-bold text-secondary"
                                                         x-text="run.result?.summary?.info_count || 0"></div>
                                                    <small class="text-muted">Info</small>
                                                </div>
                                            </div>
                                            <div class="col-6 col-md-2">
                                                <div class="finding-stat text-center p-2 rounded bg-danger-subtle">
                                                    <div class="fw-bold text-danger"
                                                         x-text="run.result?.summary?.error_count || 0"></div>
                                                    <small class="text-muted">Error</small>
                                                </div>
                                            </div>
                                            <div class="col-6 col-md-2">
                                                <div class="finding-stat text-center p-2 rounded bg-light">
                                                    <div class="fw-bold" x-text="run.result?.summary?.total_findings || 0"></div>
                                                    <small class="text-muted">Total</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Findings List -->
                                    <div x-show="run.result?.findings?.length > 0" class="findings-list">
                                        <h6 class="mb-2">
                                            <i class="fas fa-list me-1"></i>
                                            Findings
                                        </h6>
                                        <template x-for="finding in run.result?.findings || []" :key="finding.id">
                                            <div class="finding-item p-3 mb-2 rounded border"
                                                 :class="getFindingBorderClass(finding.status)">
                                                <div class="d-flex align-items-start">
                                                    <span class="finding-status-icon me-2"
                                                          :class="getFindingIconClass(finding.status)">
                                                        <i :class="getFindingIcon(finding.status)"></i>
                                                    </span>
                                                    <div class="flex-grow-1">
                                                        <div class="finding-title fw-medium" x-text="finding.title"></div>
                                                        <div class="finding-description text-muted small"
                                                             x-text="finding.description"></div>
                                                        <div x-show="finding.remediation" class="finding-remediation mt-2 small">
                                                            <i class="fas fa-lightbulb text-info me-1"></i>
                                                            <span class="text-info" x-text="finding.remediation"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    <!-- Standard Info (for compliance plugins) -->
                                    <div x-show="run.result?.metadata?.standard_name"
                                         class="standard-info mt-3 p-3 bg-light rounded">
                                        <h6 class="mb-2">
                                            <i class="fas fa-book me-1"></i>
                                            Standard Reference
                                        </h6>
                                        <div class="small">
                                            <div>
                                                <strong>Standard:</strong> <span x-text="run.result?.metadata?.standard_name"></span>
                                            </div>
                                            <div>
                                                <strong>Version:</strong> <span x-text="run.result?.metadata?.standard_version"></span>
                                            </div>
                                            <div x-show="run.result?.metadata?.standard_url">
                                                <strong>Reference:</strong>
                                                <a :href="run.result?.metadata?.standard_url"
                                                   target="_blank"
                                                   rel="noopener"
                                                   class="text-decoration-none">
                                                    View Standard <i class="fas fa-external-link-alt ms-1"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
