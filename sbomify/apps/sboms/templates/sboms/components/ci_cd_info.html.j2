{% load static %}
<link rel="stylesheet" href="{% static 'css/components/ci-cd-info.css' %}">
<div x-data="ciCdInfo({componentId: '{{ component.id|escapejs }}', componentName: '{{ component.name|escapejs }}'})"
     class="card sbom-card"
     :class="{'collapsed': !expanded}">
    <div class="card-header clickable" @click="expanded = !expanded">
        <h5 class="mb-0 d-flex align-items-center">
            CI/CD Integration
            <i class="fas ms-2"
               :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        </h5>
    </div>
    <div x-show="expanded">
        <div class="card-body">
            <div class="info-notice mb-4">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Automate SBOM generation:</strong> Follow these steps to integrate SBOM generation into your CI/CD pipeline. For manual uploads, use the Upload SBOM section above.
                </div>
            </div>
            <div class="nav-tabs-container">
                <!-- Tab navigation -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <template x-for="tab in tabs" :key="tab.id">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link"
                                    :class="{ active: activeTab === tab.id }"
                                    @click="handleTabClick(tab.id)">
                                <i :class="tab.icon"></i>
                                <span x-text="tab.name"></span>
                            </button>
                        </li>
                    </template>
                </ul>
                <!-- Tab content -->
                <div class="tab-content mt-4">
                    <!-- Platform-specific notices -->
                    <div x-show="activeTab === 'gitlab' && sourceType === 'docker'"
                         class="info-notice mb-3">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <div>
                            <strong>Note:</strong> GitLab CI requires Docker-in-Docker (DinD) service for Docker image scanning. The configuration above includes the necessary DinD setup.
                        </div>
                    </div>
                    <div x-show="activeTab === 'bitbucket' && sourceType === 'docker'"
                         class="info-notice mb-3">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <div>
                            <strong>Note:</strong> Bitbucket Pipelines provides built-in Docker support. The configuration above includes the necessary Docker service setup.
                        </div>
                    </div>
                    <!-- Configuration content -->
                    <div class="tab-pane active">
                        <!-- Source Selector -->
                        <div class="source-selector mb-3">
                            <label for="source-select" class="form-label">SBOM Source</label>
                            <select id="source-select" x-model="sourceType" class="form-select">
                                <option value="sbom">Existing SBOM file</option>
                                <option value="lock">Generate from lock file</option>
                                <option value="docker">Generate from Docker image</option>
                            </select>
                        </div>
                        <!-- Configuration Options -->
                        <div class="config-options">
                            <div class="config-option">
                                <div class="form-check">
                                    <input id="augment"
                                           x-model="config.augment"
                                           type="checkbox"
                                           class="form-check-input">
                                    <label for="augment" class="form-check-label">
                                        Augment
                                        <span class="info-icon"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="Add component metadata from the Component Metadata section above to provide additional context about your software">i</span>
                                    </label>
                                </div>
                            </div>
                            <div class="config-option">
                                <div class="form-check">
                                    <input id="enrich"
                                           x-model="config.enrich"
                                           type="checkbox"
                                           class="form-check-input">
                                    <label for="enrich" class="form-check-label">
                                        Enrich
                                        <span class="info-icon"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="Automatically improve SBOM quality by adding additional data like licenses from package registries and other sources">i</span>
                                    </label>
                                </div>
                            </div>
                            <div class="config-option">
                                <div class="form-check">
                                    <input id="output-file"
                                           x-model="config.outputFile"
                                           type="checkbox"
                                           class="form-check-input">
                                    <label for="output-file" class="form-check-label">
                                        Save SBOM to file
                                        <span class="info-icon"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="Save the generated SBOM to a local file in addition to uploading it">i</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Token requirement notice -->
                        <div class="info-notice mb-3">
                            <i class="fas fa-key text-info me-2"></i>
                            <div>
                                <strong>Required:</strong> Before using any CI integration, create a secret named <code>SBOMIFY_TOKEN</code> containing your API token. You can find your token in your account settings.
                            </div>
                        </div>
                        <!-- Content Display -->
                        <div class="code-block mt-3">
                            <pre><code id="ci-cd-code-{{ component.id }}" x-ref="codeBlock" class="hljs"></code></pre>
                            <div class="copy-btn">
                                {% include "core/components/copyable-value.html.j2" with copy_from="ci-cd-code-"|add:component.id title="Copy configuration" hide_value=True %}
                            </div>
                        </div>
                        <!-- Docker source type notes -->
                        <template x-if="sourceType === 'docker'">
                            <div x-show="activeTab === 'github'" class="info-notice mb-3 mt-3">
                                <i class="fas fa-info-circle text-info me-2"></i>
                                <div>
                                    <strong>Note:</strong> For Docker image scanning in GitHub Actions, the action will use GitHub's built-in Docker support. No additional configuration is needed.
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
