{% load static %}
<link rel="stylesheet" href="{% static 'css/components/ci-cd-info.css' %}">
<div x-cloak
     x-data="ciCdInfo({componentId: '{{ component.id|escapejs }}', componentName: '{{ component.name|escapejs }}', hasSboms: {{ component.sbom_count|default:0 }} > 0})"
     x-effect="activeTab, sourceType, config.augment, config.enrich, config.outputFile; updateContent()"
     class="bg-white rounded-lg shadow-sm sbom-card"
     :class="{'collapsed': !expanded}">
    <div class="px-6 py-4 border-b cursor-pointer"
         @click="expanded = !expanded"
         role="button"
         tabindex="0"
         @keydown.enter="expanded = !expanded"
         @keydown.space.prevent="expanded = !expanded"
         :aria-expanded="expanded"
         aria-controls="ci-cd-info-body">
        <h5 class="mb-0 flex items-center">
            CI/CD Integration
            <i class="fas ml-2"
               :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"
               aria-hidden="true"></i>
        </h5>
    </div>
    <div id="ci-cd-info-body" x-show="expanded" x-collapse>
        <div class="p-6">
            <div class="info-notice mb-4">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Automate SBOM generation:</strong> Follow these steps to integrate SBOM generation into your CI/CD pipeline. For manual uploads, use the Upload SBOM section above.
                </div>
            </div>
            <div class="nav-tabs-container">
                <!-- Tab navigation -->
                <ul class="flex border-b mb-4" role="tablist">
                    <template x-for="tab in tabs" :key="tab.id">
                        <li role="presentation">
                            <button class="px-4 py-2 border-b-2 transition-colors"
                                    :class="{ 'border-brand-primary text-brand-primary': activeTab === tab.id, 'border-transparent text-gray-600 hover:text-gray-900': activeTab !== tab.id }"
                                    @click="handleTabClick(tab.id)">
                                <i :class="tab.icon"></i>
                                <span x-text="tab.name"></span>
                            </button>
                        </li>
                    </template>
                </ul>
                <!-- Tab content -->
                <div class="mt-4">
                    <!-- Platform-specific notices -->
                    <div x-show="activeTab === 'gitlab' && sourceType === 'docker'"
                         class="info-notice mb-4">
                        <i class="fas fa-info-circle text-info-500 mr-2"></i>
                        <div>
                            <strong>Note:</strong> GitLab CI requires Docker-in-Docker (DinD) service for Docker image scanning. The configuration above includes the necessary DinD setup.
                        </div>
                    </div>
                    <div x-show="activeTab === 'bitbucket' && sourceType === 'docker'"
                         class="info-notice mb-4">
                        <i class="fas fa-info-circle text-info-500 mr-2"></i>
                        <div>
                            <strong>Note:</strong> Bitbucket Pipelines provides built-in Docker support. The configuration above includes the necessary Docker service setup.
                        </div>
                    </div>
                    <!-- Configuration content -->
                    <div>
                        <!-- Source Selector -->
                        <div class="source-selector mb-4">
                            <label for="source-select"
                                   class="block text-sm font-medium text-gray-700 mb-1">SBOM Source</label>
                            <select id="source-select"
                                    x-model="sourceType"
                                    class="w-full px-3 py-2 border border-gray-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-brand-primary">
                                <option value="sbom">Existing SBOM file</option>
                                <option value="lock">Generate from lock file</option>
                                <option value="docker">Generate from Docker image</option>
                            </select>
                        </div>
                        <!-- Configuration Options -->
                        <div class="config-options">
                            <div class="config-option">
                                <div class="flex items-center">
                                    <input id="augment"
                                           x-model="config.augment"
                                           type="checkbox"
                                           class="w-4 h-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                                    <label for="augment" class="ml-2 text-sm text-gray-700">
                                        Augment
                                        <span class="info-icon"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="Add component metadata from the Component Metadata section above to provide additional context about your software">i</span>
                                    </label>
                                </div>
                            </div>
                            <div class="config-option">
                                <div class="flex items-center">
                                    <input id="enrich"
                                           x-model="config.enrich"
                                           type="checkbox"
                                           class="w-4 h-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                                    <label for="enrich" class="ml-2 text-sm text-gray-700">
                                        Enrich
                                        <span class="info-icon"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="Automatically improve SBOM quality by adding additional data like licenses from package registries and other sources">i</span>
                                    </label>
                                </div>
                            </div>
                            <div class="config-option">
                                <div class="flex items-center">
                                    <input id="output-file"
                                           x-model="config.outputFile"
                                           type="checkbox"
                                           class="w-4 h-4 text-brand-primary border-gray-300 rounded focus:ring-brand-primary">
                                    <label for="output-file" class="ml-2 text-sm text-gray-700">
                                        Save SBOM to file
                                        <span class="info-icon"
                                              data-bs-toggle="tooltip"
                                              data-bs-placement="top"
                                              title="Save the generated SBOM to a local file in addition to uploading it">i</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Token requirement notice -->
                        <div class="info-notice mb-4">
                            <i class="fas fa-key text-info-500 mr-2"></i>
                            <div>
                                <strong>Required:</strong> Before using any CI integration, create a secret named <code>SBOMIFY_TOKEN</code> containing your API token. You can find your token in your account settings.
                            </div>
                        </div>
                        <!-- Content Display -->
                        <div class="code-block mt-4">
                            <pre><code id="ci-cd-code-{{ component.id }}" x-ref="codeBlock" class="hljs"></code></pre>
                            <div class="copy-btn">
                                {% include "core/components/copyable-value.html.j2" with copy_from="ci-cd-code-"|add:component.id title="Copy configuration" hide_value=True %}
                            </div>
                        </div>
                        <!-- Docker source type notes -->
                        <template x-if="sourceType === 'docker'">
                            <div x-show="activeTab === 'github'" class="info-notice mb-4 mt-4">
                                <i class="fas fa-info-circle text-info-500 mr-2"></i>
                                <div>
                                    <strong>Note:</strong> For Docker image scanning in GitHub Actions, the action will use GitHub's built-in Docker support. No additional configuration is needed.
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
