{% extends "core/dashboard_base.html.j2" %}
{% load widget_tweaks %}
{% load static %}
{% load django_vite %}
{% block title %}sbomify SBOM Vulnerabilities{% endblock %}
{% block extra_head %}
    <link rel="stylesheet"
          href="{% static 'css/components/sbom-vulnerabilities.css' %}">
{% endblock %}
{% block content %}
    <div class="w-full p-0">
        <h3 class="page-title">Vulnerabilities for SBOM: {{ sbom.name }}</h3>
        <div>
            <div>
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="px-6 py-4 border-b">
                        <div class="flex justify-between items-center">
                            <div>
                                <h5 class="text-lg font-semibold mb-0">Scan Results</h5>
                                {% if sbom_version_info %}
                                    <div class="scan-context mt-2">
                                        <div class="flex items-center gap-3 flex-wrap">
                                            <div class="version-info">
                                                <i class="fas fa-tag mr-1 text-brand-primary"></i>
                                                <strong>{{ sbom_version_info.name }}</strong>
                                                {% if sbom_version_info.version %}
                                                    <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-brand-primary text-white ml-1">{{ sbom_version_info.version }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="format-info">
                                                <i class="fas fa-file-code mr-1 text-success-500"></i>
                                                <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-success-50 text-success-700">
                                                    {{ sbom_version_info.format|upper }} {{ sbom_version_info.format_version }}
                                                </span>
                                            </div>
                                            <div class="source-info">
                                                <i class="fas fa-source-branch mr-1 text-info-500"></i>
                                                <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-info-50 text-info-700">{{ sbom_version_info.source }}</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if scan_timestamp %}<small class="text-gray-600 block mt-2">Last scanned: {{ scan_timestamp }}</small>{% endif %}
                            </div>
                            {% if sbom_version_info and sbom_version_info.version %}
                                <div class="version-highlight">
                                    <div class="text-right">
                                        <div class="text-gray-600 text-sm">Scanning Version</div>
                                        <div class="text-2xl mb-0 text-brand-primary">{{ sbom_version_info.version }}</div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="p-6">
                        {% if vulnerabilities %}
                            {% if vulnerabilities.results %}
                                {% for result in vulnerabilities.results %}
                                    <div class="source-section">
                                        <h5 class="source-title">
                                            <i class="fas fa-file-code mr-2"></i>
                                            Source: {{ result.source.file_path }}
                                        </h5>
                                        {% if result.packages %}
                                            <div class="overflow-x-auto">
                                                <table class="w-full vulnerability-table">
                                                    <thead>
                                                        <tr class="border-b">
                                                            <th class="col-package text-left py-2">Package</th>
                                                            <th class="col-version text-left py-2">Version</th>
                                                            <th class="col-ecosystem text-left py-2">Ecosystem</th>
                                                            <th class="col-vulnerabilities text-left py-2">Vulnerabilities</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for pkg_vuln_info in result.packages %}
                                                            <tr class="border-b">
                                                                <td>
                                                                    <div class="package-name">{{ pkg_vuln_info.package.name }}</div>
                                                                </td>
                                                                <td>
                                                                    <span class="package-version">{{ pkg_vuln_info.package.version }}</span>
                                                                </td>
                                                                <td>
                                                                    <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 ecosystem-badge">{{ pkg_vuln_info.package.ecosystem }}</span>
                                                                </td>
                                                                <td>
                                                                    {% if pkg_vuln_info.vulnerabilities %}
                                                                        {% for vuln in pkg_vuln_info.vulnerabilities %}
                                                                            <div class="vulnerability-card">
                                                                                <div class="vulnerability-header">
                                                                                    <div class="flex-grow-1">
                                                                                        {# Smart external links based on vulnerability source #}
                                                                                        {% if vuln.source == "Dependency Track" %}
                                                                                            {% if vuln.id|slice:":4" == "CVE-" %}
                                                                                                <a href="https://www.cve.org/CVERecord?id={{ vuln.id }}"
                                                                                                   target="_blank"
                                                                                                   class="vulnerability-id">
                                                                                                    <i class="fas fa-external-link-alt mr-1"></i>
                                                                                                    {{ vuln.id }}
                                                                                                </a>
                                                                                            {% elif vuln.id|slice:":5" == "GHSA-" %}
                                                                                                <a href="https://github.com/advisories/{{ vuln.id }}"
                                                                                                   target="_blank"
                                                                                                   class="vulnerability-id">
                                                                                                    <i class="fas fa-external-link-alt mr-1"></i>
                                                                                                    {{ vuln.id }}
                                                                                                </a>
                                                                                            {% else %}
                                                                                                <span class="vulnerability-id">
                                                                                                    <i class="fas fa-bug mr-1"></i>
                                                                                                    {{ vuln.id }}
                                                                                                </span>
                                                                                            {% endif %}
                                                                                        {% else %}
                                                                                            <a href="https://osv.dev/vulnerability/{{ vuln.id }}"
                                                                                               target="_blank"
                                                                                               class="vulnerability-id">
                                                                                                <i class="fas fa-external-link-alt mr-1"></i>
                                                                                                {{ vuln.id }}
                                                                                            </a>
                                                                                        {% endif %}
                                                                                        {% if vuln.aliases %}<div class="vulnerability-aliases">Aliases: {{ vuln.aliases|join:", " }}</div>{% endif %}
                                                                                    </div>
                                                                                    <div class="ml-2 flex items-center gap-2">
                                                                                        {# Use normalized severity field from StandardizedVulnerabilityData #}
                                                                                        {% if vuln.severity and vuln.severity != 'unknown' %}
                                                                                            <span class="severity-badge severity-{{ vuln.severity|lower }}">{{ vuln.severity|upper }}</span>
                                                                                        {% else %}
                                                                                            <span class="severity-badge severity-medium">Medium</span>
                                                                                        {% endif %}
                                                                                        {# Show CVSS score if available #}
                                                                                        {% if vuln.cvss_score %}<span class="cvss-score">CVSS: {{ vuln.cvss_score }}</span>{% endif %}
                                                                                    </div>
                                                                                </div>
                                                                                {# Show full summary with less truncation #}
                                                                                {% if vuln.summary or vuln.details %}
                                                                                    <div class="vulnerability-summary mb-2">{{ vuln.summary|default_if_none:vuln.details|truncatewords:50 }}</div>
                                                                                {% endif %}
                                                                                {# Show references if available with collapsible section #}
                                                                                {% if vuln.references and vuln.references|length > 0 %}
                                                                                    <div class="vulnerability-references">
                                                                                        {% if vuln.references|length <= 3 %}
                                                                                            {# Show all references if 3 or fewer #}
                                                                                            <small class="text-gray-600">References:</small>
                                                                                            {% for ref in vuln.references %}
                                                                                                {% if ref and ref != "" %}
                                                                                                    <a href="{{ ref }}" target="_blank" class="reference-link">
                                                                                                        <i class="fas fa-external-link-alt"></i>
                                                                                                        Reference
                                                                                                    </a>
                                                                                                {% endif %}
                                                                                            {% endfor %}
                                                                                        {% else %}
                                                                                            {# Collapsible section for many references #}
                                                                                            <details class="references-details">
                                                                                                <summary class="references-summary">
                                                                                                    <small class="text-gray-600">
                                                                                                        <i class="fas fa-chevron-right mr-1"></i>
                                                                                                        {{ vuln.references|length }} References (click to expand)
                                                                                                    </small>
                                                                                                </summary>
                                                                                                <div class="references-content mt-2">
                                                                                                    {% for ref in vuln.references %}
                                                                                                        {% if ref and ref != "" %}
                                                                                                            <a href="{{ ref }}" target="_blank" class="reference-link block">
                                                                                                                <i class="fas fa-external-link-alt"></i>
                                                                                                                {{ ref|truncatechars:60 }}
                                                                                                            </a>
                                                                                                        {% endif %}
                                                                                                    {% endfor %}
                                                                                                </div>
                                                                                            </details>
                                                                                        {% endif %}
                                                                                    </div>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <div class="no-vulnerabilities">
                                                                            <i class="fas fa-shield-alt fa-2x mb-2"></i>
                                                                            <div>No vulnerabilities found for this package</div>
                                                                        </div>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="bg-info-50 border border-info-200 text-info-800 px-4 py-3 rounded"
                                                 role="alert">
                                                <i class="fas fa-info-circle mr-2"></i>
                                                No packages with vulnerability information found in this result.
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% if not forloop.last %}<hr class="my-4 border-gray-300" />{% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="bg-info-50 border border-info-200 text-info-800 px-4 py-3 rounded"
                                     role="alert">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Vulnerability scan data found, but no specific results or packages identified. The SBOM
                                    might be empty or not analyzable by the scanner.
                                </div>
                            {% endif %}
                        {% elif error_message %}
                            <div class="bg-danger-50 border border-danger-200 text-danger-800 px-4 py-3 rounded"
                                 role="alert">
                                <h4 class="font-bold mb-1">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Vulnerability Scan Failed
                                </h4>
                                <div class="error-message"
                                     style="white-space: pre-wrap;
                                            word-break: break-word">{{ error_message }}</div>
                                {% if error_details and error_details != error_message %}
                                    <hr class="my-3 border-gray-300" />
                                    <div class="error-details">
                                        <strong>Additional Details:</strong>
                                        <pre class="mt-2 p-3 bg-gray-100 border border-gray-300 rounded"
                                             style="max-height: 300px;
                                                    overflow-y: auto;
                                                    font-size: 0.85rem;
                                                    white-space: pre-wrap;
                                                    word-break: break-word">{{ error_details }}</pre>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            {% if is_processing %}
                                <div class="bg-info-50 border border-info-200 text-info-800 px-4 py-3 rounded"
                                     role="alert"
                                     x-cloak
                                     x-data="sbomVulnerabilitiesRefresh(30000)">
                                    <h4 class="font-bold mb-1">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>
                                        Processing Vulnerability Scan
                                    </h4>
                                    <p>
                                        Your SBOM has been uploaded to {{ processing_provider|default:"the vulnerability scanner" }} and is currently being analyzed for vulnerabilities.
                                        This process typically takes {{ processing_message }}.
                                    </p>
                                    <p class="mb-3">
                                        <small>
                                            <i class="fas fa-clock mr-1"></i>
                                            Started: {{ scan_timestamp }}
                                        </small>
                                    </p>
                                    <div class="flex items-center">
                                        <button class="px-2 py-1 text-sm border border-brand-primary text-brand-primary rounded hover:bg-brand-primary hover:text-white transition-colors"
                                                @click="handleRefresh()">
                                            <i class="fas fa-sync-alt mr-1"></i>
                                            Refresh Page
                                        </button>
                                        <small class="text-gray-600 ml-3">This page will update automatically once processing is complete.</small>
                                    </div>
                                </div>
                                <div x-data
                                     @ws:message.window=" if ($event.detail.type === 'scan_complete' && $event.detail.sbom_id === '{{ sbom.id }}') { location.reload(); } ">
                                </div>
                            {% else %}
                                <div class="bg-warning-50 border border-warning-200 text-warning-800 px-4 py-3 rounded"
                                     role="alert">
                                    <h4 class="font-bold mb-1">
                                        <i class="fas fa-hourglass-half mr-2"></i>
                                        No Scan Data Available
                                    </h4>
                                    <p>
                                        No vulnerability scan data found for this SBOM, or the scan is still in progress. Please
                                        try again later.
                                    </p>
                                    <p class="mb-0">
                                        <small>
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Note: Scans are performed asynchronously. If you just uploaded this SBOM, the scan
                                            might not be complete yet.
                                        </small>
                                    </p>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <a href="{% url 'core:component_item' component_id=sbom.component.id item_type='sboms' item_id=sbom.id %}"
               class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to SBOM Details
            </a>
        </div>
    </div>
{% endblock %}
