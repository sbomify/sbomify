{% extends "core/dashboard_base.htmx.j2" %}
{% load widget_tweaks %}
{% load static %}
{% load django_vite %}
{% block title %}sbomify SBOM Vulnerabilities{% endblock %}
{% block content %}
    <div>
        {# Page Header #}
        <div class="mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-danger/10 flex items-center justify-center">
                    <i class="fas fa-shield-alt text-danger text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-text">Vulnerabilities</h1>
                    <p class="text-text-muted text-sm">SBOM: {{ sbom.name }}</p>
                </div>
            </div>
        </div>
        {# Main Card #}
        <div class="tw-card mb-6">
            {# Card Header with Scan Info #}
            <div class="px-6 py-4 border-b border-border">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h4 class="text-lg font-semibold text-text mb-2">Scan Results</h4>
                        {% if sbom_version_info %}
                            <div class="flex flex-wrap items-center gap-3 p-3 bg-background rounded-lg border-l-4 border-primary">
                                <div class="flex items-center gap-1.5 text-sm">
                                    <i class="fas fa-tag text-primary"></i>
                                    <strong class="text-text">{{ sbom_version_info.name }}</strong>
                                    {% if sbom_version_info.version %}<span class="tw-badge-primary">{{ sbom_version_info.version }}</span>{% endif %}
                                </div>
                                <div class="flex items-center gap-1.5 text-sm">
                                    <i class="fas fa-file-code text-success"></i>
                                    <span class="tw-badge-success">{{ sbom_version_info.format|upper }} {{ sbom_version_info.format_version }}</span>
                                </div>
                                <div class="flex items-center gap-1.5 text-sm">
                                    <i class="fas fa-code-branch text-info"></i>
                                    <span class="tw-badge-info">{{ sbom_version_info.source }}</span>
                                </div>
                            </div>
                        {% endif %}
                        {% if scan_timestamp %}<p class="text-sm text-text-muted mt-2">Last scanned: {{ scan_timestamp }}</p>{% endif %}
                    </div>
                    {% if sbom_version_info and sbom_version_info.version %}
                        <div class="px-4 py-3 bg-primary/5 border border-primary/20 rounded-lg text-right">
                            <div class="text-xs text-text-muted">Scanning Version</div>
                            <div class="text-xl font-bold text-primary font-mono">{{ sbom_version_info.version }}</div>
                        </div>
                    {% endif %}
                </div>
            </div>
            {# Card Body #}
            <div class="p-6">
                {% if vulnerabilities %}
                    {% if vulnerabilities.results %}
                        {% for result in vulnerabilities.results %}
                            <div class="mb-8 {% if not forloop.last %}pb-8 border-b border-border{% endif %}">
                                <h5 class="text-base font-semibold text-text mb-4 pb-2 border-b-2 border-border flex items-center gap-2">
                                    <i class="fas fa-file-code text-text-muted"></i>
                                    Source: {{ result.source.file_path }}
                                </h5>
                                {% if result.packages %}
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead>
                                                <tr class="border-b border-border bg-background/50">
                                                    <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider w-[20%]">Package</th>
                                                    <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider w-[15%]">Version</th>
                                                    <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider w-[15%]">Ecosystem</th>
                                                    <th class="px-4 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider w-[50%]">
                                                        Vulnerabilities
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-border">
                                                {% for pkg_vuln_info in result.packages %}
                                                    <tr class="align-top">
                                                        <td class="px-4 py-4">
                                                            <span class="font-semibold text-text">{{ pkg_vuln_info.package.name }}</span>
                                                        </td>
                                                        <td class="px-4 py-4">
                                                            <span class="font-mono text-sm px-2 py-1 bg-background rounded">{{ pkg_vuln_info.package.version }}</span>
                                                        </td>
                                                        <td class="px-4 py-4">
                                                            <span class="tw-badge-secondary">{{ pkg_vuln_info.package.ecosystem }}</span>
                                                        </td>
                                                        <td class="px-4 py-4">
                                                            {% if pkg_vuln_info.vulnerabilities %}
                                                                {% for vuln in pkg_vuln_info.vulnerabilities %}
                                                                    <div class="p-4 mb-3 bg-surface border border-border rounded-lg hover:shadow-sm transition-shadow {% if forloop.last %}mb-0{% endif %}">
                                                                        <div class="flex flex-wrap justify-between items-start gap-2 mb-2">
                                                                            <div class="flex-1">
                                                                                {# Vulnerability ID with smart links #}
                                                                                {% if vuln.source == "Dependency Track" %}
                                                                                    {% if vuln.id|slice:":4" == "CVE-" %}
                                                                                        <a href="https://www.cve.org/CVERecord?id={{ vuln.id }}"
                                                                                           target="_blank"
                                                                                           class="text-primary font-semibold hover:underline inline-flex items-center gap-1">
                                                                                            <i class="fas fa-external-link-alt text-xs"></i>{{ vuln.id }}
                                                                                        </a>
                                                                                    {% elif vuln.id|slice:":5" == "GHSA-" %}
                                                                                        <a href="https://github.com/advisories/{{ vuln.id }}"
                                                                                           target="_blank"
                                                                                           class="text-primary font-semibold hover:underline inline-flex items-center gap-1">
                                                                                            <i class="fas fa-external-link-alt text-xs"></i>{{ vuln.id }}
                                                                                        </a>
                                                                                    {% else %}
                                                                                        <span class="text-text font-semibold inline-flex items-center gap-1">
                                                                                            <i class="fas fa-bug text-xs"></i>{{ vuln.id }}
                                                                                        </span>
                                                                                    {% endif %}
                                                                                {% else %}
                                                                                    <a href="https://osv.dev/vulnerability/{{ vuln.id }}"
                                                                                       target="_blank"
                                                                                       class="text-primary font-semibold hover:underline inline-flex items-center gap-1">
                                                                                        <i class="fas fa-external-link-alt text-xs"></i>{{ vuln.id }}
                                                                                    </a>
                                                                                {% endif %}
                                                                                {% if vuln.aliases %}<div class="text-xs text-text-muted mt-1">Aliases: {{ vuln.aliases|join:", " }}</div>{% endif %}
                                                                            </div>
                                                                            <div class="flex items-center gap-2">
                                                                                {# Severity Badge #}
                                                                                {% if vuln.severity and vuln.severity != 'unknown' %}
                                                                                    {% if vuln.severity|lower == 'critical' %}
                                                                                        <span class="px-2 py-1 text-xs font-semibold uppercase tracking-wide rounded bg-red-100 text-red-800 border border-red-200">{{ vuln.severity|upper }}</span>
                                                                                    {% elif vuln.severity|lower == 'high' %}
                                                                                        <span class="px-2 py-1 text-xs font-semibold uppercase tracking-wide rounded bg-orange-100 text-orange-800 border border-orange-200">{{ vuln.severity|upper }}</span>
                                                                                    {% elif vuln.severity|lower == 'medium' %}
                                                                                        <span class="px-2 py-1 text-xs font-semibold uppercase tracking-wide rounded bg-yellow-100 text-yellow-800 border border-yellow-200">{{ vuln.severity|upper }}</span>
                                                                                    {% elif vuln.severity|lower == 'low' %}
                                                                                        <span class="px-2 py-1 text-xs font-semibold uppercase tracking-wide rounded bg-green-100 text-green-800 border border-green-200">{{ vuln.severity|upper }}</span>
                                                                                    {% else %}
                                                                                        <span class="px-2 py-1 text-xs font-semibold uppercase tracking-wide rounded bg-gray-100 text-gray-800 border border-gray-200">{{ vuln.severity|upper }}</span>
                                                                                    {% endif %}
                                                                                {% else %}
                                                                                    <span class="px-2 py-1 text-xs font-semibold uppercase tracking-wide rounded bg-yellow-100 text-yellow-800 border border-yellow-200">MEDIUM</span>
                                                                                {% endif %}
                                                                                {# CVSS Score #}
                                                                                {% if vuln.cvss_score %}
                                                                                    <span class="px-2 py-1 text-xs font-semibold rounded bg-background text-text-muted border border-border">CVSS: {{ vuln.cvss_score }}</span>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                        {# Summary #}
                                                                        {% if vuln.summary or vuln.details %}
                                                                            <p class="text-sm text-text-muted leading-relaxed mb-2">
                                                                                {{ vuln.summary|default_if_none:vuln.details|truncatewords:50 }}
                                                                            </p>
                                                                        {% endif %}
                                                                        {# References #}
                                                                        {% if vuln.references and vuln.references|length > 0 %}
                                                                            <div class="mt-2">
                                                                                {% if vuln.references|length <= 3 %}
                                                                                    <span class="text-xs text-text-muted">References:</span>
                                                                                    {% for ref in vuln.references %}
                                                                                        {% if ref and ref != "" %}
                                                                                            <a href="{{ ref }}"
                                                                                               target="_blank"
                                                                                               class="inline-flex items-center gap-1 text-xs text-primary hover:underline mr-2">
                                                                                                <i class="fas fa-external-link-alt"></i>Reference
                                                                                            </a>
                                                                                        {% endif %}
                                                                                    {% endfor %}
                                                                                {% else %}
                                                                                    <details class="group">
                                                                                        <summary class="cursor-pointer text-xs text-text-muted select-none py-1 hover:bg-background rounded inline-flex items-center gap-1">
                                                                                            <i class="fas fa-chevron-right transition-transform group-open:rotate-90"></i>
                                                                                            {{ vuln.references|length }} References (click to expand)
                                                                                        </summary>
                                                                                        <div class="mt-2 pl-4 border-l-2 border-border">
                                                                                            {% for ref in vuln.references %}
                                                                                                {% if ref and ref != "" %}
                                                                                                    <a href="{{ ref }}"
                                                                                                       target="_blank"
                                                                                                       class="block text-xs text-primary hover:underline mb-1">
                                                                                                        <i class="fas fa-external-link-alt mr-1"></i>{{ ref|truncatechars:60 }}
                                                                                                    </a>
                                                                                                {% endif %}
                                                                                            {% endfor %}
                                                                                        </div>
                                                                                    </details>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                {% endfor %}
                                                            {% else %}
                                                                <div class="text-center py-4 px-4 bg-success/5 border border-success/20 rounded-lg">
                                                                    <i class="fas fa-shield-alt text-2xl text-success mb-2"></i>
                                                                    <div class="text-success text-sm">No vulnerabilities found for this package</div>
                                                                </div>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="flex items-start gap-3 p-4 bg-info/5 border border-info/20 rounded-lg">
                                        <i class="fas fa-info-circle text-info mt-0.5"></i>
                                        <p class="text-text text-sm">No packages with vulnerability information found in this result.</p>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="flex items-start gap-3 p-4 bg-info/5 border border-info/20 rounded-lg">
                            <i class="fas fa-info-circle text-info mt-0.5"></i>
                            <p class="text-text text-sm">
                                Vulnerability scan data found, but no specific results or packages identified. The SBOM might be empty or not analyzable by the scanner.
                            </p>
                        </div>
                    {% endif %}
                {% elif error_message %}
                    <div class="p-4 bg-danger/5 border border-danger/20 rounded-lg">
                        <h4 class="text-lg font-semibold text-danger mb-2 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Vulnerability Scan Failed
                        </h4>
                        <div class="text-text whitespace-pre-wrap break-words">{{ error_message }}</div>
                        {% if error_details and error_details != error_message %}
                            <hr class="my-4 border-border" />
                            <div>
                                <strong class="text-text">Additional Details:</strong>
                                <pre class="mt-2 p-4 bg-background border border-border rounded-lg text-sm overflow-auto max-h-[300px] whitespace-pre-wrap break-words">{{ error_details }}</pre>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    {% if is_processing %}
                        <div class="p-4 bg-info/5 border border-info/20 rounded-lg">
                            <h4 class="text-lg font-semibold text-info mb-2 flex items-center gap-2">
                                <i class="fas fa-spinner fa-spin"></i>
                                Processing Vulnerability Scan
                            </h4>
                            <p class="text-text mb-2">
                                Your SBOM has been uploaded to {{ processing_provider|default:"the vulnerability scanner" }} and is currently being analyzed for vulnerabilities.
                                This process typically takes {{ processing_message }}.
                            </p>
                            <p class="text-sm text-text-muted mb-4">
                                <i class="fas fa-clock mr-1"></i>
                                Started: {{ scan_timestamp }}
                            </p>
                            <div class="flex items-center gap-4">
                                <button class="tw-btn-secondary" @click="location.reload()">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh Page
                                </button>
                                <span class="text-sm text-text-muted">This page will update automatically once processing is complete.</span>
                            </div>
                        </div>
                        {# WebSocket-based refresh for scan completion #}
                        <div x-data
                             @ws:message.window="if ($event.detail.type === 'scan_complete' && $event.detail.sbom_id === '{{ sbom.id }}') { location.reload(); }">
                        </div>
                        <script>
                            setTimeout(function() {
                                var wsConnected = window.Alpine && window.Alpine.store('ws') && window.Alpine.store('ws').connected;
                                if (!wsConnected) { location.reload(); }
                            }, 60000);
                            setTimeout(function() { location.reload(); }, 300000);
                        </script>
                    {% else %}
                        <div class="p-4 bg-warning/5 border border-warning/20 rounded-lg">
                            <h4 class="text-lg font-semibold text-warning mb-2 flex items-center gap-2">
                                <i class="fas fa-hourglass-half"></i>
                                No Scan Data Available
                            </h4>
                            <p class="text-text mb-2">
                                No vulnerability scan data found for this SBOM, or the scan is still in progress. Please try again later.
                            </p>
                            <p class="text-sm text-text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Note: Scans are performed asynchronously. If you just uploaded this SBOM, the scan might not be complete yet.
                            </p>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {# Back Button #}
        <a href="{% url 'core:component_item' component_id=sbom.component.id item_type='sboms' item_id=sbom.id %}"
           class="tw-btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Back to SBOM Details
        </a>
    </div>
{% endblock %}
