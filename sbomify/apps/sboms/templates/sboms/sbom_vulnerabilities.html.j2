{% extends "core/dashboard_base.html.j2" %}
{% load widget_tweaks %}
{% load static %}
{% load django_vite %}
{% block title %}sbomify SBOM Vulnerabilities{% endblock %}
{% block extra_head %}
    <link rel="stylesheet"
          href="{% static 'css/components/sbom-vulnerabilities.css' %}">
{% endblock %}
{% block content %}
    <div class="container-fluid p-0">
        <h3 class="page-title">Vulnerabilities for SBOM: {{ sbom.name }}</h3>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0">Scan Results</h5>
                                {% if sbom_version_info %}
                                    <div class="scan-context mt-2">
                                        <div class="d-flex align-items-center gap-3 flex-wrap">
                                            <div class="version-info">
                                                <i class="fas fa-tag me-1 text-primary"></i>
                                                <strong>{{ sbom_version_info.name }}</strong>
                                                {% if sbom_version_info.version %}
                                                    <span class="badge bg-primary ms-1">{{ sbom_version_info.version }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="format-info">
                                                <i class="fas fa-file-code me-1 text-success"></i>
                                                <span class="badge bg-success-subtle text-success">
                                                    {{ sbom_version_info.format|upper }} {{ sbom_version_info.format_version }}
                                                </span>
                                            </div>
                                            <div class="source-info">
                                                <i class="fas fa-source-branch me-1 text-info"></i>
                                                <span class="badge bg-info-subtle text-info">{{ sbom_version_info.source }}</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if scan_timestamp %}<small class="text-muted d-block mt-2">Last scanned: {{ scan_timestamp }}</small>{% endif %}
                            </div>
                            {% if sbom_version_info and sbom_version_info.version %}
                                <div class="version-highlight">
                                    <div class="text-end">
                                        <div class="text-muted small">Scanning Version</div>
                                        <div class="h4 mb-0 text-primary">{{ sbom_version_info.version }}</div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        {% if vulnerabilities %}
                            {% if vulnerabilities.results %}
                                {% for result in vulnerabilities.results %}
                                    <div class="source-section">
                                        <h5 class="source-title">
                                            <i class="fas fa-file-code me-2"></i>
                                            Source: {{ result.source.file_path }}
                                        </h5>
                                        {% if result.packages %}
                                            <div class="table-responsive">
                                                <table class="table vulnerability-table">
                                                    <thead>
                                                        <tr>
                                                            <th class="col-package">Package</th>
                                                            <th class="col-version">Version</th>
                                                            <th class="col-ecosystem">Ecosystem</th>
                                                            <th class="col-vulnerabilities">Vulnerabilities</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for pkg_vuln_info in result.packages %}
                                                            <tr>
                                                                <td>
                                                                    <div class="package-name">{{ pkg_vuln_info.package.name }}</div>
                                                                </td>
                                                                <td>
                                                                    <span class="package-version">{{ pkg_vuln_info.package.version }}</span>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-secondary-subtle text-secondary ecosystem-badge">{{ pkg_vuln_info.package.ecosystem }}</span>
                                                                </td>
                                                                <td>
                                                                    {% if pkg_vuln_info.vulnerabilities %}
                                                                        {% for vuln in pkg_vuln_info.vulnerabilities %}
                                                                            <div class="vulnerability-card">
                                                                                <div class="vulnerability-header">
                                                                                    <div class="flex-grow-1">
                                                                                        {# Smart external links based on vulnerability source #}
                                                                                        {% if vuln.source == "Dependency Track" %}
                                                                                            {% if vuln.id|slice:":4" == "CVE-" %}
                                                                                                <a href="https://www.cve.org/CVERecord?id={{ vuln.id }}"
                                                                                                   target="_blank"
                                                                                                   class="vulnerability-id">
                                                                                                    <i class="fas fa-external-link-alt me-1"></i>
                                                                                                    {{ vuln.id }}
                                                                                                </a>
                                                                                            {% elif vuln.id|slice:":5" == "GHSA-" %}
                                                                                                <a href="https://github.com/advisories/{{ vuln.id }}"
                                                                                                   target="_blank"
                                                                                                   class="vulnerability-id">
                                                                                                    <i class="fas fa-external-link-alt me-1"></i>
                                                                                                    {{ vuln.id }}
                                                                                                </a>
                                                                                            {% else %}
                                                                                                <span class="vulnerability-id">
                                                                                                    <i class="fas fa-bug me-1"></i>
                                                                                                    {{ vuln.id }}
                                                                                                </span>
                                                                                            {% endif %}
                                                                                        {% else %}
                                                                                            <a href="https://osv.dev/vulnerability/{{ vuln.id }}"
                                                                                               target="_blank"
                                                                                               class="vulnerability-id">
                                                                                                <i class="fas fa-external-link-alt me-1"></i>
                                                                                                {{ vuln.id }}
                                                                                            </a>
                                                                                        {% endif %}
                                                                                        {% if vuln.aliases %}<div class="vulnerability-aliases">Aliases: {{ vuln.aliases|join:", " }}</div>{% endif %}
                                                                                    </div>
                                                                                    <div class="ms-2 d-flex align-items-center gap-2">
                                                                                        {# Use normalized severity field from StandardizedVulnerabilityData #}
                                                                                        {% if vuln.severity and vuln.severity != 'unknown' %}
                                                                                            <span class="severity-badge severity-{{ vuln.severity|lower }}">{{ vuln.severity|upper }}</span>
                                                                                        {% else %}
                                                                                            <span class="severity-badge severity-medium">Medium</span>
                                                                                        {% endif %}
                                                                                        {# Show CVSS score if available #}
                                                                                        {% if vuln.cvss_score %}<span class="cvss-score">CVSS: {{ vuln.cvss_score }}</span>{% endif %}
                                                                                    </div>
                                                                                </div>
                                                                                {# Show full summary with less truncation #}
                                                                                {% if vuln.summary or vuln.details %}
                                                                                    <div class="vulnerability-summary mb-2">{{ vuln.summary|default_if_none:vuln.details|truncatewords:50 }}</div>
                                                                                {% endif %}
                                                                                {# Show references if available with collapsible section #}
                                                                                {% if vuln.references and vuln.references|length > 0 %}
                                                                                    <div class="vulnerability-references">
                                                                                        {% if vuln.references|length <= 3 %}
                                                                                            {# Show all references if 3 or fewer #}
                                                                                            <small class="text-muted">References:</small>
                                                                                            {% for ref in vuln.references %}
                                                                                                {% if ref and ref != "" %}
                                                                                                    <a href="{{ ref }}" target="_blank" class="reference-link">
                                                                                                        <i class="fas fa-external-link-alt"></i>
                                                                                                        Reference
                                                                                                    </a>
                                                                                                {% endif %}
                                                                                            {% endfor %}
                                                                                        {% else %}
                                                                                            {# Collapsible section for many references #}
                                                                                            <details class="references-details">
                                                                                                <summary class="references-summary">
                                                                                                    <small class="text-muted">
                                                                                                        <i class="fas fa-chevron-right me-1"></i>
                                                                                                        {{ vuln.references|length }} References (click to expand)
                                                                                                    </small>
                                                                                                </summary>
                                                                                                <div class="references-content mt-2">
                                                                                                    {% for ref in vuln.references %}
                                                                                                        {% if ref and ref != "" %}
                                                                                                            <a href="{{ ref }}" target="_blank" class="reference-link d-block">
                                                                                                                <i class="fas fa-external-link-alt"></i>
                                                                                                                {{ ref|truncatechars:60 }}
                                                                                                            </a>
                                                                                                        {% endif %}
                                                                                                    {% endfor %}
                                                                                                </div>
                                                                                            </details>
                                                                                        {% endif %}
                                                                                    </div>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <div class="no-vulnerabilities">
                                                                            <i class="fas fa-shield-alt fa-2x mb-2"></i>
                                                                            <div>No vulnerabilities found for this package</div>
                                                                        </div>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info" role="alert">
                                                <i class="fas fa-info-circle me-2"></i>
                                                No packages with vulnerability information found in this result.
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% if not forloop.last %}<hr class="my-4" />{% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Vulnerability scan data found, but no specific results or packages identified. The SBOM
                                    might be empty or not analyzable by the scanner.
                                </div>
                            {% endif %}
                        {% elif error_message %}
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Vulnerability Scan Failed
                                </h4>
                                <div class="error-message"
                                     style="white-space: pre-wrap;
                                            word-break: break-word">{{ error_message }}</div>
                                {% if error_details and error_details != error_message %}
                                    <hr />
                                    <div class="error-details">
                                        <strong>Additional Details:</strong>
                                        <pre class="mt-2 p-3 bg-light border rounded"
                                             style="max-height: 300px;
                                                    overflow-y: auto;
                                                    font-size: 0.85rem;
                                                    white-space: pre-wrap;
                                                    word-break: break-word">{{ error_details }}</pre>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            {% if is_processing %}
                                <div class="alert alert-info" role="alert">
                                    <h4 class="alert-heading">
                                        <i class="fas fa-spinner fa-spin me-2"></i>
                                        Processing Vulnerability Scan
                                    </h4>
                                    <p>
                                        Your SBOM has been uploaded to {{ processing_provider|default:"the vulnerability scanner" }} and is currently being analyzed for vulnerabilities.
                                        This process typically takes {{ processing_message }}.
                                    </p>
                                    <p class="mb-3">
                                        <small>
                                            <i class="fas fa-clock me-1"></i>
                                            Started: {{ scan_timestamp }}
                                        </small>
                                    </p>
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-outline-primary btn-sm" @click="location.reload()">
                                            <i class="fas fa-sync-alt me-1"></i>
                                            Refresh Page
                                        </button>
                                        <small class="text-muted ms-3">This page will update automatically once processing is complete.</small>
                                    </div>
                                </div>
                                {# WebSocket-based refresh for scan completion #}
                                <div x-data
                                     @ws:message.window=" if ($event.detail.type === 'scan_complete' && $event.detail.sbom_id === '{{ sbom.id }}') { location.reload(); } ">
                                </div>
                                <script>
                                    // Fallback: Auto-refresh if WebSocket is not available
                                    // Check connection status at reload time rather than at setup time
                                    setTimeout(function() {
                                        var wsConnected = window.Alpine && 
                                                          window.Alpine.store('ws') && 
                                                          window.Alpine.store('ws').connected;
                                        if (!wsConnected) {
                                            // WebSocket not connected, reload the page
                                            location.reload();
                                        }
                                    }, 60000);

                                    // Ultimate fallback: reload after 5 minutes regardless of WebSocket state
                                    // Handles edge cases where WebSocket initialization fails silently
                                    setTimeout(function() {
                                        location.reload();
                                    }, 300000);
                                </script>
                            {% else %}
                                <div class="alert alert-warning" role="alert">
                                    <h4 class="alert-heading">
                                        <i class="fas fa-hourglass-half me-2"></i>
                                        No Scan Data Available
                                    </h4>
                                    <p>
                                        No vulnerability scan data found for this SBOM, or the scan is still in progress. Please
                                        try again later.
                                    </p>
                                    <p class="mb-0">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Note: Scans are performed asynchronously. If you just uploaded this SBOM, the scan
                                            might not be complete yet.
                                        </small>
                                    </p>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <a href="{% url 'core:component_item' component_id=sbom.component.id item_type='sboms' item_id=sbom.id %}"
               class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Back to SBOM Details
            </a>
        </div>
    </div>
{% endblock %}
