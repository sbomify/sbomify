{% load widget_tweaks %}
<div class="card mb-3 entity-card shadow-sm"
     x-data="contactEntity('{{ form.prefix|escapejs }}')"
     x-show="!deleted"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 transform scale-95"
     x-transition:enter-end="opacity-100 transform scale-100"
     @start-edit="editing = true"
     @contact-removed="updateContactCount">
    {# Hidden fields for form management #}
    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
    <input type="hidden" name="{{ form.prefix }}-DELETE" x-model="deleted">
    {# Summary View (Visible when not editing) #}
    <div class="card-body p-0" x-show="!editing" x-transition>
        <div class="d-flex">
            {# Role indicator bar #}
            <div class="d-flex flex-column flex-shrink-0" style="width: 6px;">
                <div class="flex-grow-1"
                     :class="isManufacturer ? 'bg-primary' : 'bg-light'"
                     :title="isManufacturer ? 'Manufacturer' : ''"></div>
                <div class="flex-grow-1"
                     :class="isSupplier ? 'bg-success' : 'bg-light'"
                     :title="isSupplier ? 'Supplier' : ''"></div>
            </div>
            {# Main content #}
            <div class="flex-grow-1 p-3">
                {# Name row with role badges and action buttons #}
                <div class="d-flex align-items-center gap-2 mb-1">
                    <h6 class="mb-0 fw-semibold text-truncate" x-text="name || 'New Entity'"></h6>
                    {# Role badges #}
                    <div class="d-flex gap-1 flex-wrap">
                        <span class="badge bg-primary-subtle text-primary small px-2 py-1"
                              x-show="isManufacturer">Manufacturer</span>
                        <span class="badge bg-success-subtle text-success small px-2 py-1"
                              x-show="isSupplier">Supplier</span>
                    </div>
                    {# Action buttons - far right #}
                    <div class="d-flex align-items-center gap-1 flex-shrink-0 ms-auto">
                        <button type="button"
                                class="btn btn-sm btn-link p-1"
                                @click="editing = true"
                                title="Edit entity">
                            <i class="fas fa-pen text-primary"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-link p-1"
                                @click="removeEntity"
                                title="Remove entity">
                            <i class="fas fa-trash-alt text-danger"></i>
                        </button>
                    </div>
                </div>
                {# Details row #}
                <div class="d-flex flex-wrap align-items-center gap-3 text-muted small">
                    <span x-show="email" class="d-flex align-items-center">
                        <i class="fas fa-envelope me-1 opacity-50"></i>
                        <span x-text="email" class="text-truncate" style="max-width: 200px;"></span>
                    </span>
                    <span class="d-flex align-items-center"
                          :class="activeContactsCount === 0 ? 'text-danger' : ''">
                        <i class="fas fa-users me-1 opacity-50"></i>
                        <span x-text="activeContactsCount + ' contact' + (activeContactsCount !== 1 ? 's' : '')"></span>
                        <i class="fas fa-exclamation-circle ms-1"
                           x-show="activeContactsCount === 0"></i>
                    </span>
                </div>
                <div class="text-danger small fw-semibold mt-1"
                     x-show="!isManufacturer && !isSupplier && touched">
                    <i class="fas fa-exclamation-triangle me-1"></i>Role required
                </div>
            </div>
        </div>
    </div>
    {# Editor Content (Inline) #}
    <div class="entity-editor-content" x-show="editing" x-transition>
        <div class="p-4">
            {# Role Selection - Checkboxes (allows same entity to be both manufacturer AND supplier) #}
            <div class="mb-4 pb-3 border-bottom role-selection">
                <label class="form-label d-block text-center mb-3">
                    Entity Role(s) <span class="text-danger">*</span>
                </label>
                <div class="d-flex gap-4 flex-wrap justify-content-center">
                    <div class="form-check"
                         :title="!canSelectManufacturer && !isManufacturer ? 'Another entity is already assigned as manufacturer' : 'The organization that created or manufactured the component'">
                        <input type="checkbox"
                               class="form-check-input"
                               name="{{ form.prefix }}-is_manufacturer"
                               id="{{ form.prefix }}-role-manufacturer"
                               x-model="isManufacturer"
                               :disabled="!canSelectManufacturer && !isManufacturer"
                               {% if form.instance.is_manufacturer or not form.instance.pk %}checked{% endif %}>
                        <label class="form-check-label" for="{{ form.prefix }}-role-manufacturer">Manufacturer</label>
                    </div>
                    <div class="form-check"
                         :title="!canSelectSupplier && !isSupplier ? 'Another entity is already assigned as supplier' : 'The organization that provided the component'">
                        <input type="checkbox"
                               class="form-check-input"
                               name="{{ form.prefix }}-is_supplier"
                               id="{{ form.prefix }}-role-supplier"
                               x-model="isSupplier"
                               :disabled="!canSelectSupplier && !isSupplier"
                               {% if form.instance.is_supplier or not form.instance.pk %}checked{% endif %}>
                        <label class="form-check-label" for="{{ form.prefix }}-role-supplier">Supplier</label>
                    </div>
                </div>
                <div class="text-muted small text-center mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Select one or both roles. The same entity can be both manufacturer and supplier.
                </div>
                <div class="text-danger small mt-2 fw-semibold text-center"
                     x-show="!isManufacturer && !isSupplier && touched">
                    <i class="fas fa-exclamation-circle me-1"></i>Please select at least one role
                </div>
            </div>
            {# Entity Details Grid #}
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <label class="form-label" for="{{ form.name.id_for_label }}">
                        Entity Name <span class="text-danger">*</span>
                        <i class="fas fa-question-circle text-muted ms-1"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           title="The official name of the organization or company"></i>
                    </label>
                    {{ form.name|add_class:"form-control"|attr:"placeholder:e.g. Acme Corporation"|attr:"x-model.trim:name"|attr:"required:required" }}
                    {% if form.name.errors %}
                        <div class="text-danger small mt-1">
                            <i class="fas fa-exclamation-circle me-1"></i>{{ form.name.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label class="form-label" for="{{ form.email.id_for_label }}">
                        Email Address <span class="text-danger">*</span>
                        <i class="fas fa-question-circle text-muted ms-1"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           title="Primary contact email for the organization"></i>
                    </label>
                    <input type="email"
                           name="{{ form.email.html_name }}"
                           id="{{ form.email.id_for_label }}"
                           class="form-control"
                           placeholder="contact@example.com"
                           x-model.trim="email"
                           required
                           title="Please enter a valid email address (e.g., contact@example.com)"
                           value="{{ form.email.value|default:'' }}">
                    {% if form.email.errors %}
                        <div class="text-danger small mt-1">
                            <i class="fas fa-exclamation-circle me-1"></i>{{ form.email.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label class="form-label" for="{{ form.phone.id_for_label }}">Phone Number</label>
                    {{ form.phone|add_class:"form-control"|attr:"placeholder:+1 555 123 4567"|attr:"x-model.trim:phone"|attr:"title:Contact phone number (optional)" }}
                </div>
                <div class="col-12">
                    <label class="form-label" for="{{ form.address.id_for_label }}">Address</label>
                    {{ form.address|add_class:"form-control"|attr:"rows:2"|attr:"placeholder:123 Main Street, City, State, Country"|attr:"x-model.trim:address"|attr:"title:Physical address of the organization (optional)" }}
                </div>
                <div class="col-12">
                    <label class="form-label" for="{{ form.website_urls_text.id_for_label }}">Website URLs</label>
                    <textarea name="{{ form.website_urls_text.html_name }}"
                              id="{{ form.website_urls_text.id_for_label }}"
                              class="form-control font-monospace small"
                              rows="3"
                              x-model="websites"
                              title="Organization website URLs"
                              placeholder="Enter one URL per line&#10;https://example.com&#10;https://example.org">{{ form.website_urls_text.value|default:'' }}</textarea>
                </div>
            </div>
            <hr class="my-4 border-light">
            {# Contacts Section #}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold">
                    <i class="fas fa-users me-2 text-muted"></i>Entity Contacts
                    <span class="text-danger">*</span>
                    <span class="badge bg-light text-dark ms-2" x-text="activeContactsCount">0</span>
                </h6>
                <button type="button"
                        class="btn btn-sm btn-soft-primary add-contact-btn"
                        @click="addContact"
                        title="Add a contact person for this entity">
                    <i class="fas fa-plus me-1"></i> Add Contact
                </button>
            </div>
            <p class="text-muted small mb-3">
                <i class="fas fa-info-circle me-1"></i>
                Add individuals who represent this organization (e.g., technical lead, security contact).
            </p>
            <div class="alert alert-warning py-2 small mb-3"
                 x-show="activeContactsCount === 0 && !contactsTouched">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>Required:</strong> Add at least one contact person for this entity.
            </div>
            <div class="alert alert-danger py-2 small mb-3"
                 x-show="activeContactsCount === 0 && contactsTouched">
                <i class="fas fa-exclamation-circle me-1"></i>
                <strong>Missing contacts:</strong> Please add at least one contact person before saving.
            </div>
            <div class="contacts-list card shadow-sm" x-show="activeContactsCount > 0">
                {% if contacts_formset %}
                    {{ contacts_formset.management_form }}
                    {% for contact_form in contacts_formset %}
                        {% include "teams/contact_profiles/forms/contact.html.j2" with form=contact_form parent_prefix=form.prefix %}
                    {% endfor %}
                {% endif %}
                <template x-if="false">
                    <div class="contact-template"></div>
                </template>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                <button type="button"
                        class="btn btn-outline-secondary px-4"
                        @click="cancelEdit()">Cancel</button>
                <button type="button" class="btn btn-primary px-4" @click="saveEdit()">
                    <i class="fas fa-check me-1"></i> Done
                </button>
            </div>
        </div>
    </div>
</div>
