{% load widget_tweaks %}
<div class="profile-form"
     x-cloak
     x-data="contactProfileForm('{{ entities_formset.prefix|escapejs }}')"
     @update-counts.window="updateCounts()">
    {# Header with back navigation #}
    <div class="flex items-center gap-4 px-6 py-5 border-b border-border">
        <button type="button"
                class="tw-icon-btn"
                hx-get="{% url 'teams:contact_profiles_list' team.key %}"
                hx-target="#contact-profiles-content"
                hx-swap="innerHTML"
                title="Back to profiles">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div>
            <h5 class="text-xl font-semibold text-text m-0">
                {% if is_create %}
                    Create
                {% else %}
                    Edit
                {% endif %}
                Contact Profile
            </h5>
            <p class="text-sm text-text-muted m-0 mt-0.5">
                {% if is_create %}
                    Create a new reusable contact profile for your components
                {% else %}
                    Update profile information and contacts
                {% endif %}
            </p>
        </div>
    </div>
    <form hx-post="{% if is_create %}{% url 'teams:contact_profiles_form' team.key %}{% else %}{% url 'teams:contact_profiles_detail_form' team.key profile.id %}{% endif %}"
          hx-target="#contact-profiles-content"
          hx-swap="innerHTML"
          hx-disabled-elt="find button[type='submit']"
          @submit="submitForm">
        {% csrf_token %}
        {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
        <div class="p-6">
            {# Profile Details Section #}
            <div class="mb-8">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center">
                        <i class="fas fa-id-card text-primary text-sm"></i>
                    </div>
                    <div>
                        <h6 class="text-base font-semibold text-text m-0">Profile Details</h6>
                        <p class="text-text-muted text-xs m-0">Basic information about this contact profile</p>
                    </div>
                </div>
                <div class="bg-surface border border-border rounded-xl p-5">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-8">
                            <label class="block text-sm font-medium text-text mb-2"
                                   for="{{ form.name.id_for_label }}">
                                Profile Name <span class="text-danger">*</span>
                            </label>
                            <input type="text"
                                   name="{{ form.name.html_name }}"
                                   id="{{ form.name.id_for_label }}"
                                   value="{{ form.name.value|default:'' }}"
                                   class="w-full px-4 py-2.5 border border-border rounded-lg bg-background text-text placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
                                   placeholder="e.g., Default Profile, Engineering Team"
                                   required
                                   title="A unique name to identify this contact profile">
                            <p class="text-xs text-text-muted mt-2">A descriptive name for this collection of contacts</p>
                            {% if form.name.errors %}
                                <div class="text-danger text-sm mt-2 flex items-center gap-1">
                                    <i class="fas fa-exclamation-circle"></i>{{ form.name.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="lg:col-span-4">
                            <label class="block text-sm font-medium text-text mb-2">Default Status</label>
                            <div class="flex items-center gap-3 mt-1">
                                <input type="checkbox"
                                       class="tw-toggle"
                                       name="{{ form.is_default.html_name }}"
                                       id="{{ form.is_default.id_for_label }}"
                                       {% if form.is_default.value %}checked{% endif %}>
                                <label for="{{ form.is_default.id_for_label }}" class="text-sm text-text">Set as default</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {# Entities Section #}
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg bg-success/10 flex items-center justify-center">
                            <i class="fas fa-building text-success text-sm"></i>
                        </div>
                        <div>
                            <h6 class="text-base font-semibold text-text m-0">Entities</h6>
                            <p class="text-text-muted text-xs m-0">Organizations (Manufacturer, Supplier, Author)</p>
                        </div>
                    </div>
                    <button type="button"
                            class="tw-btn-primary tw-btn-sm"
                            @click="addEntity"
                            :disabled="manufacturerCount >= 1 && supplierCount >= 1"
                            :title="manufacturerCount >= 1 && supplierCount >= 1 ? 'Both manufacturer and supplier roles are filled' : 'Add a new entity'">
                        <i class="fas fa-plus mr-1.5"></i>Add Entity
                    </button>
                </div>
                {# Info banner #}
                <div class="flex items-start gap-3 px-4 py-3 rounded-lg bg-info/5 border border-info/20 mb-4 text-sm">
                    <i class="fas fa-info-circle text-info mt-0.5"></i>
                    <p class="m-0 text-text-muted">
                        Each profile can have <strong class="text-text">one manufacturer</strong> and <strong class="text-text">one supplier</strong>.
                        A single entity can fulfill both roles.
                    </p>
                </div>
                {{ entities_formset.management_form }}
                <div id="entities-container" class="space-y-3">
                    {% for entity_form in entities_formset %}
                        {% include "teams/contact_profiles/forms/entity.html.j2" with form=entity_form contacts_formset=entity_form.contacts_formset %}
                    {% endfor %}
                </div>
                {# Empty State for Entities #}
                <div class="text-center py-10 px-6 bg-background/50 rounded-xl border-2 border-dashed border-border"
                     x-show="visibleEntitiesCount === 0"
                     x-transition>
                    <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-border/30 flex items-center justify-center">
                        <i class="fas fa-building text-xl text-text-muted"></i>
                    </div>
                    <h6 class="font-semibold text-text mb-2">No Entities Added</h6>
                    <p class="text-text-muted text-sm mb-4 max-w-xs mx-auto">
                        Add an entity to define the manufacturer, supplier, or author information.
                    </p>
                    <button type="button" class="tw-btn-secondary tw-btn-sm" @click="addEntity">
                        <i class="fas fa-plus mr-1.5"></i>Add Entity
                    </button>
                </div>
            </div>
        </div>
        {# Action Buttons - Sticky Footer #}
        <div class="flex items-center justify-between px-6 py-4 border-t border-border bg-surface/80 backdrop-blur-sm sticky bottom-0">
            <button type="button"
                    class="tw-btn-secondary"
                    hx-get="{% url 'teams:contact_profiles_list' team.key %}"
                    hx-target="#contact-profiles-content"
                    hx-swap="innerHTML">Cancel</button>
            <button type="submit" class="tw-btn-primary" :disabled="hasErrors">
                <i class="fas fa-check mr-2"></i>
                {% if is_create %}
                    Create Profile
                {% else %}
                    Save Changes
                {% endif %}
            </button>
        </div>
        {# Templates for Alpine.js to clone #}
        <template id="entity-template">
            {% include "teams/contact_profiles/forms/entity.html.j2" with form=entities_formset.empty_form contacts_formset=None %}
        </template>
        <template id="contact-template">
            <div class="contact-template-placeholder"></div>
        </template>
    </form>
</div>
