{% load widget_tweaks %}
<div class="profile-form mt-4"
     x-data="contactProfileForm('{{ entities_formset.prefix|escapejs }}')"
     x-init="initForm()">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">
            {% if is_create %}
                Create
            {% else %}
                Edit
            {% endif %}
            Contact Profile
        </h5>
        <div class="d-flex align-items-center">{# Auto-save indicator or other controls can go here #}</div>
    </div>
    <form hx-post="{% if is_create %}{% url 'teams:contact_profiles_form' team.key %}{% else %}{% url 'teams:contact_profiles_detail_form' team.key profile.id %}{% endif %}"
          hx-target="#contact-profiles-content"
          hx-swap="innerHTML"
          @submit.prevent="submitForm">
        {% csrf_token %}
        {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
        {# Profile Level Fields #}
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Profile Name *</label>
                        {{ form.name|add_class:"form-control form-control-lg"|attr:"placeholder:e.g., Default Profile, Engineering Team"|attr:"required:required" }}
                        <div class="form-text">A descriptive name for this collection of contacts.</div>
                        {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4 d-flex align-items-center">
                        <div class="form-check form-switch d-flex align-items-center gap-2 mb-0 pt-2">
                            {{ form.is_default|add_class:"form-check-input"|attr:"role:button" }}
                            <label class="form-check-label fw-bold cursor-pointer"
                                   for="{{ form.is_default.id_for_label }}">Set as Default Profile</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {# Entities Section #}
        <div class="entities-section mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-uppercase text-muted fw-bold small ls-1 mb-0">Entities (Organizations / Suppliers / Authors)</h6>
                <button type="button"
                        class="btn btn-primary btn-sm rounded-pill"
                        @click="addEntity">
                    <i class="fas fa-plus me-1"></i> Add Entity
                </button>
            </div>
            {{ entities_formset.management_form }}
            <div id="entities-container">
                {# Loop through existing forms in the formset #}
                {% for entity_form in entities_formset %}
                    {# Check if this form has a nested contact formset attached #}
                    {# In the view we need to ensure we attach 'contacts_formset' to each entity form #}
                    {% include "teams/contact_profiles/forms/entity.html.j2" with form=entity_form contacts_formset=entity_form.contacts_formset %}
                {% endfor %}
            </div>
            {# Empty State #}
            <div class="text-center p-5 bg-light rounded-3 border border-dashed"
                 x-show="visibleEntitiesCount === 0"
                 x-transition>
                <div class="mb-3 text-muted opacity-50">
                    <i class="fas fa-building fa-3x"></i>
                </div>
                <h6>No Entities Added</h6>
                <p class="text-muted small mb-3">
                    A contact profile must have at least one entity (Manufacturer, Supplier, or Author).
                </p>
                <button type="button"
                        class="btn btn-outline-primary btn-sm"
                        @click="addEntity">Add First Entity</button>
            </div>
        </div>
        {# Action Buttons #}
        <div class="d-flex justify-content-end gap-2 py-3 border-top">
            <button type="button"
                    class="btn btn-outline-secondary"
                    hx-get="{% url 'teams:contact_profiles_list' team.key %}"
                    hx-target="#contact-profiles-content"
                    hx-swap="innerHTML">Cancel</button>
            <button type="submit" class="btn btn-primary px-4" :disabled="hasErrors">
                <i class="fas fa-save me-2"></i>Save Profile
            </button>
        </div>
        {# Templates for Alpine.js to clone #}
        <template id="entity-template">
            {% include "teams/contact_profiles/forms/entity.html.j2" with form=entities_formset.empty_form contacts_formset=None %}
        </template>
        <template id="contact-template">
            {# Note: we use a placeholder form here, specialized logic in JS will adjust prefixes #}
            <div class="contact-template-placeholder"></div>
        </template>
    </form>
</div>
