{% load static %}
<div x-cloak
     x-data="contactProfileList"
     x-init="init()"
     class="tw-data-table">
    {{ profiles|json_script:"profiles-data" }}
    {% if profiles %}
        <div class="tw-data-table-toolbar">
            <div class="tw-data-table-toolbar-left">
                <div class="tw-data-table-search">
                    <i class="fas fa-search tw-data-table-search-icon"></i>
                    <input type="text"
                           id="search-input"
                           placeholder="Search profiles..."
                           x-model="searchQuery"
                           @input="filterProfiles()"
                           class="tw-data-table-search-input">
                </div>
            </div>
        </div>
    {% endif %}
    {% if not profiles %}
        <div class="tw-empty-state py-12 px-6">
            <div class="tw-empty-state-icon">
                <i class="fas fa-address-book text-2xl"></i>
            </div>
            <h4 class="tw-empty-state-title">No contact profiles yet</h4>
            <p class="tw-empty-state-description">Create a profile to reuse supplier information across components.</p>
            <button class="tw-btn-primary"
                    hx-get="{% url 'teams:contact_profiles_form' team.key %}"
                    hx-target="#contact-profiles-content"
                    hx-swap="innerHTML">
                <i class="fas fa-plus mr-2"></i>Create Profile
            </button>
        </div>
    {% else %}
        <div class="tw-data-table-container">
            <table class="tw-table">
                <thead>
                    <tr>
                        <th>
                            <span class="tw-table-sortable"
                                  :class="{ 'sorted-asc': sortColumn === 'name' && sortDirection === 'asc', 'sorted-desc': sortColumn === 'name' && sortDirection === 'desc' }"
                                  @click="sort('name')">
                                Name
                                <span class="tw-table-sort-icon">
                                    <i class="fas fa-caret-up"></i>
                                    <i class="fas fa-caret-down"></i>
                                </span>
                            </span>
                        </th>
                        <th class="w-[120px]">Status</th>
                        <th class="w-[150px]">
                            <span class="tw-table-sortable"
                                  :class="{ 'sorted-asc': sortColumn === 'updated_at' && sortDirection === 'asc', 'sorted-desc': sortColumn === 'updated_at' && sortDirection === 'desc' }"
                                  @click="sort('updated_at')">
                                Last Modified
                                <span class="tw-table-sort-icon">
                                    <i class="fas fa-caret-up"></i>
                                    <i class="fas fa-caret-down"></i>
                                </span>
                            </span>
                        </th>
                        <th class="w-[160px] text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="profile in filteredProfiles" :key="profile.id">
                        <tr x-show="!profile.hidden" x-transition>
                            <td>
                                <div class="flex items-center gap-3">
                                    <div class="tw-avatar tw-avatar-sm bg-primary/10 text-primary">
                                        <i class="fas fa-user text-xs"></i>
                                    </div>
                                    <span class="font-medium text-text" x-text="profile.name"></span>
                                </div>
                            </td>
                            <td>
                                <span class="tw-badge-success" x-show="profile.is_default">
                                    <i class="fas fa-star mr-1 text-[10px]"></i>Default
                                </span>
                            </td>
                            <td>
                                <span class="text-text-muted text-sm"
                                      x-text="formatDate(profile.updated_at)"></span>
                            </td>
                            <td>
                                <div class="flex gap-1 justify-end items-center"
                                     role="group"
                                     aria-label="Profile actions">
                                    <button type="button"
                                            class="tw-icon-btn tw-icon-btn-sm"
                                            title="Edit Profile"
                                            @click="editProfile(profile.id)">
                                        <i class="far fa-edit"></i>
                                    </button>
                                    <button type="button"
                                            class="tw-icon-btn tw-icon-btn-sm"
                                            :class="profile.is_default ? 'text-warning bg-warning/10' : ''"
                                            :title="profile.is_default ? 'Default Profile' : 'Set as Default'"
                                            :disabled="profile.is_default"
                                            @click="setDefaultProfile(profile.id)">
                                        <i :class="profile.is_default ? 'fas fa-star' : 'far fa-star'"></i>
                                    </button>
                                    <button type="button"
                                            class="tw-icon-btn tw-icon-btn-sm text-text-muted hover:text-danger hover:bg-danger/10"
                                            title="Delete Profile"
                                            @click="$dispatch('open-delete-contact-profile-modal', { displayName: profile.name, formData: { profile_id: profile.id } })">
                                        <i class="fas fa-trash-can"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {# Collapsible Preview Row #}
                        <tr x-show="expandedProfiles.includes(profile.id)"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0"
                            x-transition:enter-end="opacity-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100"
                            x-transition:leave-end="opacity-0">
                            <td colspan="4" class="bg-background/50 p-4">
                                {% include "teams/contact_profiles/partials/profile_details.html.j2" %}
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <template x-if="filteredProfiles.length === 0 && profiles.length > 0">
                <div class="tw-empty-state py-8">
                    <div class="tw-empty-state-icon bg-border/30">
                        <i class="fas fa-search text-xl text-text-muted"></i>
                    </div>
                    <h4 class="tw-empty-state-title text-base">No matches found</h4>
                    <p class="tw-empty-state-description">No profiles match your search criteria</p>
                </div>
            </template>
        </div>
    {% endif %}
</div>
{% include "components/modals/delete_modal.html.j2" with modal_id="delete-contact-profile-modal" modal_title="Delete Contact Profile" message_text="Are you sure you want to delete" warning_text="This action cannot be undone. The contact profile will be permanently removed." form_action=request.path form=form submit_text="Delete Profile" use_htmx=True hx_target="#contact-profiles-content" hx_swap="innerHTML" %}
