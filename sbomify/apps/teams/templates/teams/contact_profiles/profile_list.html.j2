{% load static %}
<div x-cloak x-data="contactProfileList" x-init="init()">
    {{ profiles|json_script:"profiles-data" }}
    {% if profiles %}
        <div class="mb-4">
            <label for="search-input" class="block text-xs text-gray-600 mb-1">Search</label>
            <input type="text"
                   id="search-input"
                   class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-transparent"
                   placeholder="Search by profile name..."
                   x-model="searchQuery"
                   @input="filterProfiles()">
        </div>
    {% endif %}
    {% if not profiles %}
        <div class="empty-state">
            <i class="fas fa-address-book fa-3x text-gray-600 mb-3"></i>
            <h5 class="text-gray-600 mb-2">No contact profiles yet</h5>
            <p class="text-gray-600">Create a profile to reuse supplier information across components.</p>
            <button class="px-4 py-2 bg-brand-primary text-white rounded hover:opacity-90 transition-opacity mt-3"
                    hx-get="{% url 'teams:contact_profiles_form' team.key %}"
                    hx-target="#contact-profiles-content"
                    hx-swap="morph">
                <i class="fas fa-plus mr-1"></i> Create Profile
            </button>
        </div>
    {% else %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b">
                        <th scope="col" class="text-left py-2">Name</th>
                        <th scope="col" class="text-left py-2" style="width: 120px;">Status</th>
                        <th scope="col" class="text-left py-2" style="width: 150px;">Last Modified</th>
                        <th scope="col" class="text-right py-2" style="width: 160px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="profile in filteredProfiles" :key="profile.id">
                        <tr x-show="!profile.hidden" x-transition class="border-b">
                            <td class="py-2">
                                <div class="font-semibold" x-text="profile.name"></div>
                            </td>
                            <td class="py-2">
                                <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-success-50 text-success-700"
                                      x-show="profile.is_default">Default</span>
                            </td>
                            <td class="py-2">
                                <span class="text-gray-600 text-sm" x-text="formatDate(profile.updated_at)"></span>
                            </td>
                            <td class="text-right py-2">
                                <div class="flex gap-2 justify-end items-center"
                                     role="group"
                                     aria-label="Profile actions">
                                    <button type="button"
                                            class="btn-icon btn-icon-edit"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            data-bs-title="Edit Profile"
                                            :hx-get="`{% url 'teams:contact_profiles_detail_form' team.key '0000' %}`.replace('0000', profile.id)"
                                            hx-target="#contact-profiles-content"
                                            hx-swap="morph">
                                        <i class="far fa-edit"></i>
                                    </button>
                                    <button type="button"
                                            :class="profile.is_default ? 'btn-icon btn-icon-star-active' : 'btn-icon btn-icon-star'"
                                            :data-bs-title="profile.is_default ? 'Default Profile' : 'Set as Default'"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            :disabled="profile.is_default"
                                            hx-post="{% url 'teams:contact_profiles_list' team.key %}"
                                            hx-disabled-elt="this"
                                            :hx-vals="JSON.stringify({'_method': 'PATCH', 'profile_id': profile.id})"
                                            hx-target="#contact-profiles-content"
                                            hx-swap="morph">
                                        <i :class="profile.is_default ? 'fas fa-star' : 'far fa-star'"></i>
                                    </button>
                                    <button type="button"
                                            class="btn-icon btn-icon-delete"
                                            title="Delete Profile"
                                            @click="$dispatch('open-delete-modal', { id: 'delete-contact-profile-modal', button: $el })"
                                            :data-form-profile_id="profile.id"
                                            :data-display-name="profile.name">
                                        <i class="fas fa-trash-can"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {# Collapsible Preview Row #}
                        <tr x-show="expandedProfiles.includes(profile.id)"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0"
                            x-transition:enter-end="opacity-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100"
                            x-transition:leave-end="opacity-0">
                            <td colspan="4" class="bg-gray-100 p-4">{% include "teams/contact_profiles/partials/profile_details.html.j2" %}</td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <template x-if="filteredProfiles.length === 0 && profiles.length > 0">
                <div class="text-center py-5 text-gray-600">
                    <i class="fas fa-search fa-2x mb-2 opacity-50"></i>
                    <p class="mb-0">No profiles match your search criteria</p>
                </div>
            </template>
        </div>
    {% endif %}
</div>
{% include "components/modals/delete_modal.html.j2" with modal_id="delete-contact-profile-modal" modal_title="Delete Contact Profile" message_text="Are you sure you want to delete" warning_text="This action cannot be undone. The contact profile will be permanently removed." form_action=request.path form=form submit_text="Delete Profile" use_htmx=True hx_target="#contact-profiles-content" hx_swap="morph" %}
