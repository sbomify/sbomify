{% extends "core/dashboard_base.htmx.j2" %}
{% load django_vite %}
{% load widget_tweaks %}
{% load teams %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" href="{% static 'css/components/teams-list.css' %}">
{% endblock %}
{% block title %}sbomify Workspace Dashboard{% endblock %}
{% block dashboard_content %}
    {% include "core/base_messages.html.j2" %}
    <div class="page-header mb-4">
        <div class="header-main">
            <div class="title-section">
                <h1 class="item-title">
                    <i class="fas fa-users mr-3 text-brand-primary"></i>Workspaces
                </h1>
                <p class="item-subtitle">Manage your collaborative workspaces</p>
            </div>
            <div class="header-actions">
                <button class="px-4 py-2 bg-brand-primary text-white rounded hover:opacity-90 transition-opacity"
                        @click="$dispatch('open-modal', { id: 'add-workspace-modal' })">
                    <i class="fas fa-plus mr-2"></i>
                    Add Workspace
                </button>
            </div>
        </div>
    </div>
    <div class="standard-card mt-3">
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b">
                <div class="flex items-center justify-between">
                    <h4 class="text-lg font-semibold mb-0">Your Workspaces</h4>
                    <div class="header-actions">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-primary-bg-subtle text-brand-primary">
                                {# djlint:off #}
                                {{ teams|length }} workspace{% if teams|length != 1 %}s{% endif %}
                                {# djlint:on #}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="teams-grid">
                    {% for team in teams %}
                        <div class="team-card">
                            <div class="team-card-header">
                                <div class="team-info">
                                    {% current_member team.members as me %}
                                    <h6 class="team-name">
                                        <a href="{% url 'teams:team_settings' team.key %}"
                                           class="text-decoration-none">{{ team.name|workspace_display }}</a>
                                        {% if request.session.current_team and request.session.current_team.key == team.key %}
                                            <span class="badge bg-success ms-2">
                                                <i class="fas fa-eye me-1" aria-hidden="true"></i>
                                                Current
                                            </span>
                                        {% endif %}
                                        {% if team.is_default_team %}<span class="badge bg-primary ms-2">Default</span>{% endif %}
                                    </h6>
                                    <div class="team-meta">
                                        <span class="meta-item"><i class="fas fa-user-tag mr-1"></i>{{ me.role }}</span>
                                        <span class="meta-divider">•</span>
                                        <span class="meta-item"><i class="fas fa-users mr-1"></i>{{ team.members|length }} member
                                            {% if team.members|length != 1 %}s{% endif %}
                                        </span>
                                        {% if team.invitations|length > 0 %}
                                            <span class="meta-divider">•</span>
                                            <span class="meta-item"><i class="fas fa-envelope mr-1"></i>{{ team.invitations|length }} pending</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="team-actions">
                                    <div>
                                        <form method="post" action="{{ request.path }}" class="inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="_method" value="PATCH">
                                            <input type="hidden" name="key" value="{{ team.key }}">
                                            <button type="submit"
                                                    title="{% if me.is_default_team %}Already default workspace{% else %}Make default workspace{% endif %}"
                                                    class="px-2 py-1 text-sm border border-brand-primary text-brand-primary rounded hover:bg-brand-primary hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                    {% if me.is_default_team %}disabled{% endif %}>
                                                <i class="fas fa-star"></i>
                                            </button>
                                        </form>
                                        {% if me.role == 'owner' %}
                                            <a href="{% url 'teams:invite_user' team.key %}"
                                               title="Invite user"
                                               class="px-2 py-1 text-sm border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                                                <i class="fas fa-user-plus"></i>
                                            </a>
                                        {% endif %}
                                        {% if me.role == 'owner' and not me.is_default_team %}
                                            <button type="button"
                                                    class="px-2 py-1 text-sm border border-danger-500 text-danger-500 rounded hover:bg-danger-500 hover:text-white transition-colors"
                                                    title="Delete workspace"
                                                    data-form-key="{{ team.key }}"
                                                    data-display-name="{{ team.name|workspace_display }}"
                                                    @click="$dispatch('open-delete-modal', { id: 'delete-workspace-modal', button: $el })">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {# add-workspace modal is already included globally in base templates; avoid duplicating IDs #}
    {% include "components/modals/delete_modal.html.j2" with modal_id="delete-workspace-modal" modal_title="Delete Workspace" message_text="Are you sure you want to delete the workspace" warning_text="This action cannot be undone and will permanently remove the workspace and all associated data from the system." form_action=request.path form=delete_form submit_text="Delete Workspace" %}
{% endblock %}
