{% load teams %}
{% user_workspaces as available_workspaces %}
<div class="flex items-center">
    <div class="relative" x-data="{ open: false }" @click.away="open = false">
        {# Mobile Toggle #}
        <button class="p-2 text-text-muted hover:text-text transition-colors md:hidden relative"
                type="button"
                @click="open = !open"
                title="Switch workspace"
                aria-label="Workspace menu (mobile)">
            <i class="fas fa-building"></i>
            {% if request.session.current_team %}
                <span class="absolute top-1 right-1 w-2 h-2 bg-success rounded-full"></span>
            {% endif %}
        </button>
        {% with current_view_name=request.resolver_match.namespaces.0|add:":"|add:request.resolver_match.url_name %}
            {# Desktop Toggle #}
            <button class="hidden md:flex items-center gap-2 px-3 py-2 rounded-lg text-text hover:bg-background/50 transition-colors"
                    type="button"
                    @click="open = !open"
                    title="Switch workspace"
                    aria-label="Select workspace">
                <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-building text-primary text-sm"></i>
                </div>
                <div class="text-left">
                    <span class="text-xs text-text-muted block">Workspace</span>
                    <span class="text-sm font-semibold text-text">
                        {% if request.session.current_team %}
                            {{ request.session.current_team.name|workspace_display }}
                        {% else %}
                            Select Workspace
                        {% endif %}
                    </span>
                </div>
                {% if request.session.current_team %}<span class="w-2 h-2 bg-success rounded-full"></span>{% endif %}
                <i class="fas fa-chevron-down text-text-muted text-xs ml-1 transition-transform"
                   :class="open ? 'rotate-180' : ''"></i>
            </button>
            {# Dropdown Menu #}
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 class="absolute right-0 mt-2 w-64 bg-surface border border-border rounded-xl shadow-lg z-50 overflow-hidden"
                 @click.away="open = false">
                <div class="px-4 py-2 border-b border-border">
                    <h6 class="text-xs uppercase text-text-muted font-semibold tracking-wider">Switch Workspace</h6>
                </div>
                <div class="py-1">
                    {% for t_key, t_info in available_workspaces.items %}
                        <a class="flex items-center justify-between px-4 py-2 text-sm hover:bg-background/50 transition-colors no-underline {% if current_workspace_key == t_key %}bg-primary/5{% endif %}"
                           href="{% url 'teams:switch_team' t_key %}?next={{ current_view_name }}">
                            <div class="flex items-center gap-2.5">
                                <span class="w-7 h-7 rounded-md bg-primary/10 flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-building text-primary text-xs"></i>
                                </span>
                                <span class="text-text">{{ t_info.name|workspace_display }}</span>
                            </div>
                            {% if current_workspace_key == t_key %}<i class="fas fa-check text-success"></i>{% endif %}
                        </a>
                    {% endfor %}
                </div>
            </div>
        {% endwith %}
    </div>
</div>
