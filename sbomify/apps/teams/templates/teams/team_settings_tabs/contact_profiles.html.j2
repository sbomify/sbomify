{% load static %}
<link rel="stylesheet"
      href="{% static 'css/components/contact-profiles.css' %}">
<div class="card shadow-md">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Contact Profiles</h5>
        <button class="btn btn-primary btn-sm"
                hx-get="{% url 'teams:contact_profiles_form' team.key %}"
                hx-target="#contact-profiles-content"
                hx-swap="innerHTML">
            <i class="fas fa-plus me-1"></i>
            Add Profile
        </button>
    </div>
    <div class="card-body">
        <div id="contact-profiles-content"
             hx-get="{% url 'teams:contact_profiles_list' team.key %}"
             hx-trigger="load, refreshProfileList from:body"
             hx-swap="innerHTML">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading contact profiles...</p>
            </div>
        </div>
    </div>
</div>
<script>
    function initAlpineComponents() {
        if (!window.Alpine) {
            document.addEventListener('alpine:init', initAlpineComponents);
            return;
        }

        // Only register if not already registered (idempotent)
        if (window._alpineContactProfilesInitialized) return;
        window._alpineContactProfilesInitialized = true;

    Alpine.data('contactProfileForm', (entitiesPrefix) => ({
        entitiesPrefix: entitiesPrefix,
        visibleEntitiesCount: 0,
        
        initForm() {
            this.updateCounts();
        },
        
        get hasErrors() {
            return document.querySelectorAll('.is-invalid').length > 0;
        },

        addEntity() {
            const container = document.getElementById('entities-container');
            const totalFormsInput = document.querySelector(`input[name="${this.entitiesPrefix}-TOTAL_FORMS"]`);
            const currentCount = parseInt(totalFormsInput.value);
            
            const template = document.getElementById('entity-template').content.cloneNode(true);
            const newRow = document.createElement('div');
            newRow.appendChild(template);
            
            // Replace prefix in inputs
            const newHtml = newRow.innerHTML.replace(/__prefix__/g, currentCount);
            newRow.innerHTML = newHtml;

            // Handle the nested contact formset management form
            const entityPrefix = `${this.entitiesPrefix}-${currentCount}`;
            const contactPrefix = `${entityPrefix}-contacts`;
            
            const mgmtDiv = document.createElement('div');
            mgmtDiv.innerHTML = `
                <input type="hidden" name="${contactPrefix}-TOTAL_FORMS" value="0" id="id_${contactPrefix}-TOTAL_FORMS">
                <input type="hidden" name="${contactPrefix}-INITIAL_FORMS" value="0" id="id_${contactPrefix}-INITIAL_FORMS">
                <input type="hidden" name="${contactPrefix}-MIN_NUM_FORMS" value="0" id="id_${contactPrefix}-MIN_NUM_FORMS">
                <input type="hidden" name="${contactPrefix}-MAX_NUM_FORMS" value="1000" id="id_${contactPrefix}-MAX_NUM_FORMS">
            `;
            // Add management form to the contacts-list inside entity-editor-content
            const contactsList = newRow.querySelector('.contacts-list');
            if (contactsList) {
                contactsList.insertBefore(mgmtDiv, contactsList.firstChild);
            }

            container.appendChild(newRow.firstElementChild);
            const newEntityEl = container.lastElementChild;
            
            totalFormsInput.value = currentCount + 1;
            
            // Initialize Alpine on the new element
            if (window.Alpine) {
                Alpine.initTree(newEntityEl);
            }
            
            this.updateCounts();
            
            // Auto-open the editor for the new entity (small delay to ensure Alpine is ready)
            setTimeout(() => {
                if (newEntityEl) {
                    const alpineData = Alpine.$data(newEntityEl);
                    if (alpineData) {
                        alpineData.editing = true;
                    }
                    // Scroll to the new entity
                    newEntityEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        },
        
        submitForm(e) {
            const form = this.$el.querySelector('form');
            
            // Remove required attributes from all deleted/hidden contacts before validation
            document.querySelectorAll('.contact-card').forEach(card => {
                const deleteInput = card.querySelector('input[name$="-DELETE"]');
                const isDeleted = deleteInput && (deleteInput.value === 'true' || deleteInput.value === true);
                const isHidden = card.style.display === 'none' || !card.offsetParent;
                
                if (isDeleted || isHidden) {
                    card.querySelectorAll('input[required]').forEach(input => {
                        input.removeAttribute('required');
                    });
                }
            });
            
            // Mark all entity forms as touched to show validation errors
            document.querySelectorAll('.entity-card').forEach(card => {
                const alpineData = Alpine.$data(card);
                if (alpineData && !alpineData.deleted) {
                    alpineData.touched = true;
                }
            });
            
            // Check for entity-level validation (roles)
            const hasRoleErrors = Array.from(document.querySelectorAll('.entity-card')).some(card => {
                const alpineData = Alpine.$data(card);
                return alpineData && !alpineData.deleted && !alpineData.hasRole;
            });
            
            if (hasRoleErrors) {
                // Find first entity with role error and scroll to it
                const errorEntity = document.querySelector('.entity-card');
                if (errorEntity) {
                    errorEntity.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            if (form.reportValidity()) {
                htmx.trigger(form, 'htmx:submit');
            }
        },
        
        updateCounts() {
             this.visibleEntitiesCount = document.querySelectorAll('.entity-card:not([style*="display: none"])').length;
        }
    }));

    Alpine.data('contactEntity', (prefix) => ({
        name: '',
        email: '',
        phone: '',
        address: '',
        websites: '',
        isManufacturer: true,
        isSupplier: true,
        isAuthor: true,
        deleted: false,
        activeContactsCount: 0,
        touched: false,
        editing: false,
        isNew: false,
        snapshot: null,
        
        init() {
            // Sync initial values from DOM inputs using specific prefix
            const nameInput = document.querySelector(`input[name="${prefix}-name"]`);
            if (nameInput) this.name = nameInput.value.trim();
            
            const emailInput = document.querySelector(`input[name="${prefix}-email"]`);
            if (emailInput) this.email = emailInput.value.trim();

            const phoneInput = document.querySelector(`input[name="${prefix}-phone"]`);
            if (phoneInput) this.phone = phoneInput.value.trim();

            const addressInput = document.querySelector(`textarea[name="${prefix}-address"]`);
            if (addressInput) this.address = addressInput.value.trim();

            const webInput = document.querySelector(`textarea[name="${prefix}-website_urls_text"]`);
            if (webInput) this.websites = webInput.value;

            const mfgInput = document.querySelector(`input[name="${prefix}-is_manufacturer"]`);
            const suppInput = document.querySelector(`input[name="${prefix}-is_supplier"]`);
            const authInput = document.querySelector(`input[name="${prefix}-is_author"]`);
            
            // Detect if this is a new entity (no name yet)
            this.isNew = !this.name;
            
            // For existing entities, sync from DOM; for new entities, keep defaults (all true)
            if (!this.isNew) {
                if (mfgInput) this.isManufacturer = mfgInput.checked;
                if (suppInput) this.isSupplier = suppInput.checked;
                if (authInput) this.isAuthor = authInput.checked;
            } else {
                // Apply defaults to the checkboxes for new entities
                if (mfgInput) mfgInput.checked = true;
                if (suppInput) suppInput.checked = true;
                if (authInput) authInput.checked = true;
            }
            
            this.$watch('deleted', () => {
                this.$dispatch('update-counts'); 
            });
            
            // Watch editing state to create snapshot when editing starts
            this.$watch('editing', (value) => {
                if (value && !this.snapshot) {
                    this.createSnapshot();
                }
            });
            
            this.updateContactCount();
        },

        get hasRole() {
            return this.isManufacturer || this.isSupplier || this.isAuthor;
        },

        get hasErrors() {
            if (this.deleted) return false;
            return !this.name || !this.email || !this.hasRole;
        },

        createSnapshot() {
            this.snapshot = {
                name: this.name,
                email: this.email,
                phone: this.phone,
                address: this.address,
                websites: this.websites,
                isManufacturer: this.isManufacturer,
                isSupplier: this.isSupplier,
                isAuthor: this.isAuthor
            };
        },

        saveEdit() {
            this.touched = true;
            
            // Use browser native validation for name and email
            const nameInput = document.querySelector(`input[name="${prefix}-name"]`);
            const emailInput = document.querySelector(`input[name="${prefix}-email"]`);
            
            // Check name
            if (nameInput && !this.name) {
                nameInput.reportValidity();
                return;
            }
            
            // Check email
            if (emailInput && !this.email) {
                emailInput.reportValidity();
                return;
            }
            
            // Check roles (no native validation for checkboxes, show inline message and scroll)
            if (!this.hasRole) {
                // Use $nextTick to ensure DOM is updated before scrolling
                this.$nextTick(() => {
                    const mfgCheckbox = document.querySelector(`input[name="${prefix}-is_manufacturer"]`);
                    if (mfgCheckbox) {
                        mfgCheckbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        mfgCheckbox.focus();
                    }
                });
                return;
            }
            
            // Validate contact fields before saving
            const contactPrefix = `${prefix}-contacts`;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            let hasContactError = false;
            
            document.querySelectorAll(`input[name^="${contactPrefix}-"][name$="-name"]`).forEach(contactNameInput => {
                if (hasContactError) return;
                
                const contactCard = contactNameInput.closest('.contact-card');
                if (!contactCard) return;
                
                const contactEmailInput = contactCard.querySelector('input[name$="-email"]');
                const deleteInput = contactCard.querySelector('input[name$="-DELETE"]');
                
                const isDeleted = deleteInput && (deleteInput.value === 'true' || deleteInput.value === true);
                const isHidden = contactCard.style.display === 'none' || !contactCard.offsetParent;
                
                // Skip deleted/hidden contacts
                if (isDeleted || isHidden) return;
                
                const contactNameValue = contactNameInput.value.trim();
                const contactEmailValue = contactEmailInput ? contactEmailInput.value.trim() : '';
                
                // If name is filled but email is empty
                if (contactNameValue && !contactEmailValue) {
                    contactEmailInput.setCustomValidity('Email is required for this contact');
                    contactEmailInput.reportValidity();
                    hasContactError = true;
                    return;
                }
                
                // If email is filled but format is invalid
                if (contactEmailValue && !emailRegex.test(contactEmailValue)) {
                    contactEmailInput.setCustomValidity('Please enter a valid email address');
                    contactEmailInput.reportValidity();
                    hasContactError = true;
                    return;
                }
                
                // Clear any previous custom validity
                if (contactEmailInput) {
                    contactEmailInput.setCustomValidity('');
                }
            });
            
            if (hasContactError) {
                return;
            }
            
            // Remove empty contact rows before saving
            document.querySelectorAll(`input[name^="${contactPrefix}-"][name$="-name"]`).forEach(nameInput => {
                const contactCard = nameInput.closest('.contact-card');
                if (!contactCard) return;
                
                const emailInput = contactCard.querySelector('input[name$="-email"]');
                const deleteInput = contactCard.querySelector('input[name$="-DELETE"]');
                
                const nameValue = nameInput.value.trim();
                const emailValue = emailInput ? emailInput.value.trim() : '';
                const isDeleted = deleteInput && (deleteInput.value === 'true' || deleteInput.value === true);
                const isHidden = contactCard.style.display === 'none' || !contactCard.offsetParent;
                
                // If both name and email are empty, mark as deleted
                if (!nameValue && !emailValue && !isDeleted) {
                    if (deleteInput) {
                        deleteInput.value = 'true';
                    }
                    contactCard.querySelectorAll('input[required]').forEach(input => {
                        input.removeAttribute('required');
                    });
                    contactCard.style.display = 'none';
                }
                
                // Also remove required from any already deleted/hidden contacts
                if (isDeleted || isHidden) {
                    contactCard.querySelectorAll('input[required]').forEach(input => {
                        input.removeAttribute('required');
                    });
                }
            });
            
            this.isNew = false;
            this.snapshot = null;
            this.editing = false;
            
            // Update contact count after removing empty contacts
            this.$nextTick(() => this.updateContactCount());
        },

        cancelEdit() {
            // Revert to snapshot if exists
            if (this.snapshot) {
                this.name = this.snapshot.name;
                this.email = this.snapshot.email;
                this.phone = this.snapshot.phone;
                this.address = this.snapshot.address;
                this.websites = this.snapshot.websites;
                this.isManufacturer = this.snapshot.isManufacturer;
                this.isSupplier = this.snapshot.isSupplier;
                this.isAuthor = this.snapshot.isAuthor;
            }
            // If new entity with no saved data, remove it
            if (this.isNew) {
                this.deleted = true;
            }
            this.snapshot = null;
            this.editing = false;
            this.touched = false;
        },

        removeEntity() {
             this.deleted = true;
             this.editing = false;
        },
        
        addContact() {
             const listContainer = this.$root.querySelector('.contacts-list');
             if (listContainer) {
                 window.addContactRow(listContainer, prefix);
                 this.$nextTick(() => {
                     this.updateContactCount();
                 });
             }
        },

        updateContactCount() {
             if (this.deleted) {
                 this.activeContactsCount = 0;
                 return;
             }
             this.$nextTick(() => {
                 const list = this.$root.querySelector('.contacts-list');
                 if (list) {
                     const cards = list.querySelectorAll('.contact-card');
                     let count = 0;
                     cards.forEach(card => {
                         const deleteInput = card.querySelector('input[name$="-DELETE"]');
                         // Count if no delete input found (shouldn't happen) or if it's not marked deleted
                         if (!deleteInput || deleteInput.value !== 'true') {
                             count++;
                         }
                     });
                     this.activeContactsCount = count;
                 }
             });
        }
    }));
    
    Alpine.data('contactEntry', () => ({
        deleted: false,
        isNew: true,
        name: '',
        email: '',
        
        init() {
            // Sync from DOM inputs
            const nameInput = this.$el.querySelector('input[name$="-name"]');
            const emailInput = this.$el.querySelector('input[name$="-email"]');
            
            if (nameInput) {
                this.name = nameInput.value.trim();
                this.isNew = !this.name;
                // Watch for changes
                nameInput.addEventListener('input', () => {
                    this.name = nameInput.value.trim();
                });
                nameInput.addEventListener('blur', () => this.checkEmpty());
            }
            
            if (emailInput) {
                this.email = emailInput.value.trim();
                emailInput.addEventListener('input', () => {
                    this.email = emailInput.value.trim();
                });
                emailInput.addEventListener('blur', () => this.checkEmpty());
            }
        },
        
        get isEmpty() {
            return !this.name && !this.email;
        },
        
        checkEmpty() {
            // Auto-remove new empty contacts when user leaves the fields
            if (this.isNew && this.isEmpty) {
                this.$nextTick(() => {
                    // Check again after a short delay to allow for tab navigation
                    setTimeout(() => {
                        if (this.isEmpty && !this.$el.contains(document.activeElement)) {
                            this.removeContact();
                        }
                    }, 200);
                });
            }
        },
        
        removeContact() {
            this.deleted = true;
            this.$dispatch('contact-removed');
        }
    }));
    
    Alpine.data('contactProfileList', () => ({
        profiles: [],
        filteredProfiles: [],
        searchQuery: '',
        expandedProfiles: [],
        
        init() {
            this.$nextTick(() => {
                const profilesScript = document.getElementById('profiles-data');
                if (profilesScript) {
                    try {
                        this.profiles = JSON.parse(profilesScript.textContent);
                        this.filteredProfiles = this.profiles.map(p => ({...p, hidden: false}));
                    } catch (e) {
                        this.profiles = [];
                    }
                }
            });
        },
        
        togglePreview(profileId) {
            if (this.expandedProfiles.includes(profileId)) {
                this.expandedProfiles = this.expandedProfiles.filter(id => id !== profileId);
            } else {
                this.expandedProfiles.push(profileId);
            }
        },
        
        filterProfiles() {
            const query = this.searchQuery.toLowerCase().trim();
            
            this.filteredProfiles = this.profiles.map(profile => {
                let matches = true;
                
                if (query) {
                    const nameMatch = profile.name?.toLowerCase().includes(query);
                    const entityNameMatch = (profile.entities || []).some(e => 
                        e.name?.toLowerCase().includes(query)
                    );
                    matches = nameMatch || entityNameMatch;
                }
                
                return {...profile, hidden: !matches};
            });
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
    }));
    }

    initAlpineComponents();

    /* Helper function for adding contacts dynamically */
    window.addContactRow = function(container, entityPrefix) {
    if (!container) return;
    const contactPrefix = `${entityPrefix}-contacts`;
    const entityCard = container.closest('.entity-card');
    if (!entityCard) return;

    // Look for the total forms input - it could be directly in the contacts-list or in the entity card
    let totalInput = container.querySelector(`input[name="${contactPrefix}-TOTAL_FORMS"]`);
    if (!totalInput) {
        totalInput = entityCard.querySelector(`input[name="${contactPrefix}-TOTAL_FORMS"]`);
    }
    
    if (!totalInput) {
        // Create the management form if it doesn't exist
        const mgmtDiv = document.createElement('div');
        mgmtDiv.innerHTML = `
            <input type="hidden" name="${contactPrefix}-TOTAL_FORMS" value="0" id="id_${contactPrefix}-TOTAL_FORMS">
            <input type="hidden" name="${contactPrefix}-INITIAL_FORMS" value="0" id="id_${contactPrefix}-INITIAL_FORMS">
            <input type="hidden" name="${contactPrefix}-MIN_NUM_FORMS" value="0" id="id_${contactPrefix}-MIN_NUM_FORMS">
            <input type="hidden" name="${contactPrefix}-MAX_NUM_FORMS" value="1000" id="id_${contactPrefix}-MAX_NUM_FORMS">
        `;
        container.insertBefore(mgmtDiv, container.firstChild);
        totalInput = container.querySelector(`input[name="${contactPrefix}-TOTAL_FORMS"]`);
    }
    
    const index = parseInt(totalInput.value);
    const newPrefix = `${contactPrefix}-${index}`;
    
    let newRow = null;
    const existingContact = container.querySelector('.contact-card');
    
    if (existingContact) {
        newRow = existingContact.cloneNode(true);
        newRow.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.name) {
                const nameMatch = input.name.match(/^(.+?)-(name|email|phone|DELETE|id)$/);
                if (nameMatch) {
                    input.name = `${newPrefix}-${nameMatch[2]}`;
                    input.id = `id_${input.name}`;
                }
            }
        });
        newRow.querySelectorAll('input[type="text"], input[type="email"]').forEach(input => {
            if (input.name && !input.name.includes('DELETE') && !input.name.includes('id')) {
                input.value = '';
            }
        });
        const deleteInput = newRow.querySelector(`input[name="${newPrefix}-DELETE"]`);
        if (deleteInput) {
            deleteInput.value = '';
        }
    } else {
        newRow = document.createElement('div');
        newRow.className = 'card mb-2 shadow-none border contact-card';
        newRow.setAttribute('x-data', 'contactEntry');
        newRow.innerHTML = `
            <div class="card-body p-3">
                <input type="hidden" name="${newPrefix}-id" id="id_${newPrefix}-id">
                <input type="hidden" name="${newPrefix}-DELETE" x-model="deleted" value="">
                <div class="row g-2 align-items-start">
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="text" name="${newPrefix}-name" id="id_${newPrefix}-name" class="form-control form-control-sm" placeholder="Name" required title="Please enter the contact name">
                            <label class="text-muted small" for="id_${newPrefix}-name">Name *</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <input type="email" name="${newPrefix}-email" id="id_${newPrefix}-email" class="form-control form-control-sm" placeholder="Email" required title="Please enter a valid email address">
                            <label class="text-muted small" for="id_${newPrefix}-email">Email *</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <input type="text" name="${newPrefix}-phone" id="id_${newPrefix}-phone" class="form-control form-control-sm" placeholder="Phone">
                            <label class="text-muted small" for="id_${newPrefix}-phone">Phone</label>
                        </div>
                    </div>
                    <div class="col-md-1 d-flex justify-content-end align-items-center pt-2">
                        <button type="button" class="btn btn-icon btn-sm btn-outline-danger" @click="removeContact" title="Remove Contact">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        if (window.Alpine) {
            Alpine.initTree(newRow);
        }
    }
    
    container.appendChild(newRow);
    totalInput.value = index + 1;
};

    // Reinitialize Alpine on HTMX content swaps
    document.body.addEventListener('htmx:afterSettle', function(event) {
        if (event.detail.target.id === 'contact-profiles-content') {
            // Ensure Alpine components are registered
            initAlpineComponents();
            // Initialize Alpine on the new content with slight delay for DOM stability
            requestAnimationFrame(() => {
                if (window.Alpine) {
                    Alpine.initTree(event.detail.target);
                }
            });
        }
    });
</script>
