{% load static %}
{% load widget_tweaks %}
{% load form_helpers %}
<!-- Generate New Token Card -->
<div class="standard-card mb-4">
    <div class="card settings-card shadow-md">
        <div class="card-header">
            <h4 class="card-title mb-0">Generate New Token</h4>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Create a new personal access token for API authentication.</p>
            <!-- New Token Display (only shown when a new token is created) -->
            {% if new_encoded_access_token %}
                <div class="alert alert-warning d-flex align-items-start gap-2 mb-3"
                     role="alert">
                    <i class="fas fa-exclamation-triangle mt-1"></i>
                    <div>
                        <strong>Copy your token now!</strong> You won't be able to see it again.
                    </div>
                </div>
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-semibold mb-0">Your New Token</label>
                        <div class="vc-copy-token"></div>
                    </div>
                    <div id="access-token" class="form-control token-display" readonly>{{ new_encoded_access_token }}</div>
                </div>
                <hr class="my-4">
            {% endif %}
            <form method="post"
                  id="tokenGenerationForm"
                  hx-post="{% url 'teams:team_tokens' team.key %}"
                  hx-target="#team-tokens-content"
                  hx-swap="innerHTML">
                {% csrf_token %}
                <div class="mb-3">
                    {% for field in create_access_token_form %}
                        <label class="form-label fw-semibold" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field|add_class:'form-control'|attr:'style:max-width: 400px' }}
                        <div class="form-text">A descriptive name to identify this token.</div>
                        {% for error in field.errors %}<div class="text-danger mt-1 small">{{ error }}</div>{% endfor %}
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Generate Token
                </button>
            </form>
        </div>
    </div>
</div>
<!-- Existing Tokens Card -->
<div class="standard-card">
    <div class="card settings-card shadow-md">
        <div class="card-header">
            <h4 class="card-title mb-0">Your Tokens</h4>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Manage your existing personal access tokens.</p>
            {% if access_tokens %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for token in access_tokens %}
                                <tr x-data="{ showDeleteModal: false }">
                                    <td>{{ token.description }}</td>
                                    <td>{{ token.created_at|timesince }} ago</td>
                                    <td class="text-end">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                @click="showDeleteModal = true">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </td>
                                    {% url 'core:delete_access_token' token_id=token.id as delete_url %}
                                    {% include 'components/delete_confirmation_modal.html.j2' with modal_id='showDeleteModal' title='Delete Token' message='Are you sure you want to delete the token' item_name=token.description warning_message='This action cannot be undone. You will need to generate a new token.' confirm_text='Delete Token' hx_url=delete_url hx_method='delete' success_message='Token deleted successfully!' refresh_event='refreshTeamTokens' %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-0">No tokens yet. Generate one above to get started.</p>
            {% endif %}
        </div>
    </div>
</div>
<style>
    .token-display {
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        font-size: 0.8125rem;
        letter-spacing: 0.025em;
        background-color: #f1f5f9;
        border: 1px solid #e2e8f0;
        word-break: break-all;
    }
</style>
