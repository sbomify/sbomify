{% load static %}
{% load widget_tweaks %}
{% load form_helpers %}
<div class="tw-settings-card">
    {# Card Header #}
    <div class="px-6 py-4 border-b border-border">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-key text-primary"></i>
                </div>
                <div>
                    <h5 class="text-lg font-semibold text-text m-0">API Tokens</h5>
                    <p class="text-text-muted text-sm m-0">Manage personal access tokens for API authentication</p>
                </div>
            </div>
            {% if access_tokens %}
                <span class="tw-badge-secondary">{{ access_tokens|length }} token{{ access_tokens|length|pluralize }}</span>
            {% endif %}
        </div>
    </div>
    {# Card Content #}
    <div class="p-6">
        {# Deprecation Warning for Unscoped Tokens #}
        {% if has_unscoped_tokens %}
            <div class="tw-alert tw-alert-warning mb-4">
                <i class="fas fa-exclamation-triangle tw-alert-icon"></i>
                <div class="tw-alert-content">
                    <p class="tw-alert-title">Unscoped tokens detected</p>
                    <p class="text-sm m-0">
                        You have tokens that are not scoped to any workspace. These tokens grant access to all your workspaces and will be deprecated in a future release. Please create new workspace-scoped tokens and delete the unscoped ones.
                    </p>
                </div>
            </div>
        {% endif %}
        {# New Token Alert (only shown when a new token is created) #}
        {% if new_encoded_access_token %}
            <div class="tw-alert tw-alert-warning mb-4">
                <i class="fas fa-exclamation-triangle tw-alert-icon"></i>
                <div class="tw-alert-content">
                    <p class="tw-alert-title">Copy your token now!</p>
                    <p class="text-sm m-0">You won't be able to see it again.</p>
                </div>
            </div>
            <div class="bg-success/5 border border-success/20 rounded-xl p-5 mb-4">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-lg bg-success/10 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-check-circle text-success text-sm"></i>
                    </div>
                    <label class="tw-form-label m-0">Your New Token</label>
                </div>
                <div class="ml-11">{% include 'core/components/copy_token.html.j2' with token=new_encoded_access_token %}</div>
            </div>
        {% endif %}
        {# Generate New Token Section #}
        <div class="bg-background/50 border border-border rounded-xl p-5 mb-4">
            <div class="flex items-start gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-border/50 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-plus-circle text-text-muted text-sm"></i>
                </div>
                <div>
                    <h6 class="text-base font-semibold text-text m-0">Generate New Token</h6>
                    <p class="text-text-muted text-sm m-0">Create a new personal access token scoped to this workspace</p>
                </div>
            </div>
            <form method="post"
                  id="tokenGenerationForm"
                  hx-post="{% url 'teams:team_tokens' team.key %}"
                  hx-target="#team-tokens-content"
                  hx-disabled-elt="find button[type='submit']"
                  hx-swap="innerHTML"
                  class="ml-11">
                {% csrf_token %}
                <div class="flex flex-col sm:flex-row gap-3">
                    {% for field in create_access_token_form %}
                        <div class="flex-1">
                            <input type="text"
                                   id="{{ field.id_for_label }}"
                                   name="{{ field.html_name }}"
                                   class="tw-form-input"
                                   placeholder="e.g., CI/CD Pipeline Token"
                                   value="{{ field.value|default:'' }}">
                            {% for error in field.errors %}<p class="tw-form-error mt-1">{{ error }}</p>{% endfor %}
                        </div>
                    {% endfor %}
                    <button type="submit" class="tw-btn-primary flex-shrink-0">
                        <i class="fas fa-plus mr-2"></i>Generate
                    </button>
                </div>
                <p class="tw-form-hint mt-2">Give your token a descriptive name to identify it later</p>
            </form>
        </div>
        {# Existing Tokens Section #}
        <div class="bg-background/50 border border-border rounded-xl p-5">
            <div class="flex items-start gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-border/50 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-list text-text-muted text-sm"></i>
                </div>
                <div>
                    <h6 class="text-base font-semibold text-text m-0">Your Tokens</h6>
                    <p class="text-text-muted text-sm m-0">Manage your existing personal access tokens</p>
                </div>
            </div>
            {% if access_tokens or unscoped_tokens %}
                <div class="space-y-3 ml-11">
                    {% for token in access_tokens %}
                        <div class="flex items-center gap-4 p-4 bg-background/30 rounded-lg border border-border/50"
                             x-cloak
                             x-data="{ showDeleteModal: false }">
                            <div class="w-10 h-10 rounded-lg bg-primary/5 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-key text-primary/60"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h6 class="font-medium text-text m-0 truncate">{{ token.description }}</h6>
                                <p class="text-sm text-text-muted m-0">
                                    <i class="fas fa-clock text-xs mr-1"></i>
                                    Created {{ token.created_at|timesince }} ago
                                </p>
                            </div>
                            <div class="flex-shrink-0">
                                <button type="button"
                                        class="tw-btn-ghost tw-btn-sm text-text-muted hover:text-danger hover:bg-danger/10"
                                        title="Delete token"
                                        @click="showDeleteModal = true">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% url 'core:delete_access_token' token_id=token.id as delete_url %}
                            {% include 'components/delete_confirmation_modal.html.j2' with modal_id='showDeleteModal' title='Delete Token' message='Are you sure you want to delete the token' item_name=token.description warning_message='This action cannot be undone. You will need to generate a new token.' confirm_text='Delete Token' hx_url=delete_url hx_method='delete' success_message='Token deleted successfully!' refresh_event='refreshTeamTokens' %}
                        </div>
                    {% endfor %}
                    {% for token in unscoped_tokens %}
                        <div class="flex items-center gap-4 p-4 bg-warning/5 rounded-lg border border-warning/30"
                             x-cloak
                             x-data="{ showDeleteModal: false }">
                            <div class="w-10 h-10 rounded-lg bg-warning/10 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-warning"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h6 class="font-medium text-text m-0 truncate">{{ token.description }}</h6>
                                <p class="text-sm text-warning m-0">
                                    <i class="fas fa-globe text-xs mr-1"></i>
                                    Unscoped â€” not tied to any workspace. Please replace with a scoped token.
                                </p>
                                <p class="text-sm text-text-muted m-0">
                                    <i class="fas fa-clock text-xs mr-1"></i>
                                    Created {{ token.created_at|timesince }} ago
                                </p>
                            </div>
                            <div class="flex-shrink-0">
                                <button type="button"
                                        class="tw-btn-ghost tw-btn-sm text-text-muted hover:text-danger hover:bg-danger/10"
                                        title="Delete token"
                                        @click="showDeleteModal = true">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% url 'core:delete_access_token' token_id=token.id as delete_url %}
                            {% include 'components/delete_confirmation_modal.html.j2' with modal_id='showDeleteModal' title='Delete Token' message='Are you sure you want to delete the token' item_name=token.description warning_message='This action cannot be undone. You will need to generate a new token.' confirm_text='Delete Token' hx_url=delete_url hx_method='delete' success_message='Token deleted successfully!' refresh_event='refreshTeamTokens' %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="tw-empty-state py-10">
                    <div class="tw-empty-state-icon bg-border/30">
                        <i class="fas fa-key text-2xl text-text-muted"></i>
                    </div>
                    <h4 class="tw-empty-state-title">No tokens yet</h4>
                    <p class="tw-empty-state-description">Generate a token above to get started with the API.</p>
                </div>
            {% endif %}
        </div>
        {# Security Info Section #}
        <div class="tw-alert tw-alert-info mt-4">
            <i class="fas fa-shield-alt tw-alert-icon"></i>
            <div class="tw-alert-content">
                <p class="text-sm m-0">
                    <strong>Security tip:</strong> Treat tokens like passwords. Never share them or commit them to version control. New tokens created here are scoped to this workspace only.
                </p>
            </div>
        </div>
    </div>
</div>
