from django.contrib.auth.mixins import LoginRequiredMixin
from django.http import HttpRequest, HttpResponse
from django.shortcuts import render
from django.views import View

from sbomify.apps.core.htmx import htmx_error_response, htmx_success_response
from sbomify.apps.teams.apis import get_team
from sbomify.apps.teams.forms import VulnerabilitySettingsForm
from sbomify.apps.teams.permissions import TeamRoleRequiredMixin
from sbomify.apps.vulnerability_scanning.apis import (
    UpdateVulnerabilitySettingsRequest,
    get_team_vulnerability_settings,
    get_team_vulnerability_stats,
    update_team_vulnerability_settings,
)


class VulnerabilitySettingsView(TeamRoleRequiredMixin, LoginRequiredMixin, View):
    allowed_roles = ["owner", "admin"]

    def get(self, request: HttpRequest, team_key: str) -> HttpResponse:
        status_code, team = get_team(request, team_key)
        if status_code != 200:
            return htmx_error_response(team.get("detail", "Unknown error"))

        status_code, vulnerability_settings = get_team_vulnerability_settings(request, team_key)
        if status_code != 200:
            return htmx_error_response(vulnerability_settings.get("detail", "Failed to load settings"))

        status_code, vulnerability_stats = get_team_vulnerability_stats(request, team_key)
        if status_code != 200:
            return htmx_error_response(vulnerability_stats.get("detail", "Failed to load stats"))

        # Initialize form with current settings
        form = VulnerabilitySettingsForm(
            initial={
                "vulnerability_provider": vulnerability_settings.vulnerability_provider,
                "custom_dt_server_id": vulnerability_settings.custom_dt_server.id
                if vulnerability_settings.custom_dt_server
                else "",
            }
        )

        return render(
            request,
            "teams/vulnerability_settings.html.j2",
            {
                "team": team,
                "vulnerability_settings": vulnerability_settings,
                "vulnerability_stats": vulnerability_stats,
                "form": form,
            },
        )

    def post(self, request: HttpRequest, team_key: str) -> HttpResponse:
        form = VulnerabilitySettingsForm(request.POST)
        if not form.is_valid():
            return htmx_error_response(form.errors.as_text())

        payload = UpdateVulnerabilitySettingsRequest(
            vulnerability_provider=form.cleaned_data["vulnerability_provider"],
            custom_dt_server_id=form.cleaned_data.get("custom_dt_server_id"),
        )

        status_code, result = update_team_vulnerability_settings(request, team_key, payload)
        if status_code != 200:
            return htmx_error_response(result.get("detail", "Failed to update settings"))

        return htmx_success_response(
            "Vulnerability scanning settings updated successfully",
            triggers={"refreshVulnerabilitySettings": True},
        )
