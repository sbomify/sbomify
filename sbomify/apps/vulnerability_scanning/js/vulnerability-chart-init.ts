// Chart.js is lazy-loaded to reduce bundle size
// Only load when charts are actually needed
let chartSetupLoaded = false;
let ChartModule: typeof import('chart.js') | null = null;

async function ensureChartSetup(): Promise<void> {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    if (chartSetupLoaded && (window as any).Chart) {
        return;
    }

    if (!ChartModule) {
        // Lazy load chart-setup which registers Chart.js globally
        await import('../../core/js/chart-setup');
        ChartModule = await import('chart.js');
        // chart-setup already sets window.Chart, but ensure it's set
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        if (ChartModule && !(window as any).Chart) {
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            (window as any).Chart = ChartModule.Chart;
        }
        chartSetupLoaded = true;
    }
}



/**
 * Initialize vulnerability chart
 * Reads data from canvas data attributes and creates Chart.js instance
 * Chart.js is lazy-loaded on first use
 */
export async function initVulnerabilityChart(
    container: HTMLElement,
    chartType: string = 'timeline'
): Promise<void> {
    // Lazy load Chart.js if not already loaded
    await ensureChartSetup();

    const canvas = container.querySelector<HTMLCanvasElement>('.vulnerability-chart-canvas');
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    if (!canvas || !(window as any).Chart || !ChartModule) {
        return;
    }

    // Get Alpine data from container
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const alpineData = (window.Alpine as any).$data(container);
    if (!alpineData) {
        return;
    }

    // Extract Chart from ChartModule once for use throughout the function
    if (!ChartModule) {
        console.error('Chart.js module not loaded');
        return;
    }
    const { Chart } = ChartModule;

    // Destroy existing Chart.js instance if present (Chart.js tracks instances by canvas)
    const existingChart = Chart.getChart(canvas);
    if (existingChart) {
        existingChart.destroy();
    }

    // Also destroy via Alpine data if available
    if (alpineData.chartInstance && typeof alpineData.destroyChart === 'function') {
        alpineData.destroyChart();
    }

    // Parse data from data attributes
    const parseJsonData = (data: string | null | undefined, fallback: unknown[] = []): unknown[] => {
        if (!data) return fallback;
        try {
            return JSON.parse(data);
        } catch {
            return fallback;
        }
    };

    const labels = parseJsonData(canvas.getAttribute('data-labels'), []);
    const critical = parseJsonData(canvas.getAttribute('data-critical'), []);
    const high = parseJsonData(canvas.getAttribute('data-high'), []);
    const medium = parseJsonData(canvas.getAttribute('data-medium'), []);
    const low = parseJsonData(canvas.getAttribute('data-low'), []);
    const severityLabels = parseJsonData(canvas.getAttribute('data-severity-labels'), []);
    const severityValues = parseJsonData(canvas.getAttribute('data-severity-values'), []);
    const providerLabels = parseJsonData(canvas.getAttribute('data-provider-labels'), []);
    const providerValues = parseJsonData(canvas.getAttribute('data-provider-values'), []);

    // Chart is already available from top-level destructuring
    // ChartConfiguration is a type, not a value to destructure

    let chartConfig: import('chart.js').ChartConfiguration<'line' | 'bar' | 'doughnut', unknown[], unknown>;

    if (chartType === 'timeline') {
        chartConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Critical',
                        data: critical,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'High',
                        data: high,
                        borderColor: '#fd7e14',
                        backgroundColor: 'rgba(253, 126, 20, 0.1)',
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Medium',
                        data: medium,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Low',
                        data: low,
                        borderColor: '#0dcaf0',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: 10 }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { precision: 0 }
                    }
                }
            }
        };
    } else if (chartType === 'severity') {
        chartConfig = {
            type: 'bar',
            data: {
                labels: severityLabels,
                datasets: [{
                    label: 'Vulnerabilities',
                    data: severityValues,
                    backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#0dcaf0'],
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { precision: 0 }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        };
    } else if (chartType === 'providers') {
        const formatLabel = (label: string): string => {
            if (label === 'osv') return 'OSV';
            if (label === 'dependency_track') return 'Dependency Track';
            return label;
        };

        const getProviderColor = (label: string): string => {
            if (label === 'osv') return '#4285f4';
            if (label === 'dependency_track') return '#10b981';
            return '#6c757d';
        };

        chartConfig = {
            type: 'doughnut',
            data: {
                labels: (providerLabels as string[]).map(formatLabel),
                datasets: [{
                    data: providerValues,
                    backgroundColor: (providerLabels as string[]).map(getProviderColor),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 8
                    }
                }
            }
        };
    } else {
        return;
    }

    // Create chart instance using Chart (already extracted above)
    const chartInstance = new Chart(canvas, chartConfig);

    // Store chart instance in Alpine data if setChartInstance method exists
    if (alpineData && typeof alpineData.setChartInstance === 'function') {
        alpineData.setChartInstance(chartInstance);
    } else {
        // Fallback: store directly if method doesn't exist
        alpineData.chartInstance = chartInstance;
    }
}

// Make available globally (backward compatibility)
// Prefer using $store.charts.initVulnerabilityChart in Alpine components
declare global {
    interface Window {
        initVulnerabilityChart: typeof initVulnerabilityChart;
    }
}

window.initVulnerabilityChart = initVulnerabilityChart;
