import { describe, test, expect } from 'bun:test'

describe('Vulnerability Chart', () => {
    describe('JSON Data Parsing', () => {
        test('should parse valid JSON data', () => {
            const parseJsonData = (data: string | undefined, fallback: unknown[] = []): unknown[] => {
                if (!data) return fallback
                try {
                    return JSON.parse(data)
                } catch {
                    return fallback
                }
            }

            expect(parseJsonData('["a","b","c"]')).toEqual(['a', 'b', 'c'])
            expect(parseJsonData('[1,2,3]')).toEqual([1, 2, 3])
        })

        test('should return fallback for undefined data', () => {
            const parseJsonData = (data: string | undefined, fallback: unknown[] = []): unknown[] => {
                if (!data) return fallback
                try {
                    return JSON.parse(data)
                } catch {
                    return fallback
                }
            }

            expect(parseJsonData(undefined)).toEqual([])
            expect(parseJsonData(undefined, ['default'])).toEqual(['default'])
        })

        test('should return fallback for invalid JSON', () => {
            const parseJsonData = (data: string | undefined, fallback: unknown[] = []): unknown[] => {
                if (!data) return fallback
                try {
                    return JSON.parse(data)
                } catch {
                    return fallback
                }
            }

            expect(parseJsonData('not valid json')).toEqual([])
            expect(parseJsonData('{invalid}')).toEqual([])
        })
    })

    describe('Chart Types', () => {
        test('should support timeline chart type', () => {
            const chartType = 'timeline'
            expect(chartType).toBe('timeline')
        })

        test('should support severity chart type', () => {
            const chartType = 'severity'
            expect(chartType).toBe('severity')
        })

        test('should support providers chart type', () => {
            const chartType = 'providers'
            expect(chartType).toBe('providers')
        })
    })

    describe('Timeline Chart Configuration', () => {
        test('should configure severity colors correctly', () => {
            const colors = {
                critical: '#dc3545',
                high: '#fd7e14',
                medium: '#ffc107',
                low: '#0dcaf0'
            }

            expect(colors.critical).toBe('#dc3545')
            expect(colors.high).toBe('#fd7e14')
            expect(colors.medium).toBe('#ffc107')
            expect(colors.low).toBe('#0dcaf0')
        })

        test('should configure line chart options', () => {
            const options = {
                type: 'line',
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6
            }

            expect(options.type).toBe('line')
            expect(options.tension).toBe(0.4)
        })
    })

    describe('Severity Chart Configuration', () => {
        test('should use bar chart with horizontal orientation', () => {
            const options = {
                type: 'bar',
                indexAxis: 'y',
                borderRadius: 8
            }

            expect(options.type).toBe('bar')
            expect(options.indexAxis).toBe('y')
        })
    })

    describe('Providers Chart Configuration', () => {
        test('should use doughnut chart type', () => {
            const options = {
                type: 'doughnut',
                borderWidth: 2,
                borderColor: '#fff'
            }

            expect(options.type).toBe('doughnut')
        })

        test('should format provider labels correctly', () => {
            const formatLabel = (label: string): string => {
                if (label === 'osv') return 'OSV'
                if (label === 'dependency_track') return 'Dependency Track'
                return label
            }

            expect(formatLabel('osv')).toBe('OSV')
            expect(formatLabel('dependency_track')).toBe('Dependency Track')
            expect(formatLabel('other')).toBe('other')
        })

        test('should assign correct provider colors', () => {
            const getProviderColor = (label: string): string => {
                if (label === 'osv') return '#4285f4'
                if (label === 'dependency_track') return '#10b981'
                return '#6c757d'
            }

            expect(getProviderColor('osv')).toBe('#4285f4')
            expect(getProviderColor('dependency_track')).toBe('#10b981')
            expect(getProviderColor('unknown')).toBe('#6c757d')
        })
    })

    describe('Chart Options', () => {
        test('should configure responsive options', () => {
            const options = {
                responsive: true,
                maintainAspectRatio: false
            }

            expect(options.responsive).toBe(true)
            expect(options.maintainAspectRatio).toBe(false)
        })

        test('should configure legend position', () => {
            const legendOptions = {
                display: true,
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            }

            expect(legendOptions.position).toBe('bottom')
            expect(legendOptions.labels.usePointStyle).toBe(true)
        })

        test('should configure tooltip styling', () => {
            const tooltipOptions = {
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                padding: 12,
                cornerRadius: 8
            }

            expect(tooltipOptions.backgroundColor).toBe('rgba(0,0,0,0.8)')
            expect(tooltipOptions.cornerRadius).toBe(8)
        })
    })

    describe('Chart Instance Management', () => {
        test('should track chart instances with WeakMap pattern', () => {
            interface ChartInstance {
                chart: unknown
                destroy: () => void
            }

            const chartInstances = new Map<string, ChartInstance>()

            chartInstances.set('container-1', {
                chart: {},
                destroy: () => { }
            })

            expect(chartInstances.has('container-1')).toBe(true)
            expect(chartInstances.has('container-2')).toBe(false)
        })

        test('should allow destroying existing chart', () => {
            let destroyed = false

            const chartInstance = {
                chart: {},
                destroy: () => { destroyed = true }
            }

            chartInstance.destroy()
            expect(destroyed).toBe(true)
        })
    })

    describe('Scales Configuration', () => {
        test('should configure x-axis for timeline', () => {
            const xAxis = {
                grid: { display: false },
                ticks: { maxTicksLimit: 10 }
            }

            expect(xAxis.grid.display).toBe(false)
            expect(xAxis.ticks.maxTicksLimit).toBe(10)
        })

        test('should configure y-axis with zero baseline', () => {
            const yAxis = {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.05)' },
                ticks: { precision: 0 }
            }

            expect(yAxis.beginAtZero).toBe(true)
            expect(yAxis.ticks.precision).toBe(0)
        })
    })
})
