// Chart instance management for vulnerability trends
// Uses WeakMap to store chart instances per container element, allowing proper cleanup

import type { Chart, ChartConfiguration } from 'chart.js';
import { severityColors, providerColors, hexToRgba } from '../../core/js/constants/colors';

interface ChartInstance {
  chart: Chart;
  destroy: () => void;
}

const chartInstances = new WeakMap<HTMLElement, ChartInstance>();

function parseJsonData(data: string | undefined, fallback: unknown[] = []): unknown[] {
  if (!data) return fallback;
  try {
    return JSON.parse(data);
  } catch (error) {
    console.error('Failed to parse JSON data:', error);
    return fallback;
  }
}

function initVulnerabilityChart(container: HTMLElement, chartType: string = 'timeline'): void {
  if (typeof window.Chart === 'undefined') {
    console.error('Chart.js is not available');
    return;
  }

  const canvas = container.querySelector<HTMLCanvasElement>('.vulnerability-chart-canvas');
  if (!canvas) return;

  // Destroy existing chart for this container if it exists
  const existingInstance = chartInstances.get(container);
  if (existingInstance) {
    existingInstance.destroy();
    chartInstances.delete(container);
  }

  try {
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let config: ChartConfiguration;

    if (chartType === 'timeline') {
      const labels = parseJsonData(canvas.dataset.labels) as string[];
      const critical = parseJsonData(canvas.dataset.critical) as number[];
      const high = parseJsonData(canvas.dataset.high) as number[];
      const medium = parseJsonData(canvas.dataset.medium) as number[];
      const low = parseJsonData(canvas.dataset.low) as number[];

      config = {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Critical',
              data: critical,
              borderColor: severityColors.critical,
              backgroundColor: hexToRgba(severityColors.critical, 0.1),
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 6,
            },
            {
              label: 'High',
              data: high,
              borderColor: severityColors.high,
              backgroundColor: hexToRgba(severityColors.high, 0.1),
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 6,
            },
            {
              label: 'Medium',
              data: medium,
              borderColor: severityColors.medium,
              backgroundColor: hexToRgba(severityColors.medium, 0.1),
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 6,
            },
            {
              label: 'Low',
              data: low,
              borderColor: severityColors.low,
              backgroundColor: hexToRgba(severityColors.low, 0.1),
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 6,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
            tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff', padding: 12, cornerRadius: 8 },
          },
          scales: {
            x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } },
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { precision: 0 } },
          },
        },
      };
    } else if (chartType === 'severity') {
      const severityLabels = parseJsonData(canvas.dataset.severityLabels) as string[];
      const severityValues = parseJsonData(canvas.dataset.severityValues) as number[];

      config = {
        type: 'bar',
        data: {
          labels: severityLabels,
          datasets: [{
            label: 'Vulnerabilities',
            data: severityValues,
            backgroundColor: [severityColors.critical, severityColors.high, severityColors.medium, severityColors.low],
            borderColor: [severityColors.critical, severityColors.high, severityColors.medium, severityColors.low],
            borderWidth: 1,
            borderRadius: 8,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff', padding: 12, cornerRadius: 8 },
          },
          scales: {
            x: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { precision: 0 } },
            y: { grid: { display: false } },
          },
        },
      };
    } else if (chartType === 'providers') {
      const providerLabels = parseJsonData(canvas.dataset.providerLabels) as string[];
      const providerValues = parseJsonData(canvas.dataset.providerValues) as number[];

      const chartProviderColors = providerLabels.map((label) => {
        if (label === 'osv') return providerColors.osv;
        if (label === 'dependency_track') return providerColors.dependencyTrack;
        return providerColors.default;
      });

      const formattedLabels = providerLabels.map((label) => {
        if (label === 'osv') return 'OSV';
        if (label === 'dependency_track') return 'Dependency Track';
        return label;
      });

      config = {
        type: 'doughnut',
        data: {
          labels: formattedLabels,
          datasets: [{
            data: providerValues,
            backgroundColor: chartProviderColors,
            borderWidth: 2,
            borderColor: '#fff',
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
            tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff', padding: 12, cornerRadius: 8 },
          },
        },
      };
    } else {
      return;
    }

    const chart = new window.Chart(ctx, config);
    chartInstances.set(container, {
      chart,
      destroy: () => chart.destroy(),
    });
  } catch (e) {
    console.error('Failed to initialize vulnerability chart:', e);
  }
}

// Make function available globally for inline Alpine.js calls
declare global {
  interface Window {
    initVulnerabilityChart: typeof initVulnerabilityChart;
  }
}

window.initVulnerabilityChart = initVulnerabilityChart;

export { initVulnerabilityChart };

