from __future__ import annotations

from typing import Optional

from django.db.models import QuerySet

from sbomify.apps.sboms.queries import get_latest_sbom_id_for_component as _get_latest_sbom_id_for_component
from sbomify.apps.vulnerability_scanning.models import VulnerabilityScanResult


def get_latest_sbom_id_for_component(component_id: str) -> Optional[str]:
    return _get_latest_sbom_id_for_component(component_id)


def apply_latest_sbom_filter(
    results_query: QuerySet[VulnerabilityScanResult], component_id: str
) -> QuerySet[VulnerabilityScanResult]:
    latest_sbom_id = get_latest_sbom_id_for_component(component_id)
    if not latest_sbom_id:
        return results_query.none()
    return results_query.filter(sbom_id=latest_sbom_id)
