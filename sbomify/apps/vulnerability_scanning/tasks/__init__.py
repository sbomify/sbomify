"""Vulnerability scanning tasks.

After plugin migration (OSV + DT plugins), only the DT health check task remains here.
Scanning tasks are now handled by the plugin framework in sbomify.apps.plugins.tasks.
"""

import logging
import os
from typing import Any

import dramatiq
from django.db import transaction
from tenacity import (
    before_sleep_log,
    retry,
    retry_if_exception_type,
    stop_after_delay,
    wait_exponential,
)

# Set up Django
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sbomify.settings")
import django  # noqa: E402

django.setup()

from django.db import connection  # noqa: E402
from django.db.utils import DatabaseError, OperationalError  # noqa: E402
from django.utils import timezone  # noqa: E402

logger = logging.getLogger(__name__)


# Import cron decorator for scheduling
try:
    from dramatiq_crontab import cron

    logger.info("dramatiq-crontab available - cron scheduling enabled")
except ImportError:
    logger.warning("dramatiq-crontab not installed - cron scheduling disabled, tasks will need manual triggering")

    def cron(schedule):
        """Fallback decorator when dramatiq-crontab is not installed."""

        def decorator(func):
            return func

        return decorator


@cron("0 */6 * * *")  # Run every 6 hours
@dramatiq.actor(queue_name="dt_health_check", max_retries=2, time_limit=60000, store_results=True)
@retry(
    retry=retry_if_exception_type((OperationalError, DatabaseError)),
    wait=wait_exponential(multiplier=1, min=1, max=5),
    stop=stop_after_delay(30),
    before_sleep=before_sleep_log(logger, logging.WARNING),
)
def check_dependency_track_health_task(server_id: str = None) -> dict[str, Any]:
    """Task to check Dependency Track server health and update status - runs every 6 hours.

    Args:
        server_id: Specific server ID to check. If None, checks all active servers.

    Returns:
        Health check results
    """
    logger.info("[TASK_check_dependency_track_health] Starting DT health check task")

    try:
        with transaction.atomic():
            connection.ensure_connection()

            from ..models import DependencyTrackServer
            from ..services import VulnerabilityScanningService

            service = VulnerabilityScanningService()

            if server_id:
                try:
                    server = DependencyTrackServer.objects.get(id=server_id)
                    result = service.check_dependency_track_server_health(server)
                    logger.info(f"[TASK_check_dependency_track_health] Health check completed for server {server.name}")
                    return {
                        "status": "completed",
                        "servers_checked": 1,
                        "results": [result],
                        "completed_at": timezone.now().isoformat(),
                    }
                except DependencyTrackServer.DoesNotExist:
                    logger.error(f"[TASK_check_dependency_track_health] Server with ID {server_id} not found")
                    return {
                        "status": "error",
                        "error": f"Server with ID {server_id} not found",
                        "failed_at": timezone.now().isoformat(),
                    }
            else:
                results = service.check_all_dependency_track_servers_health()
                healthy_count = sum(1 for r in results if r["status"] == "healthy")
                unhealthy_count = len(results) - healthy_count

                logger.info(
                    f"[TASK_check_dependency_track_health] Health check completed for {len(results)} servers. "
                    f"Healthy: {healthy_count}, Unhealthy: {unhealthy_count}"
                )

                return {
                    "status": "completed",
                    "servers_checked": len(results),
                    "healthy_servers": healthy_count,
                    "unhealthy_servers": unhealthy_count,
                    "results": results,
                    "completed_at": timezone.now().isoformat(),
                }

    except Exception:
        logger.exception("[TASK_check_dependency_track_health] DT health check task failed")
        return {"status": "failed", "error": "Task failed", "failed_at": timezone.now().isoformat()}
