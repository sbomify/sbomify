{% extends "core/dashboard_base.htmx.j2" %}
{% load static %}
{% block title %}Vulnerability Scans{% endblock %}
{% block dashboard_content %}
    {% include "core/base_messages.html.j2" %}
    {# Page Header #}
    <div class="mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-shield-alt text-primary text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-text">Vulnerability Scans</h1>
                    <p class="text-text-muted text-sm">{{ team.name }} | {{ time_range_label }}</p>
                </div>
            </div>
            <form method="get" class="flex items-center gap-3">
                <label for="days" class="text-sm text-text-muted">Timeframe</label>
                <select id="days"
                        name="days"
                        class="tw-form-input w-auto py-1.5"
                        onchange="this.form.submit()">
                    {% for option in days_options %}
                        <option value="{{ option }}"
                                {% if selected_days == option %}selected{% endif %}>Last {{ option }} days</option>
                    {% endfor %}
                    <option value="all" {% if selected_days is None %}selected{% endif %}>All time</option>
                </select>
                <noscript>
                    <button type="submit" class="tw-btn-primary py-1.5">Apply</button>
                </noscript>
            </form>
        </div>
    </div>
    {# Summary Cards #}
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="p-4 rounded-xl bg-gradient-to-br from-primary/5 to-primary/[0.02] border border-primary/15 hover:shadow-md hover:-translate-y-0.5 transition-all">
            <div class="text-xs font-semibold uppercase tracking-wider text-text-muted mb-1">Total Scans</div>
            <div class="text-2xl font-bold text-text">{{ summary.total_scans }}</div>
        </div>
        <div class="p-4 rounded-xl bg-gradient-to-br from-primary/5 to-primary/[0.02] border border-primary/15 hover:shadow-md hover:-translate-y-0.5 transition-all">
            <div class="text-xs font-semibold uppercase tracking-wider text-text-muted mb-1">Vulnerabilities</div>
            <div class="text-2xl font-bold text-text">{{ summary.total_vulnerabilities }}</div>
        </div>
        <div class="p-4 rounded-xl bg-gradient-to-br from-red-500/10 to-red-500/[0.03] border border-red-500/20 hover:shadow-md hover:-translate-y-0.5 transition-all">
            <div class="text-xs font-semibold uppercase tracking-wider text-text-muted mb-1">Critical + High</div>
            <div class="text-2xl font-bold text-danger">{{ summary.critical_high }}</div>
        </div>
        <div class="p-4 rounded-xl bg-gradient-to-br from-primary/5 to-primary/[0.02] border border-primary/15 hover:shadow-md hover:-translate-y-0.5 transition-all">
            <div class="text-xs font-semibold uppercase tracking-wider text-text-muted mb-1">Medium + Low</div>
            <div class="text-2xl font-bold text-text">{{ summary.medium_low }}</div>
        </div>
    </div>
    {# Scans Table #}
    <div class="tw-card">
        <div class="p-0">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-border bg-background/50">
                            <th class="px-6 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider">SBOM</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider">Provider</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider">Vulnerabilities</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider">Trigger</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-text-muted uppercase tracking-wider">Scan Date</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-text-muted uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border">
                        {% for scan in page_obj.object_list %}
                            <tr class="hover:bg-primary/[0.03] transition-colors">
                                <td class="px-6 py-4">
                                    <div class="font-semibold text-text">{{ scan.sbom.name }}</div>
                                    <div class="flex items-center gap-2 flex-wrap mt-1">
                                        {% if scan.sbom.version %}
                                            <span class="inline-block max-w-[120px] overflow-hidden text-ellipsis whitespace-nowrap tw-badge-primary"
                                                  title="{{ scan.sbom.version }}">{{ scan.sbom.version }}</span>
                                        {% endif %}
                                        <span class="text-sm text-text-muted">{{ scan.sbom.component.name }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    {% if scan.provider == 'osv' %}
                                        <span class="px-2 py-1 text-[0.7rem] font-semibold uppercase tracking-wide rounded bg-blue-500/15 text-blue-600">OSV</span>
                                    {% elif scan.provider == 'dependency_track' %}
                                        <span class="px-2 py-1 text-[0.7rem] font-semibold uppercase tracking-wide rounded bg-emerald-500/15 text-emerald-600">Dependency Track</span>
                                    {% else %}
                                        <span class="px-2 py-1 text-[0.7rem] font-semibold uppercase tracking-wide rounded bg-gray-500/15 text-gray-600">{{ scan.provider }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xl font-bold text-text">{{ scan.total_vulnerabilities }}</div>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        {% if scan.critical_vulnerabilities %}
                                            <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-red-500/15 text-red-600">{{ scan.critical_vulnerabilities }} Critical</span>
                                        {% endif %}
                                        {% if scan.high_vulnerabilities %}
                                            <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-orange-500/15 text-orange-600">{{ scan.high_vulnerabilities }} High</span>
                                        {% endif %}
                                        {% if scan.medium_vulnerabilities %}
                                            <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-yellow-500/15 text-yellow-700">{{ scan.medium_vulnerabilities }} Medium</span>
                                        {% endif %}
                                        {% if scan.low_vulnerabilities %}
                                            <span class="px-1.5 py-0.5 text-xs font-medium rounded bg-cyan-500/15 text-cyan-600">{{ scan.low_vulnerabilities }} Low</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="tw-badge-secondary capitalize">{{ scan.scan_trigger|default:"upload" }}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="font-semibold text-text">{{ scan.created_at|date:"M j, Y" }}</div>
                                    <div class="text-sm text-text-muted">{{ scan.created_at|date:"H:i" }}</div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="inline-flex rounded-lg border border-border overflow-hidden">
                                        <a class="px-3 py-2 text-primary hover:bg-primary/10 transition-colors border-r border-border"
                                           href="/sbom/{{ scan.sbom.id }}/"
                                           title="View SBOM">
                                            <i class="fas fa-file-code"></i>
                                        </a>
                                        <a class="px-3 py-2 text-text-muted hover:bg-background transition-colors"
                                           href="/sbom/{{ scan.sbom.id }}/vulnerabilities"
                                           title="View Findings">
                                            <i class="fas fa-bug"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-12">
                                    <div class="w-16 h-16 rounded-full bg-success/10 flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-shield-check text-2xl text-success"></i>
                                    </div>
                                    <p class="text-text-muted">No scans found for this timeframe.</p>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {# Pagination #}
            {% if page_obj.has_other_pages %}
                <div class="flex flex-wrap justify-between items-center px-6 py-4 border-t border-border gap-4">
                    <div class="text-sm text-text-muted">
                        Showing page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        ({{ page_obj.paginator.count }} total scans)
                    </div>
                    <nav aria-label="Vulnerability scans pagination">
                        <div class="inline-flex rounded-lg border border-border overflow-hidden">
                            <a class="px-3 py-2 text-text-muted hover:bg-background transition-colors {% if not page_obj.has_previous %}opacity-50 pointer-events-none{% endif %}"
                               href="?days={{ days_value }}{% if page_obj.has_previous %}&page={{ page_obj.previous_page_number }}{% endif %}"
                               aria-label="Previous">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                            <a class="px-3 py-2 text-text-muted hover:bg-background transition-colors border-l border-border {% if not page_obj.has_next %}opacity-50 pointer-events-none{% endif %}"
                               href="?days={{ days_value }}{% if page_obj.has_next %}&page={{ page_obj.next_page_number }}{% endif %}"
                               aria-label="Next">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </div>
                    </nav>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
