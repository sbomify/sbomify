"""Shared fixtures for vulnerability scanning tests."""

from typing import Any

import pytest

from sbomify.apps.core.tests.fixtures import sample_user  # noqa: F401
from sbomify.apps.sboms.models import SBOM, Component, Product, ProductProject, Project, ProjectComponent
from sbomify.apps.teams.fixtures import sample_team  # noqa: F401
from sbomify.apps.teams.models import Member, Team


@pytest.fixture
def team_with_member(sample_team, sample_user) -> tuple[Team, Any]:  # noqa: F811
    """Create a team with an owner member, ready for authenticated requests."""
    Member.objects.create(user=sample_user, team=sample_team, role="owner", is_default_team=True)

    return sample_team, sample_user


@pytest.fixture
def component_with_sbom(team_with_member) -> tuple[SBOM, Component]:
    """Create a component with an SBOM for assessment run tests."""
    team, _ = team_with_member

    product = Product.objects.create(team=team, name="Test Product")
    project = Project.objects.create(product=product, name="Test Project", team=team)
    ProductProject.objects.create(product=product, project=project)
    component = Component.objects.create(project=project, name="Test Component", team=team)
    ProjectComponent.objects.create(project=project, component=component)

    sbom = SBOM.objects.create(
        name="test-sbom",
        version="1.0.0",
        format="spdx",
        sbom_filename="test-sbom.json",
        component=component,
        source="test",
        format_version="2.3",
    )

    return sbom, component


def make_assessment_result(critical: int = 0, high: int = 0, medium: int = 0, low: int = 0) -> dict:
    """Build a minimal AssessmentRun result JSON blob."""
    total = critical + high + medium + low
    return {
        "summary": {
            "total_findings": total,
            "by_severity": {
                "critical": critical,
                "high": high,
                "medium": medium,
                "low": low,
            },
        },
    }
