"""Tests for vulnerability scanning API endpoints."""

import pytest

from sbomify.apps.core.tests.shared_fixtures import (
    authenticated_api_client,
    get_api_headers,
    sample_user,
)
from sbomify.apps.teams.fixtures import sample_team
from sbomify.apps.sboms.tests.fixtures import sample_component
from sbomify.apps.teams.models import Member


@pytest.mark.django_db
class TestVulnerabilityStatsAPI:
    """Test vulnerability statistics API endpoints."""

    @pytest.fixture(autouse=True)
    def setup_test_data(self, sample_team, sample_user):
        """Set up test data for stats tests."""
        self.team = sample_team
        self.user = sample_user

        # Ensure user is member of the team
        Member.objects.get_or_create(
            user=self.user,
            team=self.team,
            defaults={'role': 'owner'}
        )

    def test_get_vulnerability_stats_success(self, authenticated_api_client):
        """Test getting vulnerability statistics."""
        client, access_token = authenticated_api_client

        response = client.get(
            f"/api/v1/vulnerability-scanning/workspaces/{self.team.key}/vulnerability-stats",
            **get_api_headers(access_token)
        )

        assert response.status_code == 200
        data = response.json()

        assert "total_components" in data
        assert "total_scans" in data
        assert "total_vulnerabilities" in data
        assert "provider_stats" in data
        assert "recent_results" in data

    def test_get_vulnerability_timeseries_success(self, authenticated_api_client):
        """Test getting vulnerability time series data."""
        client, access_token = authenticated_api_client

        response = client.get(
            f"/api/v1/vulnerability-scanning/workspaces/{self.team.key}/vulnerability-timeseries?days=7",
            **get_api_headers(access_token)
        )

        assert response.status_code == 200
        data = response.json()

        assert "time_series" in data
        assert "summary" in data
        assert data["summary"]["date_range"]["days"] == 7

    def test_get_vulnerability_drill_down_success(self, authenticated_api_client):
        """Test getting vulnerability drill-down data."""
        client, access_token = authenticated_api_client

        response = client.get(
            f"/api/v1/vulnerability-scanning/workspaces/{self.team.key}/vulnerability-drill-down?filter_type=severity&filter_value=high&days=7",
            **get_api_headers(access_token)
        )

        assert response.status_code == 200
        data = response.json()

        assert "filter_type" in data
        assert data["filter_type"] == "severity"
        assert "filter_value" in data
        assert data["filter_value"] == "high"
        assert "components" in data
        assert "sboms" in data
        assert "vulnerabilities" in data
        assert "summary" in data

    def test_get_vulnerability_timeseries_with_component_filter(self, authenticated_api_client, sample_component):
        """Test getting vulnerability time series data filtered by component."""
        client, access_token = authenticated_api_client

        response = client.get(
            f"/api/v1/vulnerability-scanning/workspaces/{self.team.key}/vulnerability-timeseries"
            f"?days=30&component_id={sample_component.id}",
            **get_api_headers(access_token)
        )

        assert response.status_code == 200
        data = response.json()

        assert "time_series" in data
        assert "summary" in data
        assert data["summary"]["date_range"]["days"] == 30
