"""Tests for vulnerability scanning models."""

import pytest
from django.core.exceptions import ValidationError
from django.db import IntegrityError

from sbomify.apps.teams.models import Team
from sbomify.apps.billing.models import BillingPlan
from sbomify.apps.core.models import Component
from sbomify.apps.sboms.models import SBOM
from ..models import (
    DependencyTrackServer,
    TeamVulnerabilitySettings,
)


@pytest.mark.django_db
class TestDependencyTrackServer:
    """Test DependencyTrackServer model."""

    def test_create_server(self, db) -> None:
        """Test creating a DT server."""
        server = DependencyTrackServer.objects.create(
            name="Test Server",
            url="https://dt.example.com",
            api_key="test-key-123",
            priority=10,
            max_concurrent_scans=5
        )

        assert server.name == "Test Server"
        assert server.url == "https://dt.example.com"
        assert server.api_key == "test-key-123"
        assert server.is_active is True
        assert server.priority == 10
        assert server.max_concurrent_scans == 5
        assert server.current_scan_count == 0
        assert server.health_status == "unknown"

    def test_server_string_representation(self, db) -> None:
        """Test server string representation."""
        server = DependencyTrackServer.objects.create(
            name="My Server",
            url="https://example.com",
            api_key="key123"
        )
        assert str(server) == f"My Server (ID: {server.id})"

    def test_url_uniqueness(self, db) -> None:
        """Test that server URLs must be unique."""
        DependencyTrackServer.objects.create(
            name="Server 1",
            url="https://dt.example.com",
            api_key="key1"
        )

        with pytest.raises(IntegrityError):
            DependencyTrackServer.objects.create(
                name="Server 2",
                url="https://dt.example.com",  # Same URL
                api_key="key2"
            )

    def test_priority_validation(self, db) -> None:
        """Test priority validation."""
        server = DependencyTrackServer(
            name="Test Server",
            url="https://dt.example.com",
            api_key="test-key",
            priority=0  # Invalid
        )

        with pytest.raises(ValidationError) as exc_info:
            server.full_clean()

        assert "priority" in exc_info.value.message_dict
        assert "Priority must be positive" in str(exc_info.value.message_dict["priority"])

    def test_max_concurrent_scans_validation(self, db) -> None:
        """Test max concurrent scans validation."""
        server = DependencyTrackServer(
            name="Test Server",
            url="https://dt.example.com",
            api_key="test-key",
            max_concurrent_scans=0  # Invalid
        )

        with pytest.raises(ValidationError) as exc_info:
            server.full_clean()

        assert "max_concurrent_scans" in exc_info.value.message_dict

    def test_is_available_for_scan(self, db) -> None:
        """Test server availability checking."""
        server = DependencyTrackServer.objects.create(
            name="Test Server",
            url="https://dt.example.com",
            api_key="test-key",
            max_concurrent_scans=2,
            current_scan_count=1,
            health_status="healthy"
        )

        # Should be available
        assert server.is_available_for_scan is True

        # Make it at capacity
        server.current_scan_count = 2
        server.save()
        assert server.is_available_for_scan is False

        # Make it inactive
        server.current_scan_count = 1
        server.is_active = False
        server.save()
        assert server.is_available_for_scan is False

        # Make it unhealthy
        server.is_active = True
        server.health_status = "unhealthy"
        server.save()
        assert server.is_available_for_scan is False


@pytest.mark.django_db
class TestTeamVulnerabilitySettings:
    """Test TeamVulnerabilitySettings model."""

    def test_create_settings_default(self, team_with_business_plan) -> None:
        """Test creating team settings with defaults."""
        settings = TeamVulnerabilitySettings.objects.create(
            team=team_with_business_plan
        )

        assert settings.vulnerability_provider == "osv"
        assert settings.custom_dt_server is None

    def test_string_representation(self, team_with_business_plan) -> None:
        """Test settings string representation."""
        settings = TeamVulnerabilitySettings.objects.create(
            team=team_with_business_plan,
            vulnerability_provider="dependency_track"
        )

        expected = f"{team_with_business_plan.name} - Dependency Track"
        assert str(settings) == expected

    def test_one_to_one_relationship(self, team_with_business_plan) -> None:
        """Test one-to-one relationship with team."""
        # Create first settings
        TeamVulnerabilitySettings.objects.create(team=team_with_business_plan)

        # Try to create another - should fail
        with pytest.raises(IntegrityError):
            TeamVulnerabilitySettings.objects.create(team=team_with_business_plan)

    def test_dependency_track_requires_business_plan(self, team_with_community_plan) -> None:
        """Test that DT requires Business+ plan."""
        settings = TeamVulnerabilitySettings(
            team=team_with_community_plan,
            vulnerability_provider="dependency_track"
        )

        with pytest.raises(ValidationError) as exc_info:
            settings.full_clean()

        assert "vulnerability_provider" in exc_info.value.message_dict

    def test_custom_server_requires_enterprise_plan(self, team_with_business_plan, dependency_track_server) -> None:
        """Test that custom DT servers require Enterprise plan."""
        settings = TeamVulnerabilitySettings(
            team=team_with_business_plan,  # Business, not Enterprise
            vulnerability_provider="dependency_track",
            custom_dt_server=dependency_track_server
        )

        with pytest.raises(ValidationError) as exc_info:
            settings.full_clean()

        assert "custom_dt_server" in exc_info.value.message_dict

    def test_custom_server_requires_dt_provider(self, team_with_enterprise_plan, dependency_track_server) -> None:
        """Test that custom server requires DT provider."""
        settings = TeamVulnerabilitySettings(
            team=team_with_enterprise_plan,
            vulnerability_provider="osv",  # Not DT
            custom_dt_server=dependency_track_server
        )

        with pytest.raises(ValidationError) as exc_info:
            settings.full_clean()

        assert "custom_dt_server" in exc_info.value.message_dict

    def test_enterprise_with_custom_server_valid(self, team_with_enterprise_plan, dependency_track_server) -> None:
        """Test valid Enterprise config with custom server."""
        settings = TeamVulnerabilitySettings(
            team=team_with_enterprise_plan,
            vulnerability_provider="dependency_track",
            custom_dt_server=dependency_track_server
        )

        settings.full_clean()  # Should not raise
        settings.save()

        assert settings.custom_dt_server == dependency_track_server


# Test fixtures
@pytest.fixture
def team_with_community_plan(db):
    """Create team with community plan."""
    plan = BillingPlan.objects.create(
        key="community",
        name="Community",
        description="Community plan with basic features"
    )
    team = Team.objects.create(name="Community Team", billing_plan=plan.key)
    return team


@pytest.fixture
def team_with_business_plan(db):
    """Create team with business plan."""
    plan = BillingPlan.objects.create(
        key="business",
        name="Business",
        description="Business plan with vulnerability scanning",
        max_users=10
    )
    team = Team.objects.create(name="Business Team", billing_plan=plan.key)
    return team


@pytest.fixture
def team_with_enterprise_plan(db):
    """Create team with enterprise plan."""
    plan = BillingPlan.objects.create(
        key="enterprise",
        name="Enterprise",
        description="Enterprise plan with unlimited features",
        max_users=None  # Unlimited
    )
    team = Team.objects.create(name="Enterprise Team", billing_plan=plan.key)
    return team


@pytest.fixture
def dependency_track_server(db):
    """Create a DT server."""
    return DependencyTrackServer.objects.create(
        name="Test DT Server",
        url="https://dt.example.com",
        api_key="test-key-123"
    )


@pytest.fixture
def component(team_with_business_plan):
    """Create a component."""
    return Component.objects.create(
        name="Test Component",
        team=team_with_business_plan,
        component_type="sbom"
    )


@pytest.fixture
def sbom(component):
    """Create an SBOM."""
    return SBOM.objects.create(
        name="test-sbom.json",
        component=component,
        format="cyclonedx",
        format_version="1.5",
        source="test"
    )


