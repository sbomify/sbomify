import pytest

from sbomify.apps.vulnerability_scanning.services.querysets import apply_latest_sbom_filter


@pytest.mark.django_db
def test_apply_latest_sbom_filter_returns_latest_sbom_only(sample_team):
    from sbomify.apps.sboms.models import Component, SBOM
    from sbomify.apps.vulnerability_scanning.models import VulnerabilityScanResult

    component = Component.objects.create(name="Component A", team=sample_team)
    older_sbom = SBOM.objects.create(name="SBOM Old", component=component)
    newer_sbom = SBOM.objects.create(name="SBOM New", component=component)

    VulnerabilityScanResult.objects.create(
        sbom=older_sbom,
        provider="osv",
        vulnerability_count={"total": 0, "critical": 0, "high": 0, "medium": 0, "low": 0},
        findings=[],
    )
    VulnerabilityScanResult.objects.create(
        sbom=newer_sbom,
        provider="osv",
        vulnerability_count={"total": 1, "critical": 0, "high": 1, "medium": 0, "low": 0},
        findings=[],
    )

    results = apply_latest_sbom_filter(
        VulnerabilityScanResult.objects.filter(sbom__component=component),
        component.id,
    )

    assert list(results.values_list("sbom_id", flat=True)) == [newer_sbom.id]
