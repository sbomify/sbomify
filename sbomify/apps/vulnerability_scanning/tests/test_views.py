"""Tests for vulnerability scanning views."""

from datetime import timedelta
from typing import Any

import pytest
from django.contrib.auth import get_user_model
from django.test import Client
from django.utils import timezone

from sbomify.apps.core.tests.fixtures import sample_user  # noqa: F401
from sbomify.apps.core.tests.shared_fixtures import setup_authenticated_client_session
from sbomify.apps.core.utils import number_to_random_token
from sbomify.apps.plugins.models import AssessmentRun
from sbomify.apps.sboms.models import SBOM, Component, Product, ProductProject, Project, ProjectComponent
from sbomify.apps.teams.fixtures import sample_team  # noqa: F401
from sbomify.apps.teams.models import Member, Team

User = get_user_model()


@pytest.fixture
def team_with_member(sample_team, sample_user) -> tuple[Team, Any]:
    """Create a team with an owner member, ready for authenticated requests."""
    team = sample_team
    if not team.key or len(team.key) < 9:
        team.key = number_to_random_token(team.pk)
        team.save()

    Member.objects.create(user=sample_user, team=team, role="owner", is_default_team=True)

    return team, sample_user


@pytest.fixture
def component_with_sbom(team_with_member) -> tuple[SBOM, Component]:
    """Create a component with an SBOM for assessment run tests."""
    team, _ = team_with_member

    product = Product.objects.create(team=team, name="Test Product")
    project = Project.objects.create(product=product, name="Test Project", team=team)
    ProductProject.objects.create(product=product, project=project)
    component = Component.objects.create(project=project, name="Test Component", team=team)
    ProjectComponent.objects.create(project=project, component=component)

    sbom = SBOM.objects.create(
        name="test-sbom",
        version="1.0.0",
        format="spdx",
        sbom_filename="test-sbom.json",
        component=component,
        source="test",
        format_version="2.3",
    )

    return sbom, component


def _make_assessment_result(critical: int = 0, high: int = 0, medium: int = 0, low: int = 0) -> dict:
    """Build a minimal AssessmentRun result JSON blob."""
    total = critical + high + medium + low
    return {
        "summary": {
            "total_findings": total,
            "by_severity": {
                "critical": critical,
                "high": high,
                "medium": medium,
                "low": low,
            },
        },
    }


@pytest.mark.django_db
class TestVulnerabilityTrendsView:
    """Tests for the VulnerabilityTrendsView."""

    def _get_url(self, **params: str) -> str:
        qs = "&".join(f"{k}={v}" for k, v in params.items())
        return f"/vulnerability-trends/?{qs}" if qs else "/vulnerability-trends/"

    def test_returns_200_with_no_data(self, team_with_member):
        """View returns 200 with empty trends when no assessment runs exist."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url())
        assert response.status_code == 200
        assert response.context["summary"]["total"] == 0
        assert response.context["has_data"] is False

    def test_returns_200_with_assessment_data(self, team_with_member, component_with_sbom):
        """View returns 200 and context contains correct severity aggregation."""
        team, user = team_with_member
        sbom, _ = component_with_sbom

        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=_make_assessment_result(critical=2, high=5),
        )

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url())
        assert response.status_code == 200
        assert response.context["summary"]["critical"] == 2
        assert response.context["summary"]["high"] == 5
        assert response.context["summary"]["total"] == 7
        assert response.context["has_data"] is True

    def test_trends_with_multiple_days_of_data(self, team_with_member, component_with_sbom):
        """Smoke test: view handles multiple assessment runs across different days.

        Note: The actual ASGI cursor fix (transaction.atomic wrapping .iterator())
        cannot be reproduced under the sync test client. This test validates the
        data path works end-to-end with multi-row iteration.
        """
        team, user = team_with_member
        sbom, _ = component_with_sbom

        now = timezone.now()
        for i in range(5):
            run = AssessmentRun.objects.create(
                sbom=sbom,
                plugin_name="grype",
                plugin_version="1.0",
                category="security",
                status="completed",
                result=_make_assessment_result(critical=i, high=i + 1),
            )
            AssessmentRun.objects.filter(pk=run.pk).update(created_at=now - timedelta(days=i))

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(days="7"))
        assert response.status_code == 200
        # Sum of critical: 0+1+2+3+4 = 10, high: 1+2+3+4+5 = 15
        assert response.context["summary"]["critical"] == 10
        assert response.context["summary"]["high"] == 15
        assert response.context["summary"]["total"] == 25

    def test_days_parameter_clamped(self, team_with_member):
        """Days parameter is clamped between 7 and 365."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        # Below minimum — clamped to 7
        response = client.get(self._get_url(days="1"))
        assert response.status_code == 200
        assert response.context["selected_days"] == 7

        # Above maximum — clamped to 365
        response = client.get(self._get_url(days="9999"))
        assert response.status_code == 200
        assert response.context["selected_days"] == 365

        # Invalid value — defaults to 30
        response = client.get(self._get_url(days="abc"))
        assert response.status_code == 200
        assert response.context["selected_days"] == 30

    def test_requires_authentication(self):
        """Unauthenticated requests are redirected to login."""
        client = Client()
        response = client.get("/vulnerability-trends/")
        assert response.status_code == 302

    def test_requires_workspace_session(self, team_with_member):
        """Returns 400 when no workspace is set in the session."""
        _, user = team_with_member
        client = Client()
        client.force_login(user)
        # Clear current_team that middleware auto-populates
        session = client.session
        session.pop("current_team", None)
        session.save()
        response = client.get("/vulnerability-trends/")
        assert response.status_code == 400

    def test_requires_team_membership(self, team_with_member):
        """Returns 403 when user is not a member of the workspace."""
        team, _ = team_with_member

        other_user = User.objects.create_user(username="other", password="testpass123", email="other@test.com")

        client = Client()
        client.force_login(other_user)
        session = client.session
        session["current_team"] = {"key": team.key}
        session.save()

        response = client.get("/vulnerability-trends/")
        assert response.status_code == 403

    def test_show_product_filter(self, team_with_member):
        """show_product_filter=true includes products in context."""
        team, user = team_with_member
        Product.objects.create(team=team, name="Visible Product")

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(show_product_filter="true"))
        assert response.status_code == 200
        assert len(response.context["products"]) >= 1

    def test_multiple_providers_aggregated(self, team_with_member, component_with_sbom):
        """Multiple providers are aggregated correctly in the context."""
        team, user = team_with_member
        sbom, _ = component_with_sbom

        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=_make_assessment_result(critical=1),
        )
        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="trivy",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=_make_assessment_result(high=3),
        )

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url())
        assert response.status_code == 200
        assert response.context["summary"]["critical"] == 1
        assert response.context["summary"]["high"] == 3
        assert response.context["summary"]["total"] == 4
        assert response.context["has_data"] is True
