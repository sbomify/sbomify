"""Tests for VulnerabilityScansView."""

from datetime import timedelta

import pytest
from django.contrib.auth import get_user_model
from django.test import Client
from django.utils import timezone

from sbomify.apps.core.tests.shared_fixtures import setup_authenticated_client_session
from sbomify.apps.plugins.models import AssessmentRun
from sbomify.apps.teams.models import Member

from .conftest import make_assessment_result

User = get_user_model()


@pytest.mark.django_db
class TestVulnerabilityScansView:
    """Tests for the VulnerabilityScansView."""

    @staticmethod
    def _get_url(team_key: str, **params: str) -> str:
        qs = "&".join(f"{k}={v}" for k, v in params.items())
        base = f"/workspaces/{team_key}/vulnerability-scans/"
        return f"{base}?{qs}" if qs else base

    def test_returns_200_with_no_data(self, team_with_member):
        """View returns 200 with zero counts when no scans exist."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key))
        assert response.status_code == 200
        assert response.context["summary"]["total_scans"] == 0
        assert response.context["summary"]["total_vulnerabilities"] == 0

    def test_returns_200_with_scan_data(self, team_with_member, component_with_sbom):
        """View returns 200 with correct severity aggregation."""
        team, user = team_with_member
        sbom, _ = component_with_sbom

        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=make_assessment_result(critical=2, high=5, medium=3, low=1),
        )

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key))
        assert response.status_code == 200
        summary = response.context["summary"]
        assert summary["total_scans"] == 1
        assert summary["total_vulnerabilities"] == 11
        assert summary["critical"] == 2
        assert summary["high"] == 5
        assert summary["medium"] == 3
        assert summary["low"] == 1
        assert summary["critical_high"] == 7
        assert summary["medium_low"] == 4

    def test_days_filter_default_is_30(self, team_with_member):
        """Default days filter is 30 when no parameter is provided."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key))
        assert response.status_code == 200
        assert response.context["selected_days"] == 30

    def test_days_filter_explicit_value(self, team_with_member):
        """Explicit days value is accepted."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key, days="90"))
        assert response.status_code == 200
        assert response.context["selected_days"] == 90

    def test_days_filter_all(self, team_with_member):
        """days=all returns None (no date filter) and shows 'All time' label."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key, days="all"))
        assert response.status_code == 200
        assert response.context["selected_days"] is None
        assert response.context["days_value"] == "all"
        assert response.context["time_range_label"] == "All time"

    def test_days_filter_invalid_defaults_to_30(self, team_with_member):
        """Invalid days value falls back to 30."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key, days="abc"))
        assert response.status_code == 200
        assert response.context["selected_days"] == 30

    def test_days_filter_lower_bound(self, team_with_member):
        """Days below 1 are clamped to 1."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key, days="-5"))
        assert response.status_code == 200
        assert response.context["selected_days"] == 1

    def test_days_filter_excludes_old_scans(self, team_with_member, component_with_sbom):
        """Scans older than the selected days window are excluded from summary."""
        team, user = team_with_member
        sbom, _ = component_with_sbom

        recent = AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=make_assessment_result(critical=1),
        )
        AssessmentRun.objects.filter(pk=recent.pk).update(created_at=timezone.now() - timedelta(days=3))

        old = AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=make_assessment_result(critical=5),
        )
        AssessmentRun.objects.filter(pk=old.pk).update(created_at=timezone.now() - timedelta(days=15))

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key, days="7"))
        assert response.status_code == 200
        assert response.context["summary"]["total_scans"] == 1
        assert response.context["summary"]["critical"] == 1

    def test_requires_authentication(self, team_with_member):
        """Unauthenticated requests are redirected to login."""
        team, _ = team_with_member
        client = Client()
        response = client.get(self._get_url(team.key))
        assert response.status_code == 302

    def test_requires_team_membership(self, team_with_member):
        """Non-members get 403."""
        team, _ = team_with_member

        other_user = User.objects.create_user(username="other", password="testpass123", email="other@test.com")

        client = Client()
        client.force_login(other_user)
        session = client.session
        session["current_team"] = {"key": team.key}
        session.save()

        response = client.get(self._get_url(team.key))
        assert response.status_code == 403

    def test_guest_member_is_redirected(self, team_with_member):
        """Guest members are redirected to the public workspace page."""
        team, _ = team_with_member
        guest = User.objects.create_user(username="guest_user", password="pass", email="guest@test.com")
        Member.objects.create(user=guest, team=team, role="guest")

        client = Client()
        setup_authenticated_client_session(client, team, guest)

        response = client.get(self._get_url(team.key))
        assert response.status_code == 302

    def test_days_filter_empty_string_defaults_to_30(self, team_with_member):
        """Empty string days value falls back to 30."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key, days=""))
        assert response.status_code == 200
        assert response.context["selected_days"] == 30

    def test_invalid_team_key_returns_404(self, team_with_member):
        """Invalid team key returns 404."""
        team, user = team_with_member
        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url("invalid-key"))
        assert response.status_code == 404

    def test_pagination_across_pages(self, team_with_member, component_with_sbom):
        """Pagination splits results across pages (page_size=25)."""
        team, user = team_with_member
        sbom, _ = component_with_sbom

        total_scans = 30
        for i in range(total_scans):
            AssessmentRun.objects.create(
                sbom=sbom,
                plugin_name="grype",
                plugin_version=f"1.{i}",
                category="security",
                status="completed",
                plugin_config_hash="a" * 64,
                run_reason="manual",
                result=make_assessment_result(critical=1),
            )

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key))
        assert response.status_code == 200
        page_obj = response.context["page_obj"]
        assert page_obj.number == 1
        assert page_obj.paginator.count == total_scans
        assert len(page_obj.object_list) == 25

        response_p2 = client.get(self._get_url(team.key, page="2"))
        assert response_p2.status_code == 200
        page_obj_p2 = response_p2.context["page_obj"]
        assert page_obj_p2.number == 2
        assert len(page_obj_p2.object_list) == total_scans - 25

    def test_multiple_scans_aggregated(self, team_with_member, component_with_sbom):
        """Multiple scans are aggregated correctly in summary."""
        team, user = team_with_member
        sbom, _ = component_with_sbom

        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=make_assessment_result(critical=2, high=3),
        )
        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="trivy",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=make_assessment_result(critical=1, medium=4),
        )

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key))
        assert response.status_code == 200
        summary = response.context["summary"]
        assert summary["total_scans"] == 2
        assert summary["critical"] == 3
        assert summary["high"] == 3
        assert summary["medium"] == 4
        assert summary["total_vulnerabilities"] == 10

    def test_non_completed_scans_excluded(self, team_with_member, component_with_sbom):
        """Only completed scans are included."""
        team, user = team_with_member
        sbom, _ = component_with_sbom

        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="completed",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=make_assessment_result(critical=2),
        )
        AssessmentRun.objects.create(
            sbom=sbom,
            plugin_name="grype",
            plugin_version="1.0",
            category="security",
            status="running",
            plugin_config_hash="a" * 64,
            run_reason="manual",
            result=make_assessment_result(critical=99),
        )

        client = Client()
        setup_authenticated_client_session(client, team, user)

        response = client.get(self._get_url(team.key))
        assert response.status_code == 200
        assert response.context["summary"]["total_scans"] == 1
        assert response.context["summary"]["critical"] == 2
