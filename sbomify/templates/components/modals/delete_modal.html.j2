{% load widget_tweaks %}
{# Alpine.js + Tailwind Delete Confirmation Modal Component #}
<div id="{{ modal_id }}"
     x-data="{ open: false, displayName: '', formData: {}, init() { // Listen for modal open event with data this.$watch('open', (value) => { if (!value) { // Reset on close this.displayName = ''; this.formData = {}; } }); }, openModal(event) { this.open = true; // Extract data from event detail if (event.detail) { this.displayName = event.detail.displayName || ''; this.formData = event.detail.formData || {}; } }, close() { this.open = false; } }"
     @open-
     {{ modal_id }}
     .window="openModal($event)"
     @keydown.escape.window="if(open) open = false">
    <div x-show="open"
         x-cloak
         class="fixed inset-0 z-[1055] overflow-y-auto"
         role="alertdialog"
         aria-modal="true"
         aria-labelledby="{{ modal_id }}-label">
        {# Backdrop #}
        <div x-show="open"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black/60 backdrop-blur-sm"
             @click="close()"></div>
        {# Modal Content #}
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 @click.stop
                 x-trap.noscroll="open"
                 class="relative w-full max-w-md bg-surface border border-border rounded-xl shadow-2xl">
                {# Header with warning icon #}
                <div class="flex flex-col items-center px-6 pt-6 pb-4">
                    <div class="w-12 h-12 rounded-full bg-danger/10 flex items-center justify-center mb-4">
                        <i class="fas fa-exclamation-triangle text-danger text-xl"></i>
                    </div>
                    <h3 id="{{ modal_id }}-label"
                        class="text-lg font-semibold text-text text-center">{{ modal_title }}</h3>
                    <button type="button"
                            @click="close()"
                            class="absolute top-4 right-4 p-2 rounded-lg text-text-muted hover:text-text hover:bg-border/50 transition-colors"
                            aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                {# Body #}
                <div class="px-6 pb-6">
                    <p class="text-sm text-text text-center mb-2">
                        {{ message_text }} <span class="font-semibold text-text" x-text="displayName"></span>?
                    </p>
                    <p class="text-xs text-text-muted text-center">
                        {{ warning_text|default:"This action cannot be undone and will permanently remove the item from the system." }}
                    </p>
                </div>
                {# Footer #}
                <div class="flex justify-end gap-3 px-6 pb-6 pt-4 border-t border-border">
                    <button type="button" class="tw-btn-secondary" @click="close()">Cancel</button>
                    <form id="{{ modal_id }}-form"
                          class="inline"
                          {% if use_htmx %} hx-post="{{ form_action }}" {% if hx_target %}hx-target="{{ hx_target }}"{% endif %}
                          {% if hx_swap %}hx-swap="{{ hx_swap }}"{% else %}hx-swap="none"{% endif %}
                          @htmx:after-request="if($event.detail.successful) close()"
                          {% else %}
                          method="post"
                          action="{{ form_action }}"
                          {% endif %}>
                        {% csrf_token %}
                        <input type="hidden" name="_method" value="DELETE">
                        {% for field in form %}{{ field }}{% endfor %}
                        {% if additional_fields %}{{ additional_fields|safe }}{% endif %}
                        {# Dynamically populated form fields #}
                        <template x-for="(value, key) in formData" :key="key">
                            <input type="hidden" :name="key" :value="value">
                        </template>
                        <button type="submit" class="tw-btn-danger">
                            <i class="fas fa-trash mr-2"></i>
                            {{ submit_text }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (function() {
        const modal = document.getElementById('{{ modal_id }}');
        // Move modal to body if not already there
        if (modal && modal.parentElement !== document.body) {
            document.body.appendChild(modal);
            {% if use_htmx %}
            if (typeof htmx !== 'undefined') {
                htmx.process(modal);
            }
            {% endif %}
        }
    })();
</script>
